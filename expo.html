<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Emoji Collector â€¢ Isometric â€¢ v2</title>
  <style>
    :root{
      --bg: hsl(220 20% 8%);
      --panel: hsl(220 18% 14%);
      --panel-2: hsl(220 18% 18%);
      --ink: hsl(220 15% 92%);
      --accent: hsl(170 90% 45%);
      --accent-2: hsl(34 95% 55%);
      --tile: hsl(221 20% 22%);
      --tile-edge: hsl(221 25% 17%);
      --radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom,0px);
      --safe-top: env(safe-area-inset-top,0px);
      --size: 9; /* N x N */
      --tile-size: 42; /* logical px before scale */
      --iso-x: 45deg;
      --iso-y: 50deg; /* tighter grid than v1 */
      --edge: 4px; /* side face thickness */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      overflow:hidden; -webkit-tap-highlight-color:transparent; touch-action:none;
    }

    /* Lightweight background (no heavy filters) */
    .scene{position:fixed;inset:0; pointer-events:none;
      background:
        radial-gradient(80vmax 60vmax at 80% -10%, hsl(200 40% 20% / .12), transparent 60%),
        radial-gradient(60vmax 40vmax at 10% 110%, hsl(280 40% 25% / .14), transparent 55%),
        linear-gradient(180deg, hsl(210 40% 10%), hsl(230 30% 8%));}

    /* HUD */
    .hud{position:fixed; inset:0 0 auto 0; padding:calc(8px + var(--safe-top)) 12px 8px; display:grid; grid-template-columns:1fr auto; align-items:center; gap:8px; z-index:10}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid hsl(0 0% 100% / .06); box-shadow: 0 6px 20px hsl(0 0% 0% / .30);}
    .btn{min-width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid hsl(0 0% 100% / .06); box-shadow:0 6px 20px hsl(0 0% 0% / .30); user-select:none}
    .controls{display:inline-flex; gap:8px}

    /* Board fit area */
    .wrap{position:fixed; inset:64px 0 calc(90px + var(--safe-bottom)) 0; display:grid; place-items:center}
    .board{position:relative; transform-style:preserve-3d; will-change:transform;}

    /* Tiles */
    .tile{position:absolute; width:calc(var(--tile-size) * 1px); height:calc(var(--tile-size) * 1px); transform-style:preserve-3d}
    .tile .top{position:absolute; inset:0; border-radius:8px; background:linear-gradient(180deg, hsl(220 15% 28%), var(--tile)); box-shadow: inset 0 1px 0 hsl(0 0% 100% / .04); transform: translateZ(var(--edge))}
    .tile .left,.tile .right{position:absolute; background:var(--tile-edge)}
    .tile .left{width:100%; height:var(--edge); bottom:0; transform-origin:bottom; transform:rotateX(90deg)}
    .tile .right{height:100%; width:var(--edge); right:0; transform-origin:right; transform:rotateY(90deg)}

    /* Pieces */
    .piece{position:absolute; width:calc(var(--tile-size) * .9px); height:calc(var(--tile-size) * .9px); display:grid; place-items:center; font-size:calc(var(--tile-size) * .7px); translate:-50% -50%; transform:translate3d(0,0,0); filter: drop-shadow(0 6px 10px hsl(0 0% 0% / .35)); will-change:transform,opacity; transition:transform .18s ease, opacity .18s ease}
    .wobble{animation:wob .18s ease-in-out alternate infinite}
    @keyframes wob{from{transform:translate3d(0,0,8px) rotateZ(-1deg)} to{transform:translate3d(0,0,10px) rotateZ(1deg)}}

    /* Feedback */
    .pop{position:absolute; translate:-50% -50%; font-weight:800; font-size:18px; color:var(--accent); text-shadow:0 2px 10px hsl(170 90% 45% / .5); animation:pop .5s ease forwards; pointer-events:none}
    @keyframes pop{from{opacity:0; transform:translateY(0) scale(.8)}50%{opacity:1}to{opacity:0; transform:translateY(-26px) scale(1.05)}}
    .particle{position:absolute; width:5px; height:5px; border-radius:50%; background:currentColor; pointer-events:none}

    /* Bottom dock */
    .dock{position:fixed; left:0; right:0; bottom:0; padding:10px 12px calc(10px + var(--safe-bottom)); display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2)); border:1px solid hsl(0 0% 100% / .06); border-radius:var(--radius); box-shadow:0 6px 20px hsl(0 0% 0% / .30); padding:10px}
    .progress{height:10px; border-radius:999px; background:hsl(0 0% 100% / .06); overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); border-radius:inherit; box-shadow:0 6px 16px hsl(170 90% 45% / .4); transition:width .15s ease}

    /* Motion guard */
    @media (prefers-reduced-motion: reduce){*{animation:none !important; transition:none !important}}
  </style>
</head>
<body>
  <div class="scene" aria-hidden="true"></div>

  <div class="hud">
    <div class="pill"><span>Score</span><span id="score" style="font-weight:700">0</span></div>
    <div class="controls">
      <button class="btn" id="soundBtn" aria-label="Sound">ðŸ”Š</button>
      <button class="btn" id="vibeBtn" aria-label="Vibration">ðŸ“³</button>
    </div>
  </div>

  <div class="wrap">
    <div class="board" id="board" role="application" aria-label="Isometric board"></div>
  </div>

  <div class="dock">
    <div class="card" style="display:grid; gap:8px">
      <div style="display:flex; justify-content:space-between; align-items:center"><span>Combo</span><span id="timer">60</span></div>
      <div class="progress"><div class="bar" id="comboBar"></div></div>
    </div>
    <button class="btn" id="shuffleBtn" aria-label="Shuffle">ðŸ”€</button>
  </div>

<script>
(() => {
  // Sizing and scale-to-fit to avoid zoom-out and spread
  const r = getComputedStyle(document.documentElement);
  const SIZE = parseInt(r.getPropertyValue('--size')) || 9;
  const TILE = parseFloat(r.getPropertyValue('--tile-size')) || 42; // logical tile
  const EDGE = parseFloat(r.getPropertyValue('--edge')) || 4;
  const ISO_X = r.getPropertyValue('--iso-x');
  const ISO_Y = r.getPropertyValue('--iso-y');

  const board = document.getElementById('board');
  const scoreEl = document.getElementById('score');
  const comboBar = document.getElementById('comboBar');
  const timerEl = document.getElementById('timer');
  const soundBtn = document.getElementById('soundBtn');
  const vibeBtn = document.getElementById('vibeBtn');

  let score = parseInt(localStorage.getItem('iso-emoji-score') || '0', 10);
  scoreEl.textContent = score;
  let timeLeft = 60;
  let allowSound = true;
  let allowVibe = true;

  // Build grid once
  const gridW = SIZE * TILE;
  const gridH = SIZE * TILE;
  board.style.width = gridW + 'px';
  board.style.height = gridH + 'px';

  for (let y = 0; y < SIZE; y++) {
    for (let x = 0; x < SIZE; x++) {
      const t = document.createElement('div');
      t.className = 'tile';
      t.style.left = (x * TILE) + 'px';
      t.style.top  = (y * TILE) + 'px';
      t.style.zIndex = x + y;
      t.innerHTML = `<div class="top"></div><div class="left" style="height:${EDGE}"></div><div class="right" style="width:${EDGE}"></div>`;
      board.appendChild(t);
    }
  }

  // Fit board to the available viewport area by scaling the whole layer
  const wrap = document.querySelector('.wrap');
  function fit(){
    const rect = wrap.getBoundingClientRect();
    const sx = rect.width  / gridW;
    const sy = rect.height / gridH;
    const scale = Math.floor(Math.min(sx, sy) * 100) / 100; // snap to reduce relayout churn
    board.style.transform = `rotateX(${ISO_Y}) rotateZ(${ISO_X}) scale(${scale}) translateZ(0)`;
  }
  window.addEventListener('resize', fit, {passive:true});
  fit();

  // Emoji pieces
  const EMOJIS = ['ðŸ€','ðŸ“','ðŸ‹','ðŸ‡','ðŸ©','â­','ðŸ’Ž','ðŸ§','ðŸ­','ðŸ¥','ðŸ‰','ðŸŽˆ'];
  const pieces = new Set();

  function spawnPiece(){
    const el = document.createElement('div');
    el.className = 'piece wobble';
    el.textContent = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    const x = Math.floor(Math.random()*SIZE) + 0.5;
    const y = Math.floor(Math.random()*SIZE) + 0.5;
    positionPiece(el,x,y,true);
    el.style.opacity = 0; el.style.transform = 'translate3d(0,0,20px) scale(.7)';
    board.appendChild(el); pieces.add(el);
    requestAnimationFrame(()=>{ el.style.opacity = 1; el.style.transform = 'translate3d(0,0,10px) scale(1)'; });
    return el;
  }

  function positionPiece(el,gx,gy,clamp=false){
    const x = clamp ? Math.max(.5, Math.min(gx, SIZE-.5)) : gx;
    const y = clamp ? Math.max(.5, Math.min(gy, SIZE-.5)) : gy;
    el.dataset.gx = x; el.dataset.gy = y;
    el.style.left = (x * TILE) + 'px';
    el.style.top  = (y * TILE) + 'px';
    el.style.zIndex = Math.floor(x + y) + 1;
  }

  for(let i=0;i<10;i++) spawnPiece(); // fewer for smoother start

  // Input
  board.addEventListener('pointerdown', onTap, {passive:true});
  function onTap(e){
    const target = e.target.closest('.piece');
    if(target) collect(target);
  }

  // Shuffle
  document.getElementById('shuffleBtn').addEventListener('click', () => {
    for (const p of pieces){
      const nx = Math.floor(Math.random()*SIZE)+0.5;
      const ny = Math.floor(Math.random()*SIZE)+0.5;
      positionPiece(p,nx,ny,true);
    }
    blip(300,0.06,'sine'); vibrate(8);
  }, {passive:true});

  // Minimal WebAudio blip
  const audioCtx = window.AudioContext ? new AudioContext() : null;
  function blip(freq=880, dur=0.07, type='triangle'){
    if(!allowSound || !audioCtx) return;
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = 0.0001;
    o.connect(g).connect(audioCtx.destination);
    const t = audioCtx.currentTime; o.start(t);
    g.gain.exponentialRampToValueAtTime(0.06, t+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
    o.stop(t+dur);
  }
  function vibrate(ms=10){ if(allowVibe && navigator.vibrate) navigator.vibrate(ms); }

  // Toggles
  soundBtn.addEventListener('click', ()=>{ allowSound=!allowSound; soundBtn.textContent = allowSound ? 'ðŸ”Š' : 'ðŸ”‡'; blip(200,0.05) });
  vibeBtn.addEventListener('click', ()=>{ allowVibe=!allowVibe; vibeBtn.textContent = allowVibe ? 'ðŸ“³' : 'ðŸ“´'; vibrate(8) });

  // Scoring and effects
  let combo = 0, comboIdle = 0;
  function collect(el){
    const x = parseFloat(el.dataset.gx), y = parseFloat(el.dataset.gy);
    const bonus = 1 + Math.floor(combo/20);
    score += bonus; scoreEl.textContent = score; localStorage.setItem('iso-emoji-score', String(score));
    combo = Math.min(100, combo + 12); comboIdle = 0; comboBar.style.width = combo + '%';
    blip(660 + combo*2, 0.05, 'triangle'); vibrate(12);
    popText('+'+bonus, x, y);
    burst(x, y, el.style.color || `hsl(${Math.floor(Math.random()*360)} 90% 60%)`);
    // recycle
    el.classList.remove('wobble'); el.style.transform = 'translate3d(0,0,28px) scale(.7)'; el.style.opacity = 0;
    setTimeout(()=>{ if(el.isConnected) el.remove(); pieces.delete(el); spawnPiece(); }, 140);
  }

  function popText(text,gx,gy){
    const el = document.createElement('div'); el.className = 'pop'; el.textContent = text;
    el.style.left = (gx*TILE) + 'px'; el.style.top = (gy*TILE) + 'px'; board.appendChild(el);
    setTimeout(()=> el.remove(), 520);
  }

  function burst(gx,gy,color){
    const n = 8; // lighter particles
    for(let i=0;i<n;i++){
      const p = document.createElement('div'); p.className = 'particle'; p.style.color = color;
      p.style.left = (gx*TILE)+'px'; p.style.top = (gy*TILE)+'px'; board.appendChild(p);
      const a = Math.random()*Math.PI*2; const d = 16 + Math.random()*18;
      const tx = Math.cos(a)*d, ty = Math.sin(a)*d;
      p.animate([{transform:`translate(${tx}px,${ty}px)`, opacity:1},{transform:`translate(${tx*1.2}px,${ty*1.2}px)`, opacity:0}],{duration:280+Math.random()*160, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards'});
      setTimeout(()=>p.remove(), 460);
    }
  }

  // Lightweight game loop: timer and combo decay only
  let last = performance.now();
  function loop(now){
    const dt = Math.min(100, now - last); last = now;
    timeLeft = Math.max(0, timeLeft - dt/1000); timerEl.textContent = Math.ceil(timeLeft);
    comboIdle += dt; if(comboIdle > 800){ combo = Math.max(0, combo - dt*0.02); comboBar.style.width = combo + '%'; }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
