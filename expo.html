<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Slot Game â€” Polished</title>

  <!-- ADDED: Google Fonts for game-like feel -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <!-- ADDED: Separate style block for animations to keep things clean -->
  <style>
    /* --- ANIMATIONS --- */
    @keyframes animated-gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes pulse-button {
      0% {
        transform: scale(1);
        box-shadow: 0 6px 18px var(--shadow-pulse-1), 0 0 10px var(--shadow-pulse-2-inset) inset;
        filter: brightness(1);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 10px 24px var(--shadow-pulse-1), 0 0 20px var(--shadow-pulse-2-inset) inset;
        filter: brightness(1.2);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 6px 18px var(--shadow-pulse-1), 0 0 10px var(--shadow-pulse-2-inset) inset;
        filter: brightness(1);
      }
    }

    @keyframes pulse-track {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes modal-pop-in {
      0% { transform: scale(0.7) translate(-50%, -50%); opacity: 0; }
      100% { transform: scale(1) translate(-50%, -50%); opacity: 1; }
    }

    /* ADDED: Feedback animation for floating text */
    @keyframes float-up {
      0% {
        transform: translateY(0) scale(0.8);
        opacity: 1;
      }
      100% {
        transform: translateY(-60px) scale(1.2);
        opacity: 0;
      }
    }

    /* ADDED: Feedback animation for value updates */
    @keyframes flash-green {
      0% { transform: scale(1); }
      50% {
        transform: scale(1.15);
        color: oklch(90% .25 150);
        text-shadow: 0 0 12px oklch(90% .25 150 / 0.8);
      }
      100% { transform: scale(1); }
    }
    @keyframes flash-credit {
      0% { transform: scale(1); }
      50% {
        transform: scale(1.15);
        color: oklch(90% .2 315);
        text-shadow: 0 0 12px oklch(90% .2 315 / 0.8);
      }
      100% { transform: scale(1); }
    }
    @keyframes flash-red {
      0% { color: inherit; }
      50% {
        color: oklch(75% .25 25);
        transform: scale(1.05);
      }
      100% { color: inherit; }
    }

    /* ADDED: Reel spinning animation */
    @keyframes reel-blur-spin {
      from { transform: translateY(0); }
      to { transform: translateY(-100%); }
    }

  </style>

  <style>
    :root{
      /* UPDATED: Added fonts */
      --font-header: 'Orbitron', sans-serif;
      --font-body: 'Share Tech Mono', monospace;

      /* TWEAKED: Slightly more vibrant base colors */
      --bg:#020305;
      --panel:#0d1218;
      --panel-2:#0a0f14;
      --text:#fff;
      --muted:#9eb0c3;
      --track:#1b2532;
      --track-h:12px;
      --thumb-size: 28px; /* UPDATED: Larger thumb */
      --brd:#2e4053;
      --brd-strong:#49627f;
      --brd-width:2px;
      --shadow-1:0 2px 6px rgba(0,0,0,.45);
      --shadow-2:0 18px 36px rgba(0,0,0,.55);
      
      /* TWEAKED: More vibrant, lighter colors for pop */
      --money-bg: oklch(26% .09 150); --money-brd: oklch(42% .11 150);
      --credit-bg: oklch(28% .11 315); --credit-brd: oklch(46% .13 315);
      --rate1-bg: oklch(30% .11 250); --rate1-accent: oklch(84% .2 28);
      --rate2-bg: oklch(30% .11 210); --rate2-accent: oklch(88% .16 170);

      --money-text: oklch(94% .18 100);
      --credit-text: oklch(92% .12 345);

      /* ADDED: Glow and button colors */
      --glow-accent: oklch(80% .2 200 / 0.7);
      --glow-accent-strong: oklch(85% .22 200);
      --spin-bg: var(--money-bg);
      --spin-border: var(--money-brd);
      --spin-shadow: rgba(16, 160, 100, .45);
      --spin-shadow-inset: oklch(80% .2 150 / 0.3);
      --buy-bg: var(--credit-bg);
      --buy-border: var(--credit-brd);
      --buy-shadow: rgba(160, 53, 140, .45);
      --buy-shadow-inset: oklch(80% .2 315 / 0.3);

      --tap:48px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    
    body{
      margin:0;
      /* UPDATED: Font */
      font-family: var(--font-body);
      color:var(--text);
      /* UPDATED: Animated gradient background */
      background: linear-gradient(220deg, oklch(8% .01 250), oklch(5% 0 0), oklch(8% .01 320));
      background-size: 300% 300%;
      animation: animated-gradient 18s ease infinite;
      display:grid;
      place-items:center;
      overflow-x: hidden; /* Hide horizontal scroll */
    }
    .wrap{width:min(920px,94vw)}
    .card{
      /* UPDATED: Translucent background with border image */
      background: oklch(10% .01 260 / 0.75);
      backdrop-filter: blur(12px);
      border: var(--brd-width) solid transparent;
      border-image: linear-gradient(145deg, var(--brd-strong), var(--brd)) 1;
      border-radius:18px;
      padding:20px clamp(14px,4vw,28px);
      box-shadow:var(--shadow-2), 0 0 40px oklch(10% .01 260 / 0.5);
      position:relative;
      overflow:clip;
      outline:1px solid rgba(255,255,255,.06);
    }

    #gameTimer{
      text-align:center;
      /* UPDATED: Font, size, glow */
      font-size: 20px;
      font-family: var(--font-body);
      letter-spacing: 2px;
      margin-bottom:16px;
      opacity:.95;
      background: var(--panel-2);
      border: var(--brd-width) solid var(--brd);
      padding: 10px 16px;
      border-radius: 12px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      box-shadow: var(--shadow-1), 0 0 10px var(--glow-accent) inset;
      text-shadow: 0 0 5px var(--glow-accent);
    }

    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px clamp(12px,3vw,24px);margin-bottom:18px}
    .stat{
      background:var(--panel-2);
      border:var(--brd-width) solid var(--brd);
      border-radius:14px;
      padding:14px 16px;
      box-shadow:var(--shadow-1), 0 1px 0 rgba(255,255,255,.06) inset;
      position: relative; /* For floating text */
    }
    .label{
      font-size:13px; /* UPDATED: slightly larger */
      color:var(--muted);
      letter-spacing:.25px;
      /* UPDATED: Font */
      font-family: var(--font-header);
      font-weight: 700;
      text-transform: uppercase;
    }
    .value{
      font-size:clamp(20px,5vw,30px);
      /* UPDATED: Font */
      font-family: var(--font-header);
      font-weight:900;
      line-height:1.1;
      margin-top:8px;
      /* ADDED: Transition for flash animation */
      transition: transform 0.1s ease, color 0.2s ease, text-shadow 0.2s ease;
    }
    .growth{margin-top:6px;font-size:12px;color:var(--muted)}

    .stat.money{background:var(--money-bg);border-color:var(--money-brd)}
    .stat.money .label {color:var(--text);text-shadow:0 1px 0 rgba(0,0,0,.45)}
    .stat.money .value {
      color:var(--money-text);
      /* ADDED: Glow */
      text-shadow: 0 0 10px oklch(from var(--money-text) l c h / 0.7);
    }

    .stat.credit{background:var(--credit-bg);border-color:var(--credit-brd)}
    .stat.credit .label {color:var(--text);text-shadow:0 1px 0 rgba(0,0,0,.35)}
    .stat.credit .value {
      color:var(--credit-text);
      /* ADDED: Glow */
      text-shadow: 0 0 10px oklch(from var(--credit-text) l c h / 0.7);
    }

    .stat.rate1{background:var(--rate1-bg);border-color:color-mix(in oklab,var(--rate1-bg),white 18%)}
    .stat.rate1 .value{color:var(--rate1-accent); text-shadow: 0 0 8px oklch(from var(--rate1-accent) l c h / 0.6);}
    .stat.rate1 .label, .stat.rate1 .growth{color:color-mix(in oklab, var(--rate1-accent), white 30%)}

    .stat.rate2{background:var(--rate2-bg);border-color:color-mix(in oklab,var(--rate2-bg),white 18%)}
    .stat.rate2 .value{color:var(--rate2-accent); text-shadow: 0 0 8px oklch(from var(--rate2-accent) l c h / 0.6);}
    .stat.rate2 .label, .stat.rate2 .growth{color:color-mix(in oklab, var(--rate2-accent), white 30%)}

    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#223042;color:#ecf3fb;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06); vertical-align: middle;}
    .per-second {
      font-size: 12px;
      font-weight: 600;
      vertical-align: baseline;
      margin-left: 4px;
      font-family: var(--font-body); /* UPDATED: Font */
      opacity: 0.8;
    }

    .badge.badge-rate1 { background-color: var(--rate1-bg); color: var(--rate1-accent); border: 1px solid oklch(from var(--rate1-accent) l c h / 0.5); box-shadow: none; }
    .badge.badge-rate2 { background-color: var(--rate2-bg); color: var(--rate2-accent); border: 1px solid oklch(from var(--rate2-accent) l c h / 0.5); box-shadow: none; }
    .badge.badge-money { background-color: var(--money-bg); color: var(--money-text); border: 1px solid oklch(from var(--money-brd) l c h / 0.5); text-shadow: 0 1px 0 rgba(0,0,0,.45); box-shadow: none; }
    .badge.badge-credit { background-color: var(--credit-bg); color: var(--credit-text); border: 1px solid oklch(from var(--credit-brd) l c h / 0.5); text-shadow: 0 1px 0 rgba(0,0,0,.35); box-shadow: none; }

    .slider-wrap{margin-top:6px;display:flex;justify-content:center}
    .slider{position:relative;height:64px;user-select:none;width:min(420px,88%);margin:0 auto;padding:0 16px}
    .track{
      position:absolute;
      left:16px;
      right:16px;
      top:50%;
      transform:translateY(-50%);
      height:var(--track-h);
      border-radius:999px;
      /* UPDATED: Animated gradient track */
      background: linear-gradient(90deg, var(--rate1-bg), var(--rate2-bg), var(--rate1-bg));
      background-size: 200% 100%;
      animation: pulse-track 4s ease infinite;
      outline: 1px solid var(--brd-strong);
      box-shadow:inset 0 1px 2px rgba(0,0,0,.4);
    }

    .ticks{position:absolute;left:16px;right:16px;font-size:12px;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.45);}
    .ticks-top{top: 2px; color: var(--rate2-accent); text-shadow: 0 0 5px oklch(from var(--rate2-accent) l c h / 0.6);}
    .ticks-bottom{top: 47px; color: var(--rate1-accent); text-shadow: 0 0 5px oklch(from var(--rate1-accent) l c h / 0.6);}

    .thumb{
      position:absolute;
      top:50%;
      transform:translate(-50%,-50%);
      /* UPDATED: Larger, glowing, circular thumb */
      width: var(--thumb-size);
      height: var(--thumb-size);
      border-radius: 50%;
      cursor:grab;
      background: radial-gradient(circle, #fff, #c5d2df);
      border: 3px solid var(--glow-accent-strong);
      box-shadow: 0 0 8px var(--glow-accent), 0 0 16px var(--glow-accent), 0 2px 4px rgba(0,0,0,.35);
      transition: transform 0.1s ease-out;
    }
    .thumb:active {
      transform: translate(-50%, -50%) scale(1.15);
      cursor: grabbing;
    }

    .controls{margin-top:14px;display:flex;gap:10px}
    button.ctrl{
      background:#0b1117;
      color:var(--text);
      border:var(--brd-width) solid #2a3a4d;
      border-radius:12px;
      padding:10px 12px;
      /* UPDATED: Font */
      font-family: var(--font-header);
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      box-shadow:var(--shadow-1);
      min-height:var(--tap);
      /* ADDED: Transitions for juice */
      transition: all 0.15s ease-out;
    }
    /* ADDED: Button juice */
    button.ctrl:not(:disabled):hover {
      transform: scale(1.03);
      filter: brightness(1.2);
      border-color: var(--brd-strong);
    }
    button.ctrl:not(:disabled):active {
      transform: scale(0.97);
      filter: brightness(0.9);
      transition-duration: 0.05s;
    }
    button.ctrl:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      /* ADDED: Filter for disabled state */
      filter: grayscale(80%) brightness(0.7);
    }

    .ctrl-fixed{width:96px;padding:10px 12px;font-size:13px}

    #swapBtn {
      background: linear-gradient(90deg, var(--credit-bg) 0%, var(--credit-bg) 50%, var(--money-bg) 50%, var(--money-bg) 100%);
      border-color: var(--brd-strong);
      transition: background 0.2s, opacity 0.2s, transform 0.15s ease-out, filter 0.15s ease-out;
    }
    #swapBtn:disabled {
      background: var(--panel); /* Dull background */
      border-color: var(--brd);
      filter: grayscale(80%) brightness(0.7);
    }

    /* UPDATED: Spin/Buy button styling */
    button.ctrl-buy, #spin.ctrl {
      font-family: var(--font-header);
      padding: 14px 20px;
      font-size: 17px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      /* ADDED: Pulse animation */
      --shadow-pulse-1: transparent;
      --shadow-pulse-2-inset: transparent;
      animation: pulse-button 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    
    button.ctrl-buy{
      background: var(--buy-bg);
      border-color: var(--buy-border);
      color:var(--text);
      text-shadow: 0 1px 2px rgba(0,0,0,.5);
      --shadow-pulse-1: var(--buy-shadow);
      --shadow-pulse-2-inset: var(--buy-shadow-inset);
    }
    #spin.ctrl{
      background: var(--spin-bg);
      border-color: var(--spin-border);
      color:var(--text);
      text-shadow: 0 1px 2px rgba(0,0,0,.5);
      --shadow-pulse-1: var(--spin-shadow);
      --shadow-pulse-2-inset: var(--spin-shadow-inset);
    }

    .slot{margin-top:20px;padding-top:16px;border-top:var(--brd-width) solid var(--brd)}
    .slot h2{
      margin:0 0 10px 0;
      font-size:clamp(16px,2.6vw,22px);
      /* UPDATED: Font */
      font-family: var(--font-header);
      font-weight:900;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0}
    
    /* --- REEL STYLING (THE BIG CHANGE) --- */
    .reel{
      /* UPDATED: Taller, acts as a mask */
      background: linear-gradient(180deg, #000 0%, var(--panel-2) 15%, var(--panel-2) 85%, #000 100%);
      border:var(--brd-width) solid var(--brd);
      border-radius:10px;
      height: 120px; /* This is the symbol height */
      box-shadow:var(--shadow-1),inset 0 2px 4px rgba(0,0,0,.5), inset 0 0 10px rgba(0,0,0,.5);
      /* ADDED: Masking */
      overflow: hidden;
      position: relative;
    }

    /* ADDED: The strip that moves */
    .reel-strip {
      position: absolute;
      top: 0; left: 0; right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      /* This transition is for the FINAL snap */
      transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }

    /* ADDED: Class for when it's blur-spinning */
    .reel-strip.spinning {
      /* Uses a linear, fast animation for the blur */
      animation: reel-blur-spin 0.08s linear infinite;
      transition: none; /* No transition while spinning */
    }

    /* ADDED: Individual symbols in the strip */
    .reel-symbol {
      width: 100%;
      height: 120px; /* Must match reel height */
      display: grid;
      place-items: center;
      font-size: clamp(60px, 10vw, 80px); /* Bigger symbols */
      /* ADDED: Glowing symbols */
      text-shadow: 0 0 10px oklch(80% .15 80), 0 0 20px oklch(80% .15 80 / 0.7);
      flex-shrink: 0; /* Prevent shrinking */
    }
    /* --- END REEL STYLING --- */


    .slot-actions {display:grid;grid-template-columns: 1fr 1fr;gap: 20px;margin-top: 16px;}
    .action {display: flex;flex-direction: column;}
    .action .ctrl {width: 100%;}
    .cost, .buy-cost-text {
      font-size: 11px;
      color: var(--text);
      text-align: center;
      margin-top: 8px;
      line-height: 1.4;
      /* ADDED: Transition for flash-red */
      transition: color 0.15s ease, transform 0.15s ease;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
      backdrop-filter:blur(4px);
    }
    .modal{
      /* UPDATED: Pop-in animation, new position */
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background:#0f141a;
      border:var(--brd-width) solid #2a3a4d;
      border-radius:14px;
      width:min(420px,92vw);
      padding:18px;
      box-shadow:0 14px 36px rgba(0,0,0,.55);
      /* ADDED: Animation */
      animation: modal-pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    .modal h3{
      margin:0 0 8px 0;
      font-size:18px;
      /* UPDATED: Font */
      font-family: var(--font-header);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .modal p{margin:0 0 12px 0;color:var(--muted);font-size:14px}
    .modal .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    
    .btn{
      appearance:none;
      border:2px solid transparent;
      border-radius:12px;
      padding:14px 16px;
      /* UPDATED: Font */
      font-family: var(--font-header);
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      min-height:48px;
      /* ADDED: Transition */
      transition: all 0.15s ease-out;
    }
    /* ADDED: Button juice */
    .btn:hover {
      transform: scale(1.03);
      filter: brightness(1.2);
    }
    .btn:active {
      transform: scale(0.97);
      filter: brightness(0.9);
      transition-duration: 0.05s;
    }

    .btn.primary{background:oklch(48% .13 160);border-color:oklch(62% .14 160);color:#fff}
    .btn.secondary{background:#0b1117;border-color:#2a3a4d;color:#e9f1fa}

    /* ADDED: Class for floating text */
    .floating-text {
      position: absolute;
      font-size: 20px;
      font-family: var(--font-header);
      font-weight: 900;
      pointer-events: none;
      animation: float-up 1.2s ease-out forwards;
      z-index: 1000;
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    }
    /* ADDED: Classes for flash feedback */
    .flash-update { animation: flash-green 0.4s ease-out; }
    .flash-update-credit { animation: flash-credit 0.4s ease-out; }
    .flash-red { animation: flash-red 0.4s ease-out; }


    @media (max-width:640px){
      .wrap{width:100vw}
      .card{border-radius:0;padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right)) max(12px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left))}
      .value{font-size:clamp(20px, 6.5vw, 28px); margin-top: 6px;}
      .slot-actions{grid-template-columns:1fr;gap:8px; margin-top: 12px;}
      .controls{gap:8px; margin-top: 10px;}
      
      /* UPDATED: Taller reels on mobile to match new symbol size */
      .reel{height:120px;}
      .reel-symbol { height: 120px; font-size: clamp(60px, 15vw, 80px); }

      .modal{width:min(500px,96vw)}
      .modal .actions{grid-template-columns:1fr}
      .btn{font-size:18px;padding:16px 18px;min-height:56px}

      #gameTimer { margin-bottom: 10px; font-size: 16px; padding: 8px 12px; }
      .stats-grid { gap: 10px; margin-bottom: 12px; }
      .stat { padding: 12px 14px; }
      .slider-wrap { margin-top: 4px; }
      .slot { margin-top: 12px; padding-top: 10px; }
      .slot h2 { margin-bottom: 8px; }
      .reels { gap: 8px; margin: 8px 0; }
      .cost, .buy-cost-text { margin-top: 6px; }

      /* ADDED: Smaller floating text on mobile */
      .floating-text { font-size: 16px; }
    }
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important;transition:none!important}
      /* Keep minimal transitions for interaction */
      button.ctrl, .btn, .thumb { transition: transform 0.1s ease, opacity 0.1s ease; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="gameTimer">15:00:00</div>

      <div class="stats-grid">
        <div class="stat money"><div class="label">Money</div><div class="value" id="val1">$0.00</div></div>
        <div class="stat credit"><div class="label">Credit</div><div class="value" id="val2">0.00</div></div>
        <div class="stat rate1"><div class="label">Rate 1</div><div class="value"><span id="rate1">3.00</span> <span class="per-second">per second</span></div><div class="growth">Growth: <span id="grow1">2</span>/m</div></div>
        <div class="stat rate2"><div class="label">Rate 2</div><div class="value"><span id="rate2">3.00</span> <span class="per-second">per second</span></div><div class="growth">Growth: <span id="grow2">12</span>/m</div></div>
      </div>

      <div class="slider-wrap">
        <div class="slider" id="uniSlider" role="group" aria-label="Growth slider">
          <div class="track"></div>
          <div class="thumb" id="thumb" role="slider" aria-valuemin="2" aria-valuemax="12" aria-valuenow="2" aria-valuetext="2" tabindex="0"></div>
          <div class="ticks ticks-top" id="ticksTop"></div>
          <div class="ticks ticks-bottom" id="ticksBottom"></div>
        </div>
      </div>

      <div class="controls">
        <button class="ctrl ctrl-fixed" id="swapBtn">Swap</button>
        <button class="ctrl ctrl-fixed" id="pause">Pause</button>
      </div>

      <section class="slot" aria-label="3-reel slot machine">
        <h2>3â€‘Reel Slot</h2>
        <div class="reels">
          <!-- UPDATED: Reels are now masks for the spinning strips -->
          <div class="reel" id="reel1-mask">
            <div class="reel-strip" id="reel1">
              <!-- Symbols will be built by JS -->
            </div>
          </div>
          <div class="reel" id="reel2-mask">
            <div class="reel-strip" id="reel2">
              <!-- Symbols will be built by JS -->
            </div>
          </div>
          <div class="reel" id="reel3-mask">
            <div class="reel-strip" id="reel3">
              <!-- Symbols will be built by JS -->
            </div>
          </div>
        </div>
        <div class="slot-actions">
          <div class="action">
            <button class="ctrl" id="spin">Spin</button>
            <span class="cost" id="spinCostMsg" aria-live="polite">$50 + 1.0 Rate Point</span>
          </div>
          <div class="action">
            <button class="ctrl ctrl-buy" id="buyBtn">Buy</button>
            <span class="buy-cost-text" id="buyCostMsg" aria-live="polite">Get 6x ðŸ’Ž (wild) 500c + 1.0 Rate 2 Point</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="winModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="winTitle" aria-describedby="winDesc">
      <h3 id="winTitle">3â€‘ofâ€‘aâ€‘kind!</h3>
      <p id="winDesc">Choose your reward to continue.</p>
      <div class="actions">
        <button class="btn secondary" id="reduceBtn">Lower spin cost by 0.1 Rate Point</button>
        <button class="btn secondary" id="reduceRate2Btn" style="display: none;">Lower Buy cost by 1.0 Rate 2 Point</button>
        <button class="btn primary" id="takeMoneyBtn">Take $600</button>
      </div>
    </div>
  </div>

  <script>
    // Constants
    const MAX_RATE = 199;
    const SPIN_DOLLAR_COST = 50;
    const BUY_DIAMOND_COST = 500;
    const BUY_DIAMOND_RATE_COST = 1.0;
    const GAME_DURATION_SECONDS = 15 * 60;
    const GROW_STEPS = [2,4,6,8,10,12];
    const STEP_COUNT = GROW_STEPS.length;
    
    // ADDED: Constant for reel styling
    const SYMBOL_HEIGHT = 120; // Must match CSS .reel-symbol height
    const ALL_SYMBOLS = ['ðŸ’','ðŸ‹','ðŸ‡','ðŸ‰','ðŸŠ','ðŸ’Ž'];
    const BASE_SYMBOLS = ['ðŸ’','ðŸ‹','ðŸ‡','ðŸ‰','ðŸŠ'];

    // State
    let value1 = 0, value2 = 0, rate1 = 3, rate2 = 3, gameTimeSeconds = GAME_DURATION_SECONDS;
    let grow1 = GROW_STEPS[0];
    let grow2 = 14 - grow1;

    // ADDED: State for value-change feedback
    let previousValue1 = 0, previousValue2 = 0;

    let spinDollarCost = SPIN_DOLLAR_COST;
    let spinRateCost = 1.0;
    let winMoneyReward = 600;

    let buyDiamondCost = BUY_DIAMOND_COST;
    let buyDiamondRateCost = BUY_DIAMOND_RATE_COST;

    let symbols=[...BASE_SYMBOLS];
    let diamondCount=0;
    let running=true, modalOpen=false;

    // Elements
    const gameTimerEl=document.getElementById('gameTimer');
    const val1El=document.getElementById('val1');
    const val2El=document.getElementById('val2');
    const rate1El=document.getElementById('rate1');
    const rate2El=document.getElementById('rate2');
    const grow1El=document.getElementById('grow1');
    const grow2El=document.getElementById('grow2');

    const slider=document.getElementById('uniSlider');
    const thumb=document.getElementById('thumb');
    const ticksTopEl = document.getElementById('ticksTop');
    const ticksBottomEl=document.getElementById('ticksBottom');

    const swapBtn = document.getElementById('swapBtn');
    const pauseBtn=document.getElementById('pause');
    const spinBtn=document.getElementById('spin');
    const spinCostMsg=document.getElementById('spinCostMsg');
    const buyBtn=document.getElementById('buyBtn');
    const buyCostMsg=document.getElementById('buyCostMsg');

    const backdrop=document.getElementById('winModalBackdrop');
    const modal = backdrop.querySelector('.modal'); // ADDED: Get modal for animation
    const takeMoneyBtn=document.getElementById('takeMoneyBtn');
    const reduceBtn=document.getElementById('reduceBtn');
    const reduceRate2Btn=document.getElementById('reduceRate2Btn');

    // UPDATED: Get reel *strips*
    const reelEls=[document.getElementById('reel1'),document.getElementById('reel2'),document.getElementById('reel3')];

    // Utils
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const fmt=(n)=>n.toFixed(2);
    const fmtRatePts=(x)=>x.toFixed(1);
    const fmtTime=(t)=>{const s=Math.floor(t),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return [h,m,sec].map(v=>String(v).padStart(2,'0')).join(':')};

    // --- ADDED: Feedback Helper Functions ---
    /**
     * Creates a floating text element for feedback
     * @param {string} text - The text to display (e.g., "+$1.23")
     * @param {string} color - A CSS color string
     * @param {HTMLElement} element - The element to float from
     */
    function showFloatingText(text, color, element) {
      if (!element) return;
      try {
        const el = document.createElement('span');
        el.className = 'floating-text';
        el.textContent = text;
        el.style.color = color;

        const rect = element.getBoundingClientRect();
        const cardRect = element.closest('.card').getBoundingClientRect();
        
        // Position relative to the card, not the viewport
        el.style.left = `${rect.left - cardRect.left + (rect.width / 2) - 10}px`;
        el.style.top = `${rect.top - cardRect.top}px`;

        element.closest('.card').appendChild(el);
        
        // Remove after animation
        setTimeout(() => {
          el.remove();
        }, 1200);
      } catch (e) {
        console.error("Failed to show floating text:", e);
      }
    }

    /**
     * Applies a flash animation class to an element
     * @param {HTMLElement} el - The element to flash
     * @param {string} flashClass - The CSS class to add
     */
    function flashElement(el, flashClass) {
      if (!el) return;
      el.classList.add(flashClass);
      el.addEventListener('animationend', () => {
        el.classList.remove(flashClass);
      }, { once: true });
    }
    // --- END Feedback Helpers ---


    function updateCostMsg(){
      spinCostMsg.innerHTML = `<span class="badge badge-money">$${spinDollarCost}</span> + ${fmtRatePts(spinRateCost)} <span class="badge badge-rate1">Rate 1</span>`;
    }
    function updateBuyBtnUI(){
      if(diamondCount>0){ buyCostMsg.textContent=`ðŸ’Ž Active (${diamondCount} left)`; buyBtn.disabled=true; }
      else{
        buyCostMsg.innerHTML=`Get 6x ðŸ’Ž (wild) <span class="badge badge-credit">${buyDiamondCost}c</span> + ${buyDiamondRateCost.toFixed(1)} <span class="badge badge-rate2">Rate 2</span>`;
        buyBtn.disabled=false;
      }
    }
    function updateReadout(){
      if (gameTimeSeconds > 0 || running) {
        gameTimerEl.textContent = fmtTime(gameTimeSeconds);
      }

      // ADDED: Check for changes and show feedback
      const diff1 = value1 - previousValue1;
      if (diff1 > 0.01) { // Check against a small epsilon
        flashElement(val1El, 'flash-update');
        // Show floating text only for larger, noticeable gains
        if (diff1 > 0.5) {
          showFloatingText(`+$${fmt(diff1)}`, 'var(--money-text)', val1El);
        }
      }
      
      const diff2 = value2 - previousValue2;
      if (diff2 > 0.01) {
        flashElement(val2El, 'flash-update-credit');
        if (diff2 > 0.5) {
          showFloatingText(`+${fmt(diff2)}c`, 'var(--credit-text)', val2El);
        }
      }
      
      val1El.textContent=`$${fmt(value1)}`;
      val2El.textContent=fmt(value2);
      rate1El.textContent=fmt(rate1);
      rate2El.textContent=fmt(rate2);
      grow1El.textContent=grow1;
      grow2El.textContent=grow2;

      // ADDED: Update previous values *after* using them
      previousValue1 = value1;
      previousValue2 = value2;
    }

    // --- REEL BUILDER ---
    /**
     * ADDED: Populates the reel strips with symbols for animation
     */
    function buildReels() {
      // Create a long, shuffled strip for visual variety
      let visualSymbols = [];
      for (let i = 0; i < 5; i++) {
        visualSymbols.push(...ALL_SYMBOLS.sort(() => 0.5 - Math.random()));
      }
      // Ensure the first symbols match the base list for easy indexing
      visualSymbols = [...ALL_SYMBOLS, ...visualSymbols];

      reelEls.forEach((reelStrip) => {
        reelStrip.innerHTML = ''; // Clear existing
        visualSymbols.forEach(symbol => {
          const symEl = document.createElement('div');
          symEl.className = 'reel-symbol';
          symEl.textContent = symbol;
          reelStrip.appendChild(symEl);
        });
        // Add first few symbols again at the end to create a seamless loop
        for(let i = 0; i < 5; i++) {
          const symEl = document.createElement('div');
          symEl.className = 'reel-symbol';
          symEl.textContent = visualSymbols[i];
          reelStrip.appendChild(symEl);
        }
      });
    }
    // --- END REEL BUILDER ---


    // Slider helpers (unchanged)
    function buildTicks(){
      ticksBottomEl.innerHTML='';
      ticksTopEl.innerHTML = '';
      const growStepsDesc = [...GROW_STEPS].reverse();
      const createTicks = (parentElement, steps) => {
        steps.forEach((value, idx) => {
          const s = document.createElement('span');
          s.textContent = value;
          s.style.position = 'absolute';
          const pct = (STEP_COUNT <= 1) ? 0 : (idx / (STEP_COUNT - 1));
          s.style.left = `${pct * 100}%`;
          if (idx === 0) s.style.transform = 'translateX(0)';
          else if (idx === STEP_COUNT - 1) s.style.transform = 'translateX(-100%)';
          else s.style.transform = 'translateX(-50%)';
          parentElement.appendChild(s);
        });
      };
      createTicks(ticksBottomEl, GROW_STEPS);
      createTicks(ticksTopEl, growStepsDesc);
    }
    function sliderInnerRect(){
      const r=slider.getBoundingClientRect();
      const left=r.left+16, right=r.right-16, width=Math.max(0,right-left);
      return {left,right,width};
    }
    function positionHandleByIndex(idx){
      const {left,width}=sliderInnerRect();
      const pct = (STEP_COUNT<=1)?0: idx/(STEP_COUNT-1);
      const x = left + pct*width;
      thumb.style.left = `${x - slider.getBoundingClientRect().left}px`;
      const val = GROW_STEPS[idx];
      thumb.setAttribute('aria-valuenow', String(val));
      thumb.setAttribute('aria-valuetext', String(val));
    }
    function nearestIndexFromClientX(xc){
      const {left,width}=sliderInnerRect();
      const x = clamp(xc-left,0,width);
      const pct = width===0?0:x/width;
      return clamp(Math.round(pct*(STEP_COUNT-1)),0,STEP_COUNT-1);
    }
    function setGrowthByIndex(idx){
      const v = GROW_STEPS[idx];
      grow1=v; grow2=14 - v;
      positionHandleByIndex(idx);
      grow1El.textContent=grow1; grow2El.textContent=grow2;
    }
    function currentIndex(){ return Math.max(0, GROW_STEPS.indexOf(grow1)); }
    function makeSliderInteractive(){
      buildTicks();
      setGrowthByIndex(0);
      let dragging=false;
      const onDown=(ev)=>{ dragging=true; thumb.focus(); const c=('touches'in ev)?ev.touches[0].clientX:ev.clientX; setGrowthByIndex(nearestIndexFromClientX(c)); ev.preventDefault(); };
      const onMove=(ev)=>{ if(!dragging) return; const c=('touches'in ev)?ev.touches[0].clientX:ev.clientX; setGrowthByIndex(nearestIndexFromClientX(c)); };
      const onUp=()=>{ dragging=false; };
      thumb.addEventListener('mousedown', onDown);
      thumb.addEventListener('touchstart', onDown, {passive:false});
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
      slider.addEventListener('mousedown', (ev)=>{ if(ev.target===thumb) return; const c=ev.clientX; setGrowthByIndex(nearestIndexFromClientX(c)); });
      slider.addEventListener('touchstart', (ev)=>{ if(ev.target===thumb) return; const c=ev.touches[0].clientX; setGrowthByIndex(nearestIndexFromClientX(c)); }, {passive:false});
      thumb.addEventListener('keydown',(e)=>{
        let idx=currentIndex();
        if(e.key==='ArrowLeft'){ idx=clamp(idx-1,0,STEP_COUNT-1); setGrowthByIndex(idx); e.preventDefault(); }
        if(e.key==='ArrowRight'){ idx=clamp(idx+1,0,STEP_COUNT-1); setGrowthByIndex(idx); e.preventDefault(); }
        if(e.key==='Home'){ setGrowthByIndex(0); e.preventDefault(); }
        if(e.key==='End'){ setGrowthByIndex(STEP_COUNT-1); e.preventDefault(); }
      });
      const ro=new ResizeObserver(()=> positionHandleByIndex(currentIndex()));
      ro.observe(slider);
    }

    // Modal helpers
    function openWinChoice(){
      return new Promise((resolve)=>{
        modalOpen=true;
        takeMoneyBtn.textContent=`Take $${winMoneyReward}`;

        let focusables;
        if (spinRateCost <= 0) {
          reduceBtn.style.display = 'none';
          reduceRate2Btn.style.display = 'block';
          focusables = [reduceRate2Btn, takeMoneyBtn];
        } else {
          reduceBtn.style.display = 'block';
          reduceRate2Btn.style.display = 'none';
          focusables = [reduceBtn, takeMoneyBtn];
        }

        backdrop.style.display='flex';
        backdrop.setAttribute('aria-hidden','false');
        // ADDED: Trigger pop-in animation
        modal.style.animation = 'none'; // Reset animation
        requestAnimationFrame(() => { // Run in next frame
          modal.style.animation = 'modal-pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
        });

        let idx=0; focusables[idx].focus();
        function onKey(e){ if(e.key==='Tab'){ e.preventDefault(); idx=(idx+(e.shiftKey?-1:1)+focusables.length)%focusables.length; focusables[idx].focus(); } if(e.key==='Escape'){ e.preventDefault(); } }
        document.addEventListener('keydown', onKey);

        function cleanup(){
          document.removeEventListener('keydown', onKey);
          backdrop.style.display='none';
          backdrop.setAttribute('aria-hidden','true');
          modal.style.animation = 'none'; // Clear animation for next time
          modalOpen=false;
          reduceBtn.style.display = 'block';
          reduceRate2Btn.style.display = 'none';
        }

        reduceBtn.onclick=()=>{ cleanup(); resolve('reduce'); };
        reduceRate2Btn.onclick=()=>{ cleanup(); resolve('reduceRate2'); };
        takeMoneyBtn.onclick=()=>{ cleanup(); resolve('money'); };
      });
    }

    // Slot logic
    // This is the *logic* function for getting a symbol. Unchanged.
    function randomSymbol(){ let s=symbols[Math.floor(Math.random()*symbols.length)]; if(s==='ðŸ’Ž'){ if(diamondCount>0){ diamondCount--; updateBuyBtnUI(); if(diamondCount===0) symbols=symbols.filter(x=>x!=='ðŸ’Ž'); return 'ðŸ’Ž'; } else { return BASE_SYMBOLS[Math.floor(Math.random()*BASE_SYMBOLS.length)]; } } return s; }

    // --- UPDATED: spinOnce() function for new animation ---
    async function spinOnce(){
      if(!spinBtn || spinBtn.disabled || modalOpen) return;
      if(value1 < spinDollarCost || rate1 < spinRateCost){
        spinBtn.animate([{transform:'scale(1.05) translateX(0)'},{transform:'scale(1.05) translateX(-4px)'},{transform:'scale(1.05) translateX(4px)'},{transform:'scale(1.05) translateX(0)'}],{duration:180});
        // ADDED: Flash cost red
        flashElement(spinCostMsg, 'flash-red');
        return;
      }
      value1 -= spinDollarCost;
      rate1 = Math.max(0, rate1 - spinRateCost);
      spinDollarCost += 1;
      updateCostMsg();
      updateReadout();
      spinBtn.disabled=true;
      
      const durations=[900,1100,1300];
      const finalSyms=new Array(3);

      // Create an array of Promises, one for each reel
      const spinPromises = reelEls.map((reelStrip, i) => {
        return new Promise((resolve) => {
          // 1. Add 'spinning' class to apply the blur animation
          reelStrip.classList.add('spinning');
          // Set a random start position for the blur
          const randomY = -Math.floor(Math.random() * 10) * SYMBOL_HEIGHT;
          reelStrip.style.transform = `translateY(${randomY}px)`;

          // 2. Set a timeout for when this reel should stop
          setTimeout(() => {
            // 3. Get the final *logical* symbol
            finalSyms[i] = randomSymbol();
            
            // 4. Find the *visual* index of this symbol in our strip
            // We'll land on the 2nd instance of it (index 0-5 are first set)
            let targetIndex = ALL_SYMBOLS.indexOf(finalSyms[i]);
            if (targetIndex === -1) targetIndex = 0; // Fallback
            
            // Land on the 2nd, 3rd, or 4th instance for variety
            const randomSet = Math.floor(Math.random() * 3) + 2;
            const finalIndex = targetIndex + (randomSet * ALL_SYMBOLS.length);
            
            // 5. Calculate the final Y position
            const finalY = -finalIndex * SYMBOL_HEIGHT;

            // 6. Remove 'spinning' class and set final transform.
            // The CSS transition will handle the "snap"
            reelStrip.classList.remove('spinning');
            reelStrip.style.transform = `translateY(${finalY}px)`;
            
            resolve();
          }, durations[i]);
        });
      });

      // 7. Wait for all reel animations to complete
      await Promise.all(spinPromises);
      
      // 8. Win logic (unchanged)
      const nonWild=finalSyms.filter(s=>s!=='ðŸ’Ž');
      let win=false;
      if(nonWild.length<=1) win=true;
      else if(nonWild.length===2) win=(nonWild[0]===nonWild[1]);
      else win=(finalSyms[0]===finalSyms[1] && finalSyms[1]===finalSyms[2]);

      if(win){
        const choice=await openWinChoice();
        const rewardThisWin=winMoneyReward;

        if(choice==='money'){
          value1 += rewardThisWin;
          // ADDED: Feedback for win money
          showFloatingText(`+$${rewardThisWin}`, 'var(--money-text)', val1El);
        } else if (choice === 'reduce') {
          spinRateCost = Math.max(0, +(spinRateCost - 0.1).toFixed(1));
          updateCostMsg();
        } else if (choice === 'reduceRate2') {
          buyDiamondRateCost = Math.max(0, buyDiamondRateCost - 1.0);
          updateBuyBtnUI();
        }
        winMoneyReward = rewardThisWin + 600;
      }
      spinBtn.disabled=false;
      updateReadout();
    }
    // --- END spinOnce() Update ---


    // Controls
    function attachControls(){
      swapBtn.addEventListener('click', ()=>{
        [value1, value2] = [value2, value1];
        // ADDED: Feedback for swap
        flashElement(val1El, 'flash-update-credit');
        flashElement(val2El, 'flash-update');
        swapBtn.disabled = true;
        updateReadout();
      });
      pauseBtn.addEventListener('click', ()=>{ running=!running; pauseBtn.textContent= running? 'Pause':'Resume'; });
      buyBtn.addEventListener('click', ()=>{
        if(value2>=buyDiamondCost && rate2>=buyDiamondRateCost && diamondCount===0){ 
          value2-=buyDiamondCost; 
          rate2=Math.max(0, rate2-buyDiamondRateCost); 
          diamondCount=6; 
          if(!symbols.includes('ðŸ’Ž')) symbols.push('ðŸ’Ž'); 
          buyDiamondCost+=500; 
          buyDiamondRateCost+=1; 
          updateBuyBtnUI(); 
          updateReadout(); 
        }
        else{ 
          if(value2<buyDiamondCost || rate2<buyDiamondRateCost){ 
            buyBtn.animate([{transform:'scale(1.05) translateX(0)'},{transform:'scale(1.05) translateX(-4px)'},{transform:'scale(1.05) translateX(4px)'},{transform:'scale(1.05) translateX(0)'}],{duration:180});
            // ADDED: Flash cost red
            flashElement(buyCostMsg, 'flash-red');
          } 
        }
      });
      spinBtn.addEventListener('click', spinOnce);
      spinBtn.addEventListener('keydown',(e)=>{ if(modalOpen){ e.preventDefault(); return; } if(e.key===' '||e.key==='Enter'){ e.preventDefault(); spinOnce(); } });
    }

    // Loop (unchanged logic)
    let lastTs; function tick(ts){
      if(lastTs===undefined) lastTs=ts;
      const dt=(ts-lastTs)/1000;
      lastTs=ts;

      if(running && dt>0){
        gameTimeSeconds -= dt;

        value1 += rate1 * dt;
        value2 += rate2 * dt;
        const gps1=(grow1/60), gps2=(grow2/60);
        rate1=Math.min(MAX_RATE, rate1 + gps1*dt);
        rate2=Math.min(MAX_RATE, rate2 + gps2*dt);

        if (gameTimeSeconds <= 0) {
          gameTimeSeconds = 0;
          running = false;
          pauseBtn.disabled = true;
          spinBtn.disabled = true;
          buyBtn.disabled = true;
          if (swapBtn) swapBtn.disabled = true;
          pauseBtn.textContent = "Over";
        }
      }

      // UpdateReadout now handles its own feedback
      updateReadout(); 

      if (gameTimeSeconds > 0 || (gameTimeSeconds <= 0 && running)) {
        requestAnimationFrame(tick);
      } else if (gameTimeSeconds <= 0 && !running) {
        gameTimerEl.textContent = "GAME OVER";
        gameTimerEl.style.color = "oklch(75% .25 25)";
        gameTimerEl.style.textShadow = "0 0 8px oklch(75% .25 25 / 0.8)";
      }
    }

    function init(){ 
      makeSliderInteractive(); 
      buildReels(); // ADDED: Build reels on init
      updateCostMsg(); 
      updateBuyBtnUI(); 
      attachControls(); 
      // ADDED: Fun little startup message
      setTimeout(() => {
        showFloatingText("Game On!", "var(--glow-accent-strong)", gameTimerEl);
      }, 500);
      requestAnimationFrame(tick); 
    }
    init();
  </script>
</body>
</html>
