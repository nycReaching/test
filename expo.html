<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Slot Game ‚Äî Polished</title>
  <style>
    :root{
      --bg:#07090d;--panel:#0d1218;--panel-2:#0a0f14;--text:#fff;--muted:#9eb0c3;--track:#1b2532;--track-h:12px;--thumb-size:22px;--brd:#2e4053;--brd-strong:#49627f;--brd-width:2px;--shadow-1:0 2px 6px rgba(0,0,0,.45);--shadow-2:0 18px 36px rgba(0,0,0,.55);--glow:0 0 0 2px rgba(255,255,255,.06);

      /* --- Theme Colors --- */
      --money-bg: oklch(22% .08 150); --money-brd: oklch(38% .10 150);
      --credit-bg: oklch(24% .10 315); --credit-brd: oklch(42% .12 315);
      --rate1-bg: oklch(26% .10 250); --rate1-accent: oklch(82% .18 28);
      --rate2-bg: oklch(26% .10 210); --rate2-accent: oklch(86% .14 170);
      --money-text: oklch(92% .15 100);
      --credit-text: oklch(90% .1 345);

      /* --- NEW: Glow & Feedback Colors --- */
      --glow-money: oklch(85% .2 150 / 0.7);
      --glow-credit: oklch(85% .2 315 / 0.7);
      --glow-rate1: oklch(85% .2 250 / 0.7);
      --glow-rate2: oklch(85% .2 210 / 0.7);
      --glow-white: rgba(255, 255, 255, 0.7);

      /* --- NEW: Transitions --- */
      --transition-fast: 150ms ease-out;
      --transition-med: 300ms ease-out;

      --tap:48px;
    }

    /* --- NEW: Keyframe Animations --- */
    @keyframes backgroundPulse {
      0% { background-position: 70% -20%; }
      50% { background-position: 60% -10%; }
      100% { background-position: 70% -20%; }
    }
    @keyframes pulseGlowRate1 {
      0%, 100% { box-shadow: var(--shadow-1), 0 0 8px -2px var(--glow-rate1); }
      50% { box-shadow: var(--shadow-1), 0 0 14px 0px var(--glow-rate1); }
    }
    @keyframes pulseGlowRate2 {
      0%, 100% { box-shadow: var(--shadow-1), 0 0 8px -2px var(--glow-rate2); }
      50% { box-shadow: var(--shadow-1), 0 0 14px 0px var(--glow-rate2); }
    }
    @keyframes shimmerTrack {
      0% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    /* Settle animation for reels */
    @keyframes reelSettle {
      0% { transform: scale(0.8) rotateX(-90deg); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1) rotateX(0); opacity: 1; }
    }
    /* Flash animation for value changes */
    @keyframes flashMoney {
      50% { transform: scale(1.05); color: var(--money-text); text-shadow: 0 0 8px var(--glow-money); }
    }
    @keyframes flashCredit {
      50% { transform: scale(1.05); color: var(--credit-text); text-shadow: 0 0 8px var(--glow-credit); }
    }

    /* --- NEW: Value Flash Classes --- */
    .value-flash-money {
      animation: flashMoney 300ms ease-out;
    }
    .value-flash-credit {
      animation: flashCredit 300ms ease-out;
    }


    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
      color:var(--text);
      /* Updated background with animation */
      background: radial-gradient(1200px 800px at 70% -20%,#17202b 0%,var(--bg) 55%);
      animation: backgroundPulse 8s infinite ease-in-out;
      display:grid;
      place-items:center;
      perspective: 1000px; /* For subtle 3D hover */
    }
    .wrap{
      width:min(920px,94vw);
    }
    .card{
      background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
      border:var(--brd-width) solid var(--brd-strong);
      border-radius:18px;
      padding:20px clamp(14px,4vw,28px);
      box-shadow:var(--shadow-2), inset 0 1px 0 rgba(255,255,255,.06); /* Added inner highlight */
      position:relative;
      overflow:clip;
      outline:1px solid rgba(255,255,255,.06);
      transform: translateZ(0); /* Stacking context */
      transition: transform 400ms ease; /* Subtle hover effect */
    }
    /* NEW: Subtle 3D tilt on hover for desktop */
    @media (min-width: 641px) {
      .card:hover {
        transform: rotateY(-1deg) rotateX(1deg) scale(1.01);
      }
    }


    #gameTimer{
      text-align:center;
      font-size:16px;
      margin-bottom:16px;
      font-family:'Courier New',monospace;
      letter-spacing:1.5px;
      opacity:.95;
      background: var(--panel-2);
      border: var(--brd-width) solid var(--brd);
      padding: 8px 14px;
      border-radius: 12px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      box-shadow: var(--shadow-1);
    }

    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px clamp(12px,3vw,24px);margin-bottom:18px}
    .stat{
      background:#0b1117;
      border:var(--brd-width) solid var(--brd);
      border-radius:14px;
      padding:14px 16px;
      box-shadow:var(--shadow-1);
      /* NEW: Transition for hover */
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    /* NEW: Hover effect for stats */
    .stat:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: var(--shadow-1), 0 4px 12px rgba(0,0,0,.3);
    }

    .label{font-size:12px;color:var(--muted);letter-spacing:.25px}
    .value{font-size:clamp(20px,5vw,30px);font-weight:800;line-height:1.1;margin-top:8px}
    .growth{margin-top:6px;font-size:12px;color:var(--muted)}

    .stat.money{background:var(--money-bg);border-color:var(--money-brd)}
    .stat.money .label {color:var(--text);text-shadow:0 1px 0 rgba(0,0,0,.45)}
    .stat.money .value {color:var(--money-text);text-shadow:0 1px 0 rgba(0,0,0,.45)}

    .stat.credit{background:var(--credit-bg);border-color:var(--credit-brd)}
    .stat.credit .label {color:var(--text);text-shadow:0 1px 0 rgba(0,0,0,.35)}
    .stat.credit .value {color:var(--credit-text);text-shadow:0 1px 0 rgba(0,0,0,.35)}

    .stat.rate1{
      background:var(--rate1-bg);
      border-color:color-mix(in oklab,var(--rate1-bg),white 18%);
      /* NEW: Pulsing glow animation */
      animation: pulseGlowRate1 2.5s infinite ease-in-out;
    }
    .stat.rate1 .label,.stat.rate1 .value,.stat.rate1 .growth{color:var(--rate1-accent)}
    
    .stat.rate2{
      background:var(--rate2-bg);
      border-color:color-mix(in oklab,var(--rate2-bg),white 18%);
      /* NEW: Pulsing glow animation */
      animation: pulseGlowRate2 2.8s infinite ease-in-out;
    }
    .stat.rate2 .label,.stat.rate2 .value,.stat.rate2 .growth{color:var(--rate2-accent)}

    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;background:#223042;color:#ecf3fb;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06); vertical-align: middle;}
    .badge.badge-rate1 {background-color: var(--rate1-bg);color: var(--rate1-accent);border: 1px solid oklch(from var(--rate1-accent) l c h / 0.5);box-shadow: none;}
    .badge.badge-rate2 {background-color: var(--rate2-bg);color: var(--rate2-accent);border: 1px solid oklch(from var(--rate2-accent) l c h / 0.5);box-shadow: none;}
    .badge.badge-money {background-color: var(--money-bg);color: var(--money-text);border: 1px solid oklch(from var(--money-brd) l c h / 0.5);text-shadow: 0 1px 0 rgba(0,0,0,.45);box-shadow: none;}
    .badge.badge-credit {background-color: var(--credit-bg);color: var(--credit-text);border: 1px solid oklch(from var(--credit-brd) l c h / 0.5);text-shadow: 0 1px 0 rgba(0,0,0,.35);box-shadow: none;}

    .slider-wrap{margin-top:6px;display:flex;justify-content:center}
    .slider{position:relative;height:64px;user-select:none;width:min(420px,88%);margin:0 auto;padding:0 16px}
    .track{
      position:absolute;left:16px;right:16px;top:50%;transform:translateY(-50%);height:var(--track-h);border-radius:999px;background:linear-gradient(90deg,#1a2330,#213041 60%,#1a2330);outline:1px solid #2a3a4d;box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
      /* NEW: Shimmer animation */
      background-size: 300% 100%;
      animation: shimmerTrack 4s linear infinite;
    }

    .ticks{position:absolute;left:16px;right:16px;font-size:12px;font-weight:900;text-shadow:0 1px 0 rgba(0,0,0,.45);}
    .ticks-top{top: 5px; color: var(--rate2-accent);}
    .ticks-bottom{top: 47px; color: var(--rate1-accent);}

    .thumb{
      position:absolute;top:50%;transform:translate(-50%,-50%);width:var(--thumb-size);height:var(--thumb-size);border-radius:6px;cursor:grab;box-shadow:0 2px 0 rgba(0,0,0,.35),inset 0 0 0 1px rgba(255,255,255,.12),var(--glow);background:linear-gradient(180deg,#c5d2df 0%,#9fb0c3 100%);
      /* NEW: Transitions for smooth movement and interaction */
      transition: left var(--transition-fast), transform var(--transition-fast), background var(--transition-med);
    }
    /* NEW: Thumb interaction states */
    .thumb:hover {
      transform: translate(-50%, -50%) scale(1.15);
    }
    .thumb:active {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.1);
      background: linear-gradient(180deg, #fff, #b9c8da);
    }

    .controls{margin-top:14px;display:flex;gap:10px}
    button.ctrl{
      background:#0b1117;color:var(--text);border:var(--brd-width) solid #2a3a4d;border-radius:12px;padding:10px 12px;font-weight:800;font-size:14px;cursor:pointer;box-shadow:var(--shadow-1);min-height:var(--tap);
      /* NEW: Transitions for juicy feedback */
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-med), border-color var(--transition-med);
    }
    /* NEW: Button interaction states */
    button.ctrl:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-1), 0 4px 8px rgba(0,0,0,.2);
      border-color: var(--brd-strong);
    }
    button.ctrl:active {
      transform: translateY(0) scale(0.97);
      box-shadow: var(--shadow-1);
    }
    button.ctrl:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--panel);
      border-color: var(--brd);
      transform: none; /* Reset transforms */
      box-shadow: var(--shadow-1); /* Reset shadow */
    }

    .ctrl-fixed{width:96px;padding:10px 12px;font-size:13px}

    #swapBtn {background: linear-gradient(90deg, var(--credit-bg) 0%, var(--credit-bg) 50%, var(--money-bg) 50%, var(--money-bg) 100%);border-color: var(--brd-strong);}
    #swapBtn:disabled {background: var(--panel);border-color: var(--brd);}
    #pause:hover { border-color: var(--muted); }

    button.ctrl-buy{background:var(--credit-bg);border-color:var(--credit-brd);color:var(--text);padding:14px 20px;font-size:17px;font-weight:900;box-shadow:0 6px 18px rgba(106,53,96,.45)}
    #spin.ctrl{background:var(--money-bg);border-color:var(--money-brd);color:var(--text);padding:14px 20px;font-size:17px;font-weight:900;box-shadow:0 6px 18px rgba(16,60,44,.45)}
    /* NEW: Specific hover glows for main buttons */
    #spin.ctrl:not(:disabled):hover { box-shadow: 0 0 12px 0px var(--glow-money), 0 6px 18px rgba(16,60,44,.45); border-color: var(--money-brd); }
    button.ctrl-buy:not(:disabled):hover { box-shadow: 0 0 12px 0px var(--glow-credit), 0 6px 18px rgba(106,53,96,.45); border-color: var(--credit-brd); }


    .slot{margin-top:20px;padding-top:16px;border-top:var(--brd-width) solid var(--brd)}
    .slot h2{margin:0 0 10px 0;font-size:clamp(16px,2.6vw,22px);font-weight:900}
    .reels{
      display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0;
      perspective: 200px; /* NEW: For 3D reel settling */
    }
    .reel{
      background:linear-gradient(180deg,#0d131a,#0b1016);border:var(--brd-width) solid var(--brd);border-radius:14px;height:96px;display:grid;place-items:center;font-size:clamp(40px,6vw,56px);box-shadow:var(--shadow-1),inset 0 1px 0 rgba(255,255,255,.06);
      font-family: 'Arial', sans-serif; /* Better emoji rendering */
      /* NEW: Transition for blur/spin */
      transition: transform 300ms cubic-bezier(0.1, 1, 0.3, 1), filter 300ms ease, opacity 300ms ease;
    }
    /* NEW: Spinning class for reels */
    .reel.spinning {
      filter: blur(4px);
      transform: scale(0.85);
      opacity: 0.7;
    }

    .slot-actions {display: grid;grid-template-columns: 1fr 1fr;gap: 20px;margin-top: 16px;}
    .action {display: flex;flex-direction: column;}
    .action .ctrl {width: 100%;}
    .cost, .buy-cost-text {font-size: 11px;color: var(--muted);text-align: center;margin-top: 8px;line-height: 1.4;}

    /* Modal styling */
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:none; /* Changed to none, JS will toggle to flex */
      align-items:center;justify-content:center;z-index:999;backdrop-filter:blur(4px);
      /* NEW: Transitions for fade-in */
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    /* NEW: Visible class toggled by JS */
    .modal-backdrop.visible {
      opacity: 1;
    }
    .modal{
      background:#0f141a;border:var(--brd-width) solid #2a3a4d;border-radius:14px;width:min(420px,92vw);padding:18px;box-shadow:0 14px 36px rgba(0,0,0,.55),var(--glow);
      /* NEW: Transitions for modal pop-in */
      opacity: 0;
      transform: scale(0.9) translateY(20px);
      transition: transform 250ms cubic-bezier(0.34, 1.56, 0.64, 1), opacity 200ms ease;
    }
    /* NEW: Visible state for modal */
    .modal-backdrop.visible .modal {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
    
    .modal h3{margin:0 0 8px 0;font-size:18px}
    .modal p{margin:0 0 12px 0;color:var(--muted);font-size:14px}
    .modal .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{
      appearance:none;border:2px solid transparent;border-radius:12px;padding:14px 16px;font-weight:900;font-size:16px;cursor:pointer;min-height:48px;
      /* NEW: Re-using button transitions */
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-med), border-color var(--transition-med);
    }
    .btn.primary{background:oklch(48% .13 160);border-color:oklch(62% .14 160);color:#fff}
    .btn.secondary{background:#0b1117;border-color:#2a3a4d;color:#e9f1fa}
    /* NEW: Modal button interaction states */
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,.2);
    }
    .btn:active {
      transform: translateY(0) scale(0.97);
      box-shadow: none;
    }
    .btn.primary:hover { border-color: oklch(75% .14 160); }
    .btn.secondary:hover { border-color: var(--brd-strong); }


    @media (max-width:640px){
      .wrap{width:100vw}
      .card{border-radius:0;padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right)) max(16px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left))}
      .value{font-size:clamp(22px,7.5vw,32px)}
      .slot-actions{grid-template-columns:1fr;gap:10px}
      .controls{gap:8px}
      .reel{height:110px;font-size:clamp(48px,16vw,80px)}
      .modal{width:min(500px,96vw)}
      .modal .actions{grid-template-columns:1fr}
      .btn{font-size:18px;padding:16px 18px;min-height:56px}
    }
    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="gameTimer">15:00:00</div>

      <div class="stats-grid">
        <div class="stat money"><div class="label">Money</div><div class="value" id="val1">$0.00</div></div>
        <div class="stat credit"><div class="label">Credit</div><div class="value" id="val2">0.00</div></div>
        <div class="stat rate1"><div class="label">Rate 1</div><div class="value"><span id="rate1">3.00</span> <span class="badge">/s</span></div><div class="growth">Growth: <span id="grow1">2</span>/m</div></div>
        <div class="stat rate2"><div class="label">Rate 2</div><div class="value"><span id="rate2">3.00</span> <span class="badge">/s</span></div><div class="growth">Growth: <span id="grow2">12</span>/m</div></div>
      </div>

      <div class="slider-wrap">
        <div class="slider" id="uniSlider" role="group" aria-label="Growth slider">
          <div class="track"></div>
          <div class="thumb" id="thumb" role="slider" aria-valuemin="2" aria-valuemax="12" aria-valuenow="2" aria-valuetext="2" tabindex="0"></div>
          <div class="ticks ticks-top" id="ticksTop"></div>
          <div class="ticks ticks-bottom" id="ticksBottom"></div>
        </div>
      </div>

      <div class="controls">
        <button class="ctrl ctrl-fixed" id="swapBtn">Swap</button>
        <button class="ctrl ctrl-fixed" id="pause">Pause</button>
      </div>

      <section class="slot" aria-label="3-reel slot machine">
        <h2>3‚ÄëReel Slot</h2>
        <div class="reels">
          <div class="reel" id="reel1">üçí</div>
          <div class="reel" id="reel2">üçã</div>
          <div class="reel" id="reel3">üçá</div>
        </div>
        <div class="slot-actions">
          <div class="action">
            <button class="ctrl" id="spin">Spin</button>
            <span class="cost" id="spinCostMsg" aria-live="polite">$50 + 1.0 Rate Point</span>
          </div>
          <div class="action">
            <button class="ctrl ctrl-buy" id="buyBtn">Buy</button>
            <span class="buy-cost-text" id="buyCostMsg" aria-live="polite">Buy 6x üíé. 500c + 1.0 Rate 2 Point</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="modal-backdrop" id="winModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="winTitle" aria-describedby="winDesc">
      <h3 id="winTitle">3‚Äëof‚Äëa‚Äëkind!</h3>
      <p id="winDesc">Choose your reward to continue.</p>
      <div class="actions">
        <button class="btn secondary" id="reduceBtn">Lower spin cost by 0.1 Rate Point</button>
        <button class="btn primary" id="takeMoneyBtn">Take $600</button>
      </div>
    </div>
  </div>

  <script>
    // Constants (No logic changes)
    const MAX_RATE = 199;
    const SPIN_DOLLAR_COST = 50;
    const BUY_DIAMOND_COST = 500;
    const BUY_DIAMOND_RATE_COST = 1.0;
    const GAME_DURATION_SECONDS = 15 * 60;
    const GROW_STEPS = [2,4,6,8,10,12];
    const STEP_COUNT = GROW_STEPS.length;

    // State (No logic changes)
    let value1 = 0, value2 = 0, rate1 = 3, rate2 = 3, gameTimeSeconds = GAME_DURATION_SECONDS;
    let grow1 = GROW_STEPS[0];
    let grow2 = 14 - grow1;
    let spinDollarCost = SPIN_DOLLAR_COST;
    let spinRateCost = 1.0;
    let winMoneyReward = 600;
    let buyDiamondCost = BUY_DIAMOND_COST;
    let buyDiamondRateCost = BUY_DIAMOND_RATE_COST;
    const baseSymbols=['üçí','üçã','üçá','üçâ','üçä'];
    let symbols=[...baseSymbols];
    let diamondCount=0;
    let running=true, modalOpen=false;

    // Elements
    const gameTimerEl=document.getElementById('gameTimer');
    const val1El=document.getElementById('val1');
    const val2El=document.getElementById('val2');
    const rate1El=document.getElementById('rate1');
    const rate2El=document.getElementById('rate2');
    const grow1El=document.getElementById('grow1');
    const grow2El=document.getElementById('grow2');
    const slider=document.getElementById('uniSlider');
    const thumb=document.getElementById('thumb');
    const ticksTopEl = document.getElementById('ticksTop');
    const ticksBottomEl=document.getElementById('ticksBottom');
    const swapBtn = document.getElementById('swapBtn');
    const pauseBtn=document.getElementById('pause');
    const spinBtn=document.getElementById('spin');
    const spinCostMsg=document.getElementById('spinCostMsg');
    const buyBtn=document.getElementById('buyBtn');
    const buyCostMsg=document.getElementById('buyCostMsg');
    const backdrop=document.getElementById('winModalBackdrop');
    const takeMoneyBtn=document.getElementById('takeMoneyBtn');
    const reduceBtn=document.getElementById('reduceBtn');
    const reelEls=[document.getElementById('reel1'),document.getElementById('reel2'),document.getElementById('reel3')];

    // Utils
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const fmt=(n)=>n.toFixed(2);
    const fmtRatePts=(x)=>x.toFixed(1);
    const fmtTime=(t)=>{const s=Math.floor(t),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return [h,m,sec].map(v=>String(v).padStart(2,'0')).join(':')};
    
    // --- NEW: Helper function for flashing elements ---
    function flashElement(el, flashClass) {
      el.classList.add(flashClass);
      el.addEventListener('animationend', () => {
        el.classList.remove(flashClass);
      }, { once: true });
    }

    // UI Updaters (No logic changes, just text)
    function updateCostMsg(){
      spinCostMsg.innerHTML = `<span class="badge badge-money">$${spinDollarCost}</span> + ${fmtRatePts(spinRateCost)} <span class="badge badge-rate1">Rate 1</span>`;
    }
    function updateBuyBtnUI(){
      if(diamondCount>0){ buyCostMsg.textContent=`üíé Active (${diamondCount} left)`; buyBtn.disabled=true; }
      else{
        buyCostMsg.innerHTML=`Buy 6x üíé. <span class="badge badge-credit">${buyDiamondCost}c</span> + ${buyDiamondRateCost.toFixed(1)} <span class="badge badge-rate2">Rate 2</span>`;
        buyBtn.disabled=false;
      }
    }
    function updateReadout(){
      if (gameTimeSeconds > 0 || running) {
        gameTimerEl.textContent = fmtTime(gameTimeSeconds);
      }
      val1El.textContent=`$${fmt(value1)}`;
      val2El.textContent=fmt(value2);
      rate1El.textContent=fmt(rate1);
      rate2El.textContent=fmt(rate2);
      grow1El.textContent=grow1;
      grow2El.textContent=grow2;
    }

    // Slider helpers (Unchanged)
    function buildTicks(){
      ticksBottomEl.innerHTML='';
      ticksTopEl.innerHTML = '';
      const growStepsDesc = [...GROW_STEPS].reverse();
      const createTicks = (parentElement, steps) => {
        steps.forEach((value, idx) => {
          const s = document.createElement('span');
          s.textContent = value;
          s.style.position = 'absolute';
          const pct = (STEP_COUNT <= 1) ? 0 : (idx / (STEP_COUNT - 1));
          s.style.left = `${pct * 100}%`;
          if (idx === 0) { s.style.transform = 'translateX(0)'; }
          else if (idx === STEP_COUNT - 1) { s.style.transform = 'translateX(-100%)'; }
          else { s.style.transform = 'translateX(-50%)'; }
          parentElement.appendChild(s);
        });
      };
      createTicks(ticksBottomEl, GROW_STEPS);
      createTicks(ticksTopEl, growStepsDesc);
    }
    function sliderInnerRect(){
      const r=slider.getBoundingClientRect();
      const left=r.left+16, right=r.right-16, width=Math.max(0,right-left);
      return {left,right,width};
    }
    function positionHandleByIndex(idx){
      const {left,width}=sliderInnerRect();
      const pct = (STEP_COUNT<=1)?0: idx/(STEP_COUNT-1);
      const x = left + pct*width;
      thumb.style.left = `${x - slider.getBoundingClientRect().left}px`;
      const val = GROW_STEPS[idx];
      thumb.setAttribute('aria-valuenow', String(val));
      thumb.setAttribute('aria-valuetext', String(val));
    }
    function nearestIndexFromClientX(xc){
      const {left,width}=sliderInnerRect();
      const x = clamp(xc-left,0,width);
      const pct = width===0?0:x/width;
      return clamp(Math.round(pct*(STEP_COUNT-1)),0,STEP_COUNT-1);
    }
    function setGrowthByIndex(idx){
      const v = GROW_STEPS[idx];
      grow1=v; grow2=14 - v;
      positionHandleByIndex(idx);
      grow1El.textContent=grow1; grow2El.textContent=grow2;
    }
    function currentIndex(){ return Math.max(0, GROW_STEPS.indexOf(grow1)); }
    function makeSliderInteractive(){
      buildTicks();
      setGrowthByIndex(0);
      let dragging=false;
      const onDown=(ev)=>{ dragging=true; thumb.focus(); const c=('touches'in ev)?ev.touches[0].clientX:ev.clientX; setGrowthByIndex(nearestIndexFromClientX(c)); ev.preventDefault(); };
      const onMove=(ev)=>{ if(!dragging) return; const c=('touches'in ev)?ev.touches[0].clientX:ev.clientX; setGrowthByIndex(nearestIndexFromClientX(c)); };
      const onUp=()=>{ dragging=false; };
      thumb.addEventListener('mousedown', onDown);
      thumb.addEventListener('touchstart', onDown, {passive:false});
      window.addEventListener('mousemove', onMove);
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('mouseup', onUp);
      window.addEventListener('touchend', onUp);
      slider.addEventListener('mousedown', (ev)=>{ if(ev.target===thumb) return; const c=ev.clientX; setGrowthByIndex(nearestIndexFromClientX(c)); });
      slider.addEventListener('touchstart', (ev)=>{ if(ev.target===thumb) return; const c=ev.touches[0].clientX; setGrowthByIndex(nearestIndexFromClientX(c)); }, {passive:false});
      thumb.addEventListener('keydown',(e)=>{
        let idx=currentIndex();
        if(e.key==='ArrowLeft'){ idx=clamp(idx-1,0,STEP_COUNT-1); setGrowthByIndex(idx); e.preventDefault(); }
        if(e.key==='ArrowRight'){ idx=clamp(idx+1,0,STEP_COUNT-1); setGrowthByIndex(idx); e.preventDefault(); }
        if(e.key==='Home'){ setGrowthByIndex(0); e.preventDefault(); }
        if(e.key==='End'){ setGrowthByIndex(STEP_COUNT-1); e.preventDefault(); }
      });
      const ro=new ResizeObserver(()=> positionHandleByIndex(currentIndex()));
      ro.observe(slider);
    }

    // --- UPDATED: Modal helpers for animated fade-in/out ---
    function openWinChoice(){
      return new Promise((resolve)=>{
        modalOpen=true;
        takeMoneyBtn.textContent=`Take $${winMoneyReward}`;
        backdrop.style.display='flex'; // Set to flex
        
        backdrop.offsetHeight; // Force reflow
        
        backdrop.classList.add('visible'); // Add class to trigger transition
        
        const focusables=[reduceBtn,takeMoneyBtn]; let idx=0; focusables[idx].focus();
        function onKey(e){ if(e.key==='Tab'){ e.preventDefault(); idx=(idx+(e.shiftKey?-1:1)+focusables.length)%focusables.length; focusables[idx].focus(); } if(e.key==='Escape'){ e.preventDefault(); } }
        document.addEventListener('keydown', onKey);
        
        function cleanup(){
          document.removeEventListener('keydown', onKey);
          backdrop.classList.remove('visible'); // Remove class to trigger fade-out
          
          // Wait for animation to finish before setting display:none
          setTimeout(() => {
            backdrop.style.display='none';
            modalOpen=false;
          }, 250); // Match CSS transition time
        }
        reduceBtn.onclick=()=>{ cleanup(); resolve('reduce'); };
        takeMoneyBtn.onclick=()=>{ cleanup(); resolve('money'); };
      });
    }

    // Slot logic
    const visualSymbol=()=>symbols[Math.floor(Math.random()*symbols.length)];
    function randomSymbol(){ let s=symbols[Math.floor(Math.random()*symbols.length)]; if(s==='üíé'){ if(diamondCount>0){ diamondCount--; updateBuyBtnUI(); if(diamondCount===0) symbols=symbols.filter(x=>x!=='üíé'); return 'üíé'; } else { return baseSymbols[Math.floor(Math.random()*baseSymbols.length)]; } } return s; }

    // --- NEW: Helper function for animated reel spin ---
    function runReelSpin(el, duration) {
      return new Promise(resolve => {
        const startTime = performance.now();
        el.classList.add('spinning'); // Add blur/transform class

        function spinLoop(now) {
          const elapsed = now - startTime;
          if (elapsed < duration) {
            // Keep spinning visually
            el.textContent = visualSymbol();
            requestAnimationFrame(spinLoop);
          } else {
            // Time's up
            el.classList.remove('spinning');
            const finalSymbol = randomSymbol(); // Get the *actual* symbol
            el.textContent = finalSymbol;
            
            // Apply settle animation
            el.style.animation = 'reelSettle 400ms cubic-bezier(0.17, 0.67, 0.33, 1.2)';
            el.addEventListener('animationend', () => {
              el.style.animation = ''; // Clean up
              resolve(finalSymbol);
            }, { once: true });
          }
        }
        requestAnimationFrame(spinLoop);
      });
    }

    // --- UPDATED: spinOnce function to use new reel animation ---
    async function spinOnce(){
      if(!spinBtn || spinBtn.disabled || modalOpen) return;
      if(value1 < spinDollarCost || rate1 < spinRateCost){
        spinBtn.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:180});
        return;
      }
      // Logic: Deduct cost
      value1 -= spinDollarCost;
      rate1 = Math.max(0, rate1 - spinRateCost);
      spinDollarCost += 1;
      updateCostMsg();
      updateReadout();
      spinBtn.disabled=true;
      
      // Visual: Run spins
      const durations=[900,1100,1300];
      const spinPromises = reelEls.map((el, i) => runReelSpin(el, durations[i]));
      const finalSyms = await Promise.all(spinPromises); // Get results

      // Logic: Check for win
      const nonWild=finalSyms.filter(s=>s!=='üíé');
      let win=false;
      if(nonWild.length<=1) win=true;
      else if(nonWild.length===2) win=(nonWild[0]===nonWild[1]);
      else win=(finalSyms[0]===finalSyms[1] && finalSyms[1]===finalSyms[2]);

      // Logic: Handle win
      if(win){
        const choice=await openWinChoice();
        const rewardThisWin=winMoneyReward;
        if(choice==='money'){
          value1 += rewardThisWin;
          flashElement(val1El, 'value-flash-money'); // NEW: Flash on win
        } else {
          spinRateCost = Math.max(0, +(spinRateCost - 0.1).toFixed(1));
          updateCostMsg();
        }
        winMoneyReward = rewardThisWin + 600;
      }

      spinBtn.disabled=false;
      updateReadout();
    }

    // Controls (Unchanged logic)
    function attachControls(){
      swapBtn.addEventListener('click', ()=>{
        [value1, value2] = [value2, value1];
        swapBtn.disabled = true;
        updateReadout();
      });
      pauseBtn.addEventListener('click', ()=>{ running=!running; pauseBtn.textContent= running? 'Pause':'Resume'; });
      buyBtn.addEventListener('click', ()=>{
        if(value2>=buyDiamondCost && rate2>=buyDiamondRateCost && diamondCount===0){ value2-=buyDiamondCost; rate2=Math.max(0, rate2-buyDiamondRateCost); diamondCount=6; if(!symbols.includes('üíé')) symbols.push('üíé'); buyDiamondCost+=500; buyDiamondRateCost+=1; updateBuyBtnUI(); updateReadout(); }
        else{ if(value2<buyDiamondCost || rate2<buyDiamondRateCost){ buyBtn.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:180}); } }
      });
      spinBtn.addEventListener('click', spinOnce);
      spinBtn.addEventListener('keydown',(e)=>{ if(modalOpen){ e.preventDefault(); return; } if(e.key===' '||e.key==='Enter'){ e.preventDefault(); spinOnce(); } });
    }

    // Loop
    let lastTs; function tick(ts){
      if(lastTs===undefined) lastTs=ts;
      const dt=(ts-lastTs)/1000;
      lastTs=ts;

      if(running && dt>0){
        gameTimeSeconds -= dt;

        // --- NEW: Check for value change to apply flash ---
        const oldVal1Int = Math.floor(value1);
        value1 += rate1 * dt;
        if (Math.floor(value1) > oldVal1Int) {
          if (!val1El.classList.contains('flashing')) { // Use a cooldown class
            val1El.classList.add('flashing');
            setTimeout(() => val1El.classList.remove('flashing'), 200);
            flashElement(val1El, 'value-flash-money');
          }
        }
        
        const oldVal2Int = Math.floor(value2);
        value2 += rate2 * dt;
        if (Math.floor(value2) > oldVal2Int) {
           if (!val2El.classList.contains('flashing')) { // Use a cooldown class
            val2El.classList.add('flashing');
            setTimeout(() => val2El.classList.remove('flashing'), 200);
            flashElement(val2El, 'value-flash-credit');
           }
        }

        const gps1=(grow1/60), gps2=(grow2/60);
        rate1=Math.min(MAX_RATE, rate1 + gps1*dt);
        rate2=Math.min(MAX_RATE, rate2 + gps2*dt);

        if (gameTimeSeconds <= 0) {
          gameTimeSeconds = 0;
          running = false;
          pauseBtn.disabled = true;
          spinBtn.disabled = true;
          buyBtn.disabled = true;
          if (swapBtn) swapBtn.disabled = true;
          pauseBtn.textContent = "Over";
        }
      }

      updateReadout();

      if (gameTimeSeconds > 0 || (gameTimeSeconds <= 0 && running)) {
        requestAnimationFrame(tick);
      } else if (gameTimeSeconds <= 0 && !running) {
        gameTimerEl.textContent = "GAME OVER";
      }
    }

    function init(){ makeSliderInteractive(); updateCostMsg(); updateBuyBtnUI(); attachControls(); requestAnimationFrame(tick); }
    init();
  </script>
</body>
</html>
