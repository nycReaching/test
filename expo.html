<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Values, Rates, and Unified Growth Slider ‚Äî Redesign</title>
  <style>
    /* Goals
       - Great mobile experience
       - No button jump from dynamic text
       - Bolder borders, higher contrast, better sizing
    */

    :root {
      /* Surfaces */
      --bg: #07090d;
      --panel: #0d1218;
      --panel-2: #0a0f14;

      /* Text */
      --text: #f5f9ff;
      --muted: #9eb0c3;

      /* Controls */
      --track: #1b2532;
      --track-h: 10px;
      --thumb-size: 20px;
      --win: #ffd54a;

      /* Borders */
      --brd: #2e4053;       /* default */
      --brd-strong: #49627f;/* emphasized */
      --brd-width: 2px;

      /* Shadow */
      --shadow-1: 0 2px 6px rgba(0,0,0,.45);
      --shadow-2: 0 18px 36px rgba(0,0,0,.55);
      --glow: 0 0 0 2px rgba(255,255,255,.06);

      /* Token hues */
      --h-money: 150; /* emerald */
      --h-credit: 315; /* plum */
      --h-rate1: 28;   /* amber */
      --h-rate2: 170;  /* teal */

      /* Semantic palettes */
      --money-bg: oklch(22% .08 var(--h-money));
      --money-brd: oklch(38% .10 var(--h-money));
      --money-text: #e7ffee;

      --credit-bg: oklch(24% .10 var(--h-credit));
      --credit-brd: oklch(42% .12 var(--h-credit));
      --credit-text: #fde8ff;

      --rate1-bg: oklch(26% .10 250);
      --rate1-accent: oklch(82% .18 var(--h-rate1));

      --rate2-bg: oklch(26% .10 210);
      --rate2-accent: oklch(86% .14 var(--h-rate2));

      --accent: #b7c6d7;
      --max-rate: 99;

      /* Mobile constants */
      --tap: 48px; /* minimum hit size */
      --action-info-h: 1.6em; /* reserve text height under buttons */
    }

    @media (prefers-color-scheme: light) {
      :root { --text:#0c1218; --muted:#3b4a59; }
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 70% -20%, #17202b 0%, var(--bg) 55%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      min-height: 100vh;
      display: grid;
      place-items: center;
    }

    .wrap { width: min(920px, 94vw); }

    /* Game Timer */
    #gameTimer { text-align: center; font-size: 14px; color: var(--text); margin-bottom: 12px; font-family: 'Courier New', Courier, monospace; letter-spacing: 1px; opacity: .9; }

    .card {
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: var(--brd-width) solid var(--brd-strong);
      border-radius: 18px;
      padding: 20px clamp(14px, 4vw, 28px);
      box-shadow: var(--shadow-2);
      position: relative;
      overflow: clip;
      outline: 1px solid rgba(255,255,255,.06);
    }

    .card::before { content: ""; position: absolute; inset: 0 0 auto 0; height: 140px; background: radial-gradient(600px 160px at 30% -40px, rgba(255,255,255,.06), transparent 60%); pointer-events: none; transition: transform .35s ease; }
    .card:hover::before { transform: translateY(-2px); }

    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px clamp(12px, 3vw, 24px); margin-bottom: 18px; }
    .stat { background: #0b1117; border: var(--brd-width) solid var(--brd); border-radius: 14px; padding: 14px 16px; box-shadow: var(--shadow-1); transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .18s ease; }
    .stat:hover { transform: translateY(-2px); filter: brightness(1.03); }
    .label { font-size: 12px; color: var(--muted); letter-spacing: .25px; }
    .value { font-size: clamp(20px, 5vw, 30px); font-weight: 800; line-height: 1.1; margin-top: 8px; }
    .growth { margin-top: 6px; font-size: 12px; color: var(--muted); }

    .stat.money { background: var(--money-bg); border-color: var(--money-brd); }
    .stat.money .label, .stat.money .value { color: var(--money-text); text-shadow: 0 1px 0 rgba(0,0,0,.45); }

    .stat.credit { background: var(--credit-bg); border-color: var(--credit-brd); }
    .stat.credit .label, .stat.credit .value { color: var(--credit-text); text-shadow: 0 1px 0 rgba(0,0,0,.35); }

    .stat.rate1 { background: var(--rate1-bg); border-color: color-mix(in oklab, var(--rate1-bg), white 18%); }
    .stat.rate1 .label, .stat.rate1 .value, .stat.rate1 .growth { color: var(--rate1-accent); }

    .stat.rate2 { background: var(--rate2-bg); border-color: color-mix(in oklab, var(--rate2-bg), white 18%); }
    .stat.rate2 .label, .stat.rate2 .value, .stat.rate2 .growth { color: var(--rate2-accent); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 800; background: #223042; color: #ecf3fb; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }

    /* Slider */
    .slider-wrap { margin-top: 18px; }
    .slider { position: relative; height: 50px; user-select: none; }
    .track { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); height: var(--track-h); border-radius: 999px; background: linear-gradient(90deg, #1a2330, #213041 60%, #1a2330); outline: 1px solid #2a3a4d; box-shadow: inset 0 1px 0 rgba(255,255,255,.06); }

    .ticks { position: absolute; left: 0; right: 0; display: flex; justify-content: space-between; font-size: 11px; }
    .ticks span { width: 0; text-align: center; transform: translateX(-50%); }
    .ticks-top { bottom: calc(50% + 18px); color: var(--rate2-accent); font-weight: 800; text-shadow: 0 1px 0 rgba(0,0,0,.45); }
    .ticks-bottom { top: calc(50% + 18px); color: var(--rate1-accent); font-weight: 800; text-shadow: 0 1px 0 rgba(0,0,0,.45); }

    .thumb { position: absolute; top: 50%; transform: translate(-50%, -50%); width: var(--thumb-size); height: var(--thumb-size); border-radius: 6px; cursor: grab; box-shadow: 0 2px 0 rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.12), var(--glow); background: linear-gradient(180deg, #c5d2df 0%, #9fb0c3 100%); transition: transform .16s ease, box-shadow .16s ease, background .16s ease; }
    .thumb:hover { transform: translate(-50%, -50%) scale(1.06); }
    .thumb:active { cursor: grabbing; box-shadow: 0 0 0 2px rgba(255,255,255,.22), inset 0 0 0 1px rgba(255,255,255,.1); }
    .thumb:focus-visible { outline: 0; box-shadow: 0 0 0 2px color-mix(in oklab, var(--rate2-accent), white 10%); }

    .controls { margin-top: 14px; display: flex; gap: 10px; }
    button.ctrl { background: #0b1117; color: var(--text); border: var(--brd-width) solid #2a3a4d; border-radius: 12px; padding: 10px 12px; font-weight: 800; font-size: 14px; cursor: pointer; transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease, filter .12s ease; box-shadow: var(--shadow-1); min-height: var(--tap); }
    button.ctrl:hover { background: #0f1620; transform: translateY(-1px); }
    button.ctrl:active { transform: translateY(0) scale(.99); }
    .ctrl-fixed { width: 96px; padding: 10px 12px; font-size: 13px; }

    button.ctrl-buy { background: var(--credit-bg); border-color: var(--credit-brd); color: var(--credit-text); padding: 14px 20px; font-size: 17px; font-weight: 900; box-shadow: 0 6px 18px rgba(106, 53, 96, .45); }
    button.ctrl-buy:hover { background: color-mix(in oklab, var(--credit-bg), white 16%); filter: saturate(1.06); }
    button.ctrl-buy:disabled { opacity: .78; cursor: not-allowed; filter: grayscale(.1); }

    #spin.ctrl { background: var(--money-bg); border-color: var(--money-brd); padding: 14px 20px; font-size: 17px; font-weight: 900; color: var(--money-text); box-shadow: 0 6px 18px rgba(16, 60, 44, .45); }
    #spin.ctrl:hover { background: color-mix(in oklab, var(--money-bg), white 14%); filter: saturate(1.08); }

    /* Actions: info below buttons, no-jump layout */
    .slot-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 12px; align-items: start; }
    .action { display: flex; flex-direction: column; align-items: stretch; }
    .cost, .buy-cost-text { display: block; font-size: 12px; margin-top: 8px; min-height: var(--action-info-h); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cost { color: var(--money-text); }
    .buy-cost-text { color: var(--credit-text); }

    .rate-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 11px; font-weight: 900; line-height: 1.2; vertical-align: baseline; margin-left: 4px; border: 1px solid; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .rate-badge-1 { background: var(--rate1-bg); color: var(--rate1-accent); border-color: color-mix(in oklab, var(--rate1-bg), white 18%); }
    .rate-badge-2 { background: var(--rate2-bg); color: var(--rate2-accent); border-color: color-mix(in oklab, var(--rate2-bg), white 18%); }

    /* Slot machine */
    .slot { margin-top: 26px; padding-top: 16px; border-top: var(--brd-width) solid var(--brd); }
    .slot h2 { margin: 0 0 10px 0; font-size: clamp(16px, 2.6vw, 22px); font-weight: 900; letter-spacing: .2px; }
    .reels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 12px 0; }
    .reel { background: linear-gradient(180deg, #0d131a, #0b1016); border:var(--brd-width) solid var(--brd); border-radius: 14px; height: 96px; display:grid; place-items:center; font-size: clamp(40px, 6vw, 56px); transition: box-shadow .2s ease, border-color .2s ease, transform .12s ease; box-shadow: var(--shadow-1), inset 0 1px 0 rgba(255,255,255,.06); }
    .reel:hover { transform: translateY(-1px); }
    .reel.spinning { animation: pulse .6s linear infinite; filter: brightness(1.18); }
    .reel.win { border-color: var(--win); box-shadow: 0 0 0 2px color-mix(in oklab, var(--win), white 10%) inset, 0 0 18px var(--win), var(--shadow-2); animation: winflash .5s ease-out; }

    @keyframes pulse { 0%{transform:translateY(0) scale(1);} 50%{transform:translateY(-4px) scale(.985);} 100%{transform:translateY(0) scale(1);} }
    @keyframes winflash { 0% { box-shadow: 0 0 0 0 rgba(255,213,74,0.0), var(--shadow-2); } 50% { box-shadow: 0 0 0 3px color-mix(in oklab, var(--win), white 20%) inset, 0 0 32px var(--win), var(--shadow-2); } 100% { box-shadow: 0 0 0 2px color-mix(in oklab, var(--win), white 10%) inset, 0 0 18px var(--win), var(--shadow-2); } }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 999; backdrop-filter: blur(4px); }
    .modal { background: #0f141a; border: var(--brd-width) solid #2a3a4d; border-radius: 14px; width: min(420px, 92vw); padding: 18px; box-shadow: 0 14px 36px rgba(0,0,0,.55), var(--glow); }
    .modal h3 { margin: 0 0 8px 0; font-size: 18px; }
    .modal p { margin: 0 0 14px 0; color: var(--muted); font-size: 14px; }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn { background: #0d1117; color: var(--text); border: var(--brd-width) solid #2a3a4d; border-radius: 12px; padding: 12px 14px; font-weight: 900; font-size: 14px; cursor: pointer; box-shadow: var(--shadow-1); transition: transform .12s ease, background .12s ease; min-height: var(--tap); }
    .btn.primary { background: var(--money-bg); border-color: var(--money-brd); color: var(--money-text); }
    .btn.secondary { background: #0f1620; }
    .btn:focus-visible { outline: 2px solid #425b78; outline-offset: 2px; }
    .btn:hover { transform: translateY(-1px); }

    /* Mobile-first refinements */
    @media (max-width: 640px) {
      .wrap { width: 100vw; }
      .card { border-radius: 0; padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(16px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left)); }
      .grid, .row { grid-template-columns: 1fr; }
      .value { font-size: clamp(22px, 8vw, 32px); }
      .slider { height: 56px; }
      .ticks-top, .ticks-bottom { font-size: 12px; }
      .slot-actions { grid-template-columns: 1fr; gap: 10px; }
      .ctrl-fixed { width: auto; flex: 1; }
      .controls { gap: 8px; }
      .controls .ctrl { flex: 1; }
      .reel { height: 110px; font-size: clamp(48px, 16vw, 80px); }
      .cost, .buy-cost-text { font-size: 13px; min-height: calc(var(--action-info-h) + 0.2em); }
    }

    @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- Game Timer -->
      <div id="gameTimer">00:00:00</div>

      <!-- Values -->
      <div class="grid">
        <div class="stat money">
          <div class="label">Money</div>
          <div class="value" id="val1">$0.00</div>
        </div>
        <div class="stat credit">
          <div class="label">Credit</div>
          <div class="value" id="val2">0.00</div>
        </div>
      </div>

      <!-- Rates -->
      <div class="row">
        <div class="stat rate1">
          <div class="label">Rate 1</div>
          <div class="value"><span id="rate1">1.00</span> <span class="badge">/s</span></div>
          <div class="growth">Growth: <span id="grow1">1</span>/m</div>
        </div>
        <div class="stat rate2">
          <div class="label">Rate 2</div>
          <div class="value"><span id="rate2">2.00</span> <span class="badge">/s</span></div>
          <div class="growth">Growth: <span id="grow2">10</span>/m</div>
        </div>
      </div>

      <!-- Unified slider controlling both growths -->
      <div class="slider-wrap">
        <div class="slider" id="uniSlider" aria-label="Unified growth slider for both rates" role="group">
          <div class="ticks ticks-top" id="ticksTop"></div>
          <div class="track"></div>
          <div class="thumb" id="thumb" aria-label="Growth handle" role="slider" aria-valuemin="1" aria-valuemax="10" aria-valuenow="1" tabindex="0"></div>
          <div class="ticks ticks-bottom" id="ticksBottom"></div>
        </div>
      </div>

      <div class="controls">
        <button class="ctrl ctrl-fixed" id="reset">Reset</button>
        <button class="ctrl ctrl-fixed" id="pause">Pause</button>
      </div>

      <!-- Slot Machine -->
      <section class="slot" aria-label="3-reel slot machine">
        <h2>3‚ÄëReel Slot</h2>
        <div class="reels">
          <div class="reel" id="reel1">üçí</div>
          <div class="reel" id="reel2">üçã</div>
          <div class="reel" id="reel3">üçá</div>
        </div>

        <!-- Actions: info below buttons, stabilized height -->
        <div class="slot-actions">
          <div class="action">
            <button class="ctrl" id="spin">Spin</button>
            <span class="cost" id="spinCostMsg" aria-live="polite">Cost: $50 + 1.0 Rate Point</span>
          </div>
          <div class="action">
            <button class="ctrl ctrl-buy" id="buyBtn">Buy</button>
            <span class="buy-cost-text" id="buyCostMsg" aria-live="polite">Buy 3x üíé. Cost: 500c + 1.0 Rate 2 Point</span>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="winModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="winTitle" aria-describedby="winDesc">
      <h3 id="winTitle">3‚Äëof‚Äëa‚Äëkind!</h3>
      <p id="winDesc">Choose your reward to continue.</p>
      <div class="actions">
        <button class="btn secondary" id="reduceBtn">Lower spin cost by 0.1 Rate Point</button>
        <button class="btn primary" id="takeMoneyBtn">Take $500</button>
      </div>
    </div>
  </div>

  <script>
    // --- Constants ---
    const STEPS = 10;
    const MIN_GROW = 1;
    const MAX_GROW = 10;
    const MAX_RATE = 99;
    const SPIN_DOLLAR_COST = 50;
    const BUY_DIAMOND_COST = 500;
    const BUY_DIAMOND_RATE_COST = 1.0;

    // Dynamic scaling
    let spinDollarCost = SPIN_DOLLAR_COST;   // +$1 per spin
    let spinRateCost = 1.0;                  // unchanged by spins
    let winMoneyReward = 500;                // +$500 after each win (regardless of choice)
    let buyDiamondCost = BUY_DIAMOND_COST;   // +500c per diamond purchase
    let buyDiamondRateCost = BUY_DIAMOND_RATE_COST; // +1 per diamond purchase

    // State
    let value1 = 0; // Money
    let value2 = 0; // Credit
    let rate1 = 1;
    let rate2 = 2;
    let gameTimeSeconds = 0;

    let grow1 = 1;
    let grow2 = (MAX_GROW + MIN_GROW) - grow1;

    const baseSymbols = ['üçí','üçã','üçá','üçâ','üçä'];
    let symbols = [...baseSymbols];
    let diamondCount = 0;

    let running = true;
    let modalOpen = false;

    // Elements
    const gameTimerEl = document.getElementById('gameTimer');
    const val1El = document.getElementById('val1');
    const val2El = document.getElementById('val2');
    const rate1El = document.getElementById('rate1');
    const rate2El = document.getElementById('rate2');
    const grow1El = document.getElementById('grow1');
    const grow2El = document.getElementById('grow2');

    const slider = document.getElementById('uniSlider');
    const thumb = document.getElementById('thumb');
    const ticksBottomEl = document.getElementById('ticksBottom');
    const ticksTopEl = document.getElementById('ticksTop');

    const resetBtn = document.getElementById('reset');
    const pauseBtn = document.getElementById('pause');

    const spinBtn = document.getElementById('spin');
    const spinCostMsg = document.getElementById('spinCostMsg');

    const buyBtn = document.getElementById('buyBtn');
    const buyCostMsg = document.getElementById('buyCostMsg');

    const backdrop = document.getElementById('winModalBackdrop');
    const takeMoneyBtn = document.getElementById('takeMoneyBtn');
    const reduceBtn = document.getElementById('reduceBtn');

    // --- Utils ---
    const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
    const fmt = (n) => n.toFixed(2);
    const fmtRatePts = (x) => x.toFixed(1);
    const fmtTime = (totalSeconds) => {
      const s = Math.floor(totalSeconds);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return [h, m, sec].map(v => String(v).padStart(2, '0')).join(':');
    };

    // --- Display helpers ---
    function updateCostMsg(){
      const cost = fmtRatePts(spinRateCost);
      spinCostMsg.innerHTML = `Cost: $${spinDollarCost} + ${cost} <span class="rate-badge rate-badge-1">Rate 1</span>`;
    }
    function updateBuyBtnUI() {
      if (diamondCount > 0) {
        buyCostMsg.textContent = `üíé Active (${diamondCount} left)`;
        buyBtn.disabled = true;
      } else {
        const cost = buyDiamondRateCost.toFixed(1);
        buyCostMsg.innerHTML = `Buy 3x üíé. Cost: ${buyDiamondCost}c + ${cost} <span class="rate-badge rate-badge-2">Rate 2</span>`;
        buyBtn.disabled = false;
      }
    }

    function updateReadout(){
      gameTimerEl.textContent = fmtTime(gameTimeSeconds);
      val1El.textContent = `$${fmt(value1)}`;
      val2El.textContent = fmt(value2);
      rate1El.textContent = fmt(rate1);
      rate2El.textContent = fmt(rate2);
      grow1El.textContent = grow1;
      grow2El.textContent = grow2;
    }

    // --- Slider ---
    const STEPS_TOTAL = 10;
    function buildTicks(){
      ticksBottomEl.innerHTML = '';
      ticksTopEl.innerHTML = '';
      for(let i=1;i<=STEPS_TOTAL;i++){
        const sBottom = document.createElement('span');
        sBottom.textContent = i;
        ticksBottomEl.appendChild(sBottom);
        const sTop = document.createElement('span');
        sTop.textContent = (STEPS_TOTAL + MIN_GROW) - i;
        ticksTopEl.appendChild(sTop);
      }
    }

    function positionHandle(step){
      const rect = slider.getBoundingClientRect();
      const pct = (step - 1) / (STEPS_TOTAL - 1);
      const x = pct * rect.width;
      thumb.style.left = `${x}px`;
      thumb.setAttribute('aria-valuenow', String(step));
    }

    function stepFromClientX(clientX){
      const rect = slider.getBoundingClientRect();
      const x = clamp(clientX - rect.left, 0, rect.width);
      const pct = rect.width === 0 ? 0 : x / rect.width;
      let step = Math.round(pct * (STEPS_TOTAL - 1)) + 1;
      return clamp(step, MIN_GROW, MAX_GROW);
    }

    function syncHandle(step){
      const currentStep = (step !== undefined) ? step : grow1;
      grow1 = currentStep;
      grow2 = (MAX_GROW + MIN_GROW) - grow1;
      positionHandle(grow1);
      grow1El.textContent = grow1;
      grow2El.textContent = grow2;
    }

    function makeDraggable(){
      let dragging = false;
      function onDown(ev){
        dragging = true; thumb.focus();
        const c = ('touches' in ev) ? ev.touches[0].clientX : ev.clientX;
        syncHandle(stepFromClientX(c));
        ev.preventDefault();
      }
      function onMove(ev){ if(!dragging) return; const c = ('touches' in ev) ? ev.touches[0].clientX : ev.clientX; syncHandle(stepFromClientX(c)); }
      function onUp(){ dragging = false; }

      thumb.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);

      thumb.addEventListener('touchstart', onDown, {passive:false});
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('touchend', onUp);

      thumb.addEventListener('keydown', (e)=>{
        if(e.key === 'ArrowLeft') { syncHandle(clamp(Number(thumb.getAttribute('aria-valuenow')) - 1, MIN_GROW, MAX_GROW)); e.preventDefault(); }
        if(e.key === 'ArrowRight'){ syncHandle(clamp(Number(thumb.getAttribute('aria-valuenow')) + 1, MIN_GROW, MAX_GROW)); e.preventDefault(); }
      });
    }

    // --- Modal ---
    function openWinChoice(){
      return new Promise((resolve)=>{
        modalOpen = true;
        takeMoneyBtn.textContent = `Take $${winMoneyReward}`; // dynamic label
        backdrop.style.display = 'flex';
        backdrop.setAttribute('aria-hidden', 'false');
        const focusables = [reduceBtn, takeMoneyBtn];
        let idx = 0; focusables[idx].focus();
        function onKey(e){
          if(e.key === 'Tab'){
            e.preventDefault();
            idx = (idx + (e.shiftKey ? -1 : 1) + focusables.length) % focusables.length;
            focusables[idx].focus();
          }
          if(e.key === 'Escape'){ e.preventDefault(); }
        }
        document.addEventListener('keydown', onKey);
        function cleanup(){
          document.removeEventListener('keydown', onKey);
          backdrop.style.display = 'none';
          backdrop.setAttribute('aria-hidden', 'true');
          modalOpen = false;
        }
        reduceBtn.onclick = ()=>{ cleanup(); resolve('reduce'); };
        takeMoneyBtn.onclick = ()=>{ cleanup(); resolve('money'); };
        backdrop.onclick = (e)=>{ if(e.target === backdrop){ /* click-out disabled */ } };
      });
    }

    // --- Slot/Reels ---
    const reelEls = [ document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3') ];
    const visualSymbol = () => symbols[Math.floor(Math.random() * symbols.length)];
    function randomSymbol() {
      let symbol = symbols[Math.floor(Math.random() * symbols.length)];
      if (symbol === 'üíé') {
        if (diamondCount > 0) {
          diamondCount--; updateBuyBtnUI();
          if (diamondCount === 0) symbols = symbols.filter(s => s !== 'üíé');
          return 'üíé';
        } else {
          return baseSymbols[Math.floor(Math.random() * baseSymbols.length)];
        }
      }
      return symbol;
    }

    async function spinOnce(){
      if(!spinBtn || spinBtn.disabled || modalOpen) return;
      reelEls.forEach(el=> el.classList.remove('win'));
      if(value1 < spinDollarCost || rate1 < spinRateCost){
        spinBtn.animate([{ transform: 'translateX(0)' },{ transform: 'translateX(-4px)' },{ transform: 'translateX(4px)' },{ transform: 'translateX(0)' }], { duration: 180 });
        return;
      }
      // Pay current costs
      value1 -= spinDollarCost;
      rate1 = Math.max(0, rate1 - spinRateCost);
      // Increase only the $ portion after each spin
      spinDollarCost += 1;
      updateCostMsg();
      updateReadout();

      // Spin visuals
      spinBtn.disabled = true;
      const speeds = [70, 85, 100];
      const durations = [900, 1100, 1300];
      const finalSyms = new Array(3);
      await new Promise((resolve)=>{
        let finished = 0;
        reelEls.forEach((el, i)=>{
          el.classList.add('spinning');
          const intervalId = setInterval(()=>{ el.textContent = visualSymbol(); }, speeds[i]);
          setTimeout(()=>{
            clearInterval(intervalId);
            el.classList.remove('spinning');
            finalSyms[i] = randomSymbol();
            el.textContent = finalSyms[i];
            finished++;
            if(finished === reelEls.length) resolve();
          }, durations[i]);
        });
      });

      // Evaluate
      const nonWild = finalSyms.filter(s => s !== 'üíé');
      let win = false;
      if (nonWild.length <= 1) win = true; // all diamonds or two diamonds + one symbol
      else if (nonWild.length === 2) win = (nonWild[0] === nonWild[1]);
      else win = (finalSyms[0] === finalSyms[1] && finalSyms[1] === finalSyms[2]);

      if (win) {
        reelEls.forEach(r=> r.classList.add('win'));
        await new Promise(res => setTimeout(res, 500)); // glow before modal
        const choice = await openWinChoice();

        // Capture reward for this win, then increment regardless of choice
        const rewardThisWin = winMoneyReward;
        if(choice === 'money'){
          value1 += rewardThisWin; // award current reward
          updateReadout();
        } else if(choice === 'reduce'){
          spinRateCost = Math.max(0, +(spinRateCost - 0.1).toFixed(1));
          updateCostMsg();
        }
        // Always increase future reward by $500 even if money was not taken
        winMoneyReward = rewardThisWin + 500;
      }
      spinBtn.disabled = false;
    }

    // --- Controls ---
    function attachControls(){
      resetBtn.addEventListener('click', ()=>{
        value1 = 0; value2 = 0; rate1 = 1; rate2 = 2;
        gameTimeSeconds = 0;
        grow1 = 1; grow2 = (MAX_GROW + MIN_GROW) - grow1;
        running = true;
        spinRateCost = 1.0;
        spinDollarCost = SPIN_DOLLAR_COST;
        winMoneyReward = 500;
        buyDiamondCost = BUY_DIAMOND_COST;
        buyDiamondRateCost = BUY_DIAMOND_RATE_COST;
        pauseBtn.textContent = 'Pause';
        diamondCount = 0; symbols = [...baseSymbols];
        updateBuyBtnUI();
        syncHandle();
        updateReadout();
        updateCostMsg();
      });

      pauseBtn.addEventListener('click', ()=>{
        running = !running;
        pauseBtn.textContent = running ? 'Pause' : 'Resume';
      });

      buyBtn.addEventListener('click', () => {
        if (value2 >= buyDiamondCost && rate2 >= buyDiamondRateCost && diamondCount === 0) {
          value2 -= buyDiamondCost;
          rate2 = Math.max(0, rate2 - buyDiamondRateCost);
          diamondCount = 3;
          if (!symbols.includes('üíé')) symbols.push('üíé');
          buyDiamondCost += 500;      // scale credit cost
          buyDiamondRateCost += 1;    // scale rate 2 cost
          updateBuyBtnUI();
          updateReadout();
        } else {
          if (value2 < buyDiamondCost || rate2 < buyDiamondRateCost) {
            buyBtn.animate([{ transform: 'translateX(0)' },{ transform: 'translateX(-4px)' },{ transform: 'translateX(4px)' },{ transform: 'translateX(0)' }], { duration: 180 });
          }
        }
      });

      if(spinBtn){
        const cs = getComputedStyle(document.documentElement);
        spinBtn.style.background = cs.getPropertyValue('--money-bg');
        spinBtn.style.borderColor = cs.getPropertyValue('--money-brd');
        spinBtn.addEventListener('mouseenter', ()=> spinBtn.style.background = `color-mix(in oklab, ${cs.getPropertyValue('--money-bg')}, white 14%)`);
        spinBtn.addEventListener('mouseleave', ()=> spinBtn.style.background = cs.getPropertyValue('--money-bg'));
        spinBtn.addEventListener('click', spinOnce);
        spinBtn.addEventListener('keydown', (e)=>{ if(modalOpen) { e.preventDefault(); return; } if(e.key === ' ' || e.key === 'Enter'){ e.preventDefault(); spinOnce(); } });
      }
    }

    // --- Game loop ---
    let lastTs;
    function tick(ts){
      if(lastTs === undefined) lastTs = ts;
      const dt = (ts - lastTs) / 1000; lastTs = ts;
      if(running && dt > 0){
        gameTimeSeconds += dt;
        value1 += rate1 * dt;
        value2 += rate2 * dt;
        const gps1 = (grow1 / 60);
        const gps2 = (grow2 / 60);
        rate1 = Math.min(MAX_RATE, rate1 + gps1 * dt);
        rate2 = Math.min(MAX_RATE, rate2 + gps2 * dt);
      }
      updateReadout();
      requestAnimationFrame(tick);
    }

    // --- Simple tests (console) ---
    function nextSpinDollarCost(c){ return c + 1; }
    function nextWinMoneyReward(c){ return c + 500; }
    function nextDiamondCosts(cCredits, cRate){ return [cCredits + 500, cRate + 1]; }
    function runTests(){
      console.groupCollapsed('Sanity tests');
      console.assert(nextSpinDollarCost(50) === 51, 'spin cost should +1');
      console.assert(nextWinMoneyReward(500) === 1000, 'win reward +$500');
      const d = nextDiamondCosts(500, 1.0); console.assert(d[0] === 1000 && d[1] === 2.0, 'diamond costs scale');
      console.groupEnd();
    }

    // --- Init ---
    function init(){
      buildTicks();
      syncHandle();
      updateCostMsg();
      updateBuyBtnUI();
      makeDraggable();
      attachControls();
      requestAnimationFrame(tick);
      const ro = new ResizeObserver(()=> syncHandle());
      ro.observe(slider);
      runTests();
    }
    init();
  </script>
</body>
</html>
