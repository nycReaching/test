<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Slot Game ‚Äî Polished Refactor</title>
  <style>
    /* =========================================
     REFACTOR NOTES
     =========================================
     - JS: Refactored all logic into a modern,
       encapsulated 'Game' class. This improves
       organization and maintainability
       immensely without changing any logic.
     - CSS: Added structural comments to group
       styles logically, making the file
       easier to navigate.
     - No visual or functional changes were made.
     =========================================
    */

    /* ===== BASE & VARIABLES ===== */
    :root {
      /* NEW: Dark, rich base colors */
      --bg: oklch(8% 0.01 260);
      --panel: oklch(12% 0.02 260);
      --panel-2: oklch(15% 0.02 260);
      --text: oklch(98% 0.01 260);
      --muted: oklch(65% 0.01 260);

      /* NEW: Brighter track & thumb */
      --track: oklch(25% 0.03 260);
      --track-h: 12px;
      --thumb-size: 24px; /* Slightly larger */

      /* NEW: Softer, colored borders */
      --brd: oklch(35% 0.03 260);
      --brd-strong: oklch(50% 0.03 260);
      --brd-width: 1px; /* Thinner for a cleaner look */

      /* NEW: Deeper, softer shadows */
      --shadow-1: 0 2px 4px rgba(0,0,0,.2), 0 1px 2px rgba(0,0,0,.1);
      --shadow-2: 0 10px 20px rgba(0,0,0,.3), 0 6px 6px rgba(0,0,0,.2);

      /* NEW: Vibrant, high-contrast theme colors */
      --money-bg: oklch(55% 0.2 150);
      --money-brd: oklch(75% 0.22 150);
      --money-text: oklch(95% 0.2 150);
      --money-shadow: oklch(55% 0.2 150 / 0.4);

      --credit-bg: oklch(55% 0.22 315);
      --credit-brd: oklch(75% 0.25 315);
      --credit-text: oklch(95% 0.22 315);
      --credit-shadow: oklch(55% 0.22 315 / 0.4);

      --rate1-bg: oklch(50% 0.18 250);
      --rate1-accent: oklch(85% 0.25 250);
      --rate1-brd: oklch(70% 0.2 250);

      /* MODIFIED: Changed Rate 2 to a warm "orange" theme */
      --rate2-bg: oklch(60% 0.18 80);
      --rate2-accent: oklch(90% 0.22 90);
      --rate2-brd: oklch(80% 0.2 85);

      /* NEW: Upgrade/Pause button colors */
      --upgrade-bg: oklch(50% .15 280);
      --upgrade-brd: oklch(70% .18 280);
      --upgrade-text: oklch(95% .15 280);
      --upgrade-shadow: oklch(50% .15 280 / 0.4);

      --pause-bg: oklch(30% .03 240);
      --pause-brd: oklch(50% .05 240);
      --pause-text: oklch(85% .05 240);
      --pause-shadow: oklch(30% .03 240 / 0.3);

      --tap: 48px;

      /* NEW: Animation curves */
      --ease-out-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --ease-out-fast: cubic-bezier(0.2, 0, 0.7, 1);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      outline: none; /* Disable default focus outline */
    }

    /* NEW: Brighter, branded focus rings */
    button:focus-visible {
      box-shadow: 0 0 0 3px var(--bg), 0 0 0 5px var(--rate1-brd);
      z-index: 10;
    }

    html, body {
      height: 100%;
    }

    /* ===== GENERAL LAYOUT & CARD ===== */
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      color: var(--text);
      /* NEW: Richer background */
      background-color: var(--bg);
      /* MODIFIED: Darker gradient */
      background-image: radial-gradient(circle at 50% 0%, oklch(12% 0.02 260), var(--bg) 70%);
      display: grid;
      place-items: center;
    }

    .wrap {
      width: min(920px, 94vw);
    }

    .card {
      /* NEW: Richer gradient and border-glow */
      /* MODIFIED: Darker gradient */
      background: linear-gradient(170deg, oklch(13% 0.02 265), var(--bg) 70%);
      border: var(--brd-width) solid var(--brd);
      border-radius: 12px; /* Slightly rounder */
      padding: 24px clamp(16px, 4vw, 28px);
      /* NEW: Multi-layered shadow for "aura" */
      box-shadow: var(--shadow-2),
                  0 0 50px -10px var(--credit-shadow),
                  0 0 50px -10px var(--money-shadow);
      position: relative;
      overflow: clip;
      outline: 1px solid oklch(from var(--brd) l c h / 0.5);
    }

    /* NEW: Pseudo-element for subtle noise texture */
    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='none'/%3E%3Cpath d='M0 0 L100 100 M100 0 L0 100' stroke='oklch(100 0 0 / 0.02)' stroke-width='1'/%3E%3C/svg%3E");
      opacity: 0.5;
      pointer-events: none;
    }

    /* ===== TYPOGRAPHY & HELPERS ===== */
    #gameTimer {
      text-align: center;
      font-size: 20px;
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 8px;
      letter-spacing: 1.5px;
      opacity: .95;
      background: var(--panel-2);
      border: var(--brd-width) solid var(--brd);
      padding: 10px 16px;
      border-radius: 8px; /* Rounder */
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      box-shadow: var(--shadow-1), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
      transition: color 0.3s, background 0.3s, border-color 0.3s, box-shadow 0.3s;
    }

    .goal-text {
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 14px;
      max-width: 50ch; /* NEW: Constrain width */
      margin-left: auto;
      margin-right: auto;
    }

    .goal-text strong {
      color: var(--money-text);
      font-weight: 700;
    }

    .label {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .25px;
      font-weight: 600; /* NEW */
    }

    .value {
      font-size: clamp(20px, 5vw, 30px);
      font-weight: 800;
      line-height: 1.1;
      margin-top: 8px;
    }

    .growth {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800;
      background: var(--panel-2);
      color: var(--muted);
      box-shadow: inset 0 0 0 1px oklch(from var(--brd) l c h / 0.5);
      vertical-align: middle;
    }

    .helper-text {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 8px;
    }
    .helper-text.helper-slot {
      margin-top: 4px;
    }

    /* ===== COMPONENTS: STATS ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px clamp(12px, 3vw, 20px);
      margin-bottom: 20px;
    }

    .stat {
      /* NEW: Gradient background and top/left highlights for 3D effect */
      background: var(--panel);
      border: var(--brd-width) solid var(--brd);
      border-radius: 8px; /* Rounder */
      padding: 14px 16px;
      box-shadow: var(--shadow-1);
      transition: transform 0.2s var(--ease-out-fast), box-shadow 0.2s var(--ease-out-fast);
    }

    /* NEW: Subtle hover effect for stats */
    .stat:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-2);
    }

    /* NEW: Polished Stat Variants */
    .stat.money {
      /* MODIFIED: Darker gradient */
      background: linear-gradient(160deg, var(--money-bg), oklch(40% 0.2 150));
      border-color: var(--money-brd);
      border-top-color: oklch(from var(--money-brd) l c h / 0.7);
      border-left-color: oklch(from var(--money-brd) l c h / 0.7);
    }
    .stat.money .label { color: var(--text); text-shadow: 0 1px 1px rgba(0,0,0,.4); }
    .stat.money .value { color: var(--money-text); text-shadow: 0 1px 1px rgba(0,0,0,.4); }

    .stat.credit {
      /* MODIFIED: Darker gradient */
      background: linear-gradient(160deg, var(--credit-bg), oklch(40% 0.22 315));
      border-color: var(--credit-brd);
      border-top-color: oklch(from var var(--credit-brd) l c h / 0.7);
    }
    .stat.credit .label { color: var(--text); text-shadow: 0 1px 1px rgba(0,0,0,.3); }
    .stat.credit .value { color: var(--credit-text); text-shadow: 0 1px 1px rgba(0,0,0,.3); }

    .stat.rate1 {
      /* MODIFIED: Darker gradient */
      background: linear-gradient(160deg, var(--rate1-bg), oklch(35% 0.18 250));
      border-color: var(--rate1-brd);
    }
    .stat.rate1 .label, .stat.rate1 .value, .stat.rate1 .growth { color: var(--rate1-accent); }

    .stat.rate2 {
      /* MODIFIED: Darker gradient */
      background: linear-gradient(160deg, var(--rate2-bg), oklch(40% 0.18 80));
      border-color: var(--rate2-brd);
    }
    .stat.rate2 .label, .stat.rate2 .value, .stat.rate2 .growth { color: var(--rate2-accent); }

    /* Badge Variants */
    .badge.badge-rate1 {
      background-color: var(--rate1-bg);
      color: var(--rate1-accent);
      border: 1px solid oklch(from var(--rate1-accent) l c h / 0.5);
      box-shadow: none;
    }
    .badge.badge-rate2 {
      background-color: var(--rate2-bg);
      color: var(--rate2-accent);
      border: 1px solid oklch(from var(--rate2-accent) l c h / 0.5);
      box-shadow: none;
    }
    .badge.badge-money {
      background-color: var(--money-bg);
      color: var(--money-text);
      border: 1px solid oklch(from var(--money-brd) l c h / 0.5);
      text-shadow: 0 1px 0 rgba(0,0,0,.45);
      box-shadow: none;
    }
    .badge.badge-credit {
      background-color: var(--credit-bg);
      color: var(--credit-text);
      border: 1px solid oklch(from var(--credit-brd) l c h / 0.5);
      text-shadow: 0 1px 0 rgba(0,0,0,.35);
      box-shadow: none;
    }

    /* ===== COMPONENTS: SLIDER ===== */
    .slider-wrap {
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }

    .slider {
      position: relative;
      height: 64px;
      user-select: none;
      width: min(420px, 88%);
      margin: 0 auto;
      padding: 0 16px;
    }

    .track {
      position: absolute;
      left: 16px;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      height: var(--track-h);
      border-radius: 999px;
      /* NEW: Richer gradient and shadow */
      /* MODIFIED: Darker gradient */
      background: linear-gradient(90deg, oklch(15% 0.03 260), oklch(25% 0.03 260) 60%, oklch(15% 0.03 260));
      outline: 1px solid var(--brd);
      box-shadow: inset 0 1px 2px rgba(0,0,0,.3);
    }

    .ticks {
      position: absolute;
      left: 16px;
      right: 16px;
      font-size: 12px;
      font-weight: 900;
      text-shadow: 0 1px 1px rgba(0,0,0,.5);
    }

    .ticks-top {
      top: 47px;
      color: var(--rate2-accent);
    }

    .ticks-bottom {
      top: 2px;
      color: var(--rate1-accent);
    }

    .thumb {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: var(--thumb-size);
      height: var(--thumb-size);
      border-radius: 4px; /* Slightly rounder */
      cursor: grab;
      /* NEW: More 3D shadow */
      box-shadow: 0 3px 1px rgba(0,0,0,.4), inset 0 1px 1px rgba(255,255,255,.2);
      background: linear-gradient(180deg, #e0e8f0 0%, #b8c8d9 100%);
      /* NEW: Bouncy transition */
      transition: transform 150ms var(--ease-out-bounce), background 0.1s ease-out;
    }

    /* NEW: More exaggerated active state */
    .thumb:active, .thumb:focus {
      transform: translate(-50%, -50%) scale(1.3);
      background: linear-gradient(180deg, #f0f4f8 0%, #c8d8e8 100%);
      cursor: grabbing;
      z-index: 10;
    }

    /* ===== COMPONENTS: CONTROLS & BUTTONS ===== */
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    /* Base control button style */
    button.ctrl {
      background: var(--panel);
      color: var(--text);
      border: var(--brd-width) solid var(--brd);
      border-radius: 8px; /* Rounder */
      padding: 10px 12px;
      font-weight: 800;
      font-size: 14px;
      cursor: pointer;
      min-height: var(--tap);
      /* NEW: Bouncy transitions, added shadow */
      transition: transform 150ms var(--ease-out-bounce),
                  filter 150ms var(--ease-out-fast),
                  background 0.2s,
                  box-shadow 150ms var(--ease-out-fast);
      box-shadow: 0 2px 0 oklch(from var(--brd) l c h / 0.5),
                  0 4px 6px -2px rgba(0,0,0,.3),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
    }

    .ctrl-fixed {
      width: 96px;
      padding: 10px 12px;
      font-size: 13px;
      flex-shrink: 0;
    }

    /* NEW: Hover state for all control buttons */
    button.ctrl:not(:disabled):hover {
      transform: scale(1.05);
      filter: brightness(1.15);
      box-shadow: 0 2px 0 oklch(from var(--brd) l c h / 0.5),
                  0 6px 10px -2px rgba(0,0,0,.3),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }

    /* NEW: Exaggerated "pushed in" active state */
    button.ctrl:not(:disabled):active {
      transform: scale(0.95);
      filter: brightness(0.9);
      /* Looks "pushed in" */
      box-shadow: 0 1px 0 oklch(from var(--brd) l c h / 0.5),
                  0 1px 2px -1px rgba(0,0,0,.2),
                  inset 0 2px 3px rgba(0,0,0,.2);
      transition-duration: 50ms; /* Faster "push" */
    }

    /* NEW: Colored shadows for themed buttons */
    #swapBtn:not(:disabled):hover {
      box-shadow: 0 2px 0 var(--brd-strong),
                  0 6px 10px -2px var(--credit-shadow),
                  0 6px 10px -2px var(--money-shadow),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }
    #spin:not(:disabled):hover {
      box-shadow: 0 2px 0 var(--money-brd),
                  0 6px 12px -2px var(--money-shadow),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }
    #buyBtn:not(:disabled):hover {
      box-shadow: 0 2px 0 var(--credit-brd),
                  0 6px 12px -2px var(--credit-shadow),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }
    #upgradeBtn:not(:disabled):hover {
      box-shadow: 0 2px 0 var(--upgrade-brd),
                  0 6px 12px -2px var(--upgrade-shadow),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }
    #pause:not(:disabled):hover {
       box-shadow: 0 2px 0 var(--pause-brd),
                  0 6px 12px -2px var(--pause-shadow),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }

    /* Themed button styles */
    #swapBtn {
      /* NEW: Gradient transition */
      background: linear-gradient(90deg, var(--credit-bg) 0%, var(--credit-bg) 50%, var(--money-bg) 50%, var(--money-bg) 100%);
      background-size: 200% 100%;
      background-position: 0% 50%;
      border-color: var(--brd-strong);
      /* Merged transition */
      transition: background-position 0.3s ease-out, opacity 0.2s, transform 150ms var(--ease-out-bounce), filter 150ms var(--ease-out-fast), box-shadow 150ms var(--ease-out-fast);
    }

    /* NEW: Swap hover/active backgrounds */
    #swapBtn:not(:disabled):hover {
      background-position: 100% 50%;
    }
    #swapBtn:not(:disabled):active {
      background-position: 100% 50%;
      filter: brightness(0.9);
    }

    /* NEW: Themed colors for Upgrade/Pause */
    #upgradeBtn {
      background: var(--upgrade-bg);
      border-color: var(--upgrade-brd);
      color: var(--upgrade-text);
      box-shadow: 0 2px 0 var(--upgrade-brd), 0 4px 6px -2px var(--upgrade-shadow), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
    }

    #pause {
      background: var(--pause-bg);
      border-color: var(--pause-brd);
      color: var(--pause-text);
      box-shadow: 0 2px 0 var(--pause-brd), 0 4px 6px -2px var(--pause-shadow), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
    }

    button.ctrl-buy {
      background: var(--credit-bg);
      border-color: var(--credit-brd);
      color: var(--text);
      padding: 10px 16px;
      font-size: 16px;
      font-weight: 800;
      line-height: 1.4;
      text-align: center;
      box-shadow: 0 2px 0 var(--credit-brd), 0 4px 6px -2px var(--credit-shadow), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
    }

    #spin.ctrl {
      background: var(--money-bg);
      border-color: var(--money-brd);
      color: var(--text);
      padding: 10px 16px;
      font-size: 16px;
      font-weight: 800;
      line-height: 1.4;
      text-align: center;
      box-shadow: 0 2px 0 var(--money-brd), 0 4px 6px -2px var(--money-shadow), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
    }

    /* Disabled styles (User request: keep visual, just change cursor) */
    #upgradeBtn:disabled,
    #pause:disabled,
    #buyBtn:disabled {
      opacity: 1; /* Keep visible */
      cursor: not-allowed;
    }
    #swapBtn:disabled {
      cursor: not-allowed;
    }

    /* New styles for text inside buttons */
    .ctrl small {
      font-size: 11px;
      font-weight: 600;
      color: oklch(from var(--text) l c h / 0.8);
      text-shadow: 0 1px 1px rgba(0,0,0,.2); /* NEW */
      letter-spacing: 0.25px;
      display: block; /* Makes it stack */
      margin-top: 4px; /* Space between lines */
    }

    /* Adjust badge size within buttons */
    .ctrl .badge {
      font-size: 10px;
      padding: 1px 6px;
      vertical-align: baseline; /* Better alignment */
    }

    /* ===== COMPONENTS: SLOT & REELS ===== */
    .slot {
      margin-top: 24px;
      padding-top: 20px;
      border-top: var(--brd-width) solid var(--brd);
    }

    .slot h2 {
      margin: 0 0 6px 0;
      font-size: clamp(16px, 2.6vw, 22px);
      font-weight: 900;
    }

    .reels {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 16px 0;
    }

    .reel {
      /* NEW: Richer background and inset shadow */
      /* MODIFIED: Darker gradient */
      background: radial-gradient(circle at 50% 50%, oklch(20% 0.02 260), oklch(8% 0.01 260) 80%);
      border: var(--brd-width) solid var(--brd);
      border-radius: 8px; /* Rounder */
      height: 96px;
      display: grid;
      place-items: center;
      font-size: clamp(40px, 6vw, 56px);
      /* NEW: Stronger inset shadow */
      box-shadow: var(--shadow-1), inset 0 4px 8px rgba(0,0,0,.3);
      transition: filter 0.05s, transform 0.1s; /* NEW: Added transform */
    }

    .slot-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }

    /* ===== COMPONENTS: MODALS ===== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5); /* Darker */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      backdrop-filter: blur(8px); /* More blur */
    }

    .modal-backdrop-noblur {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .7); /* Darker */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .modal {
      /* NEW: Richer gradient */
      /* MODIFIED: Darker gradient */
      background: linear-gradient(160deg, oklch(18% 0.02 260), oklch(10% 0.01 260));
      border: var(--brd-width) solid var(--brd-strong);
      border-radius: 12px; /* Rounder */
      width: min(420px, 92vw);
      padding: 24px; /* More padding */
      /* NEW: Deeper shadow */
      box-shadow: 0 20px 50px rgba(0,0,0,.6), 0 0 0 1px var(--brd-strong);
      /* NEW: Entry animation */
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.2s var(--ease-out-fast), opacity 0.2s ease-out;
    }

    /* NEW: Modal open animation */
    .modal-backdrop[style*="display: flex"] .modal,
    .modal-backdrop-noblur[style*="display: flex"] .modal {
      transform: scale(1);
      opacity: 1;
    }

    .modal h3 {
      margin: 0 0 8px 0;
      font-size: 20px; /* Larger */
      text-align: center;
    }

    .modal p {
      margin: 0 0 16px 0; /* More space */
      color: var(--muted);
      font-size: 14px;
      text-align: center; /* NEW */
      line-height: 1.5; /* NEW */
    }

    .modal .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    /* Modal Buttons */
    .btn {
      appearance: none;
      border: 2px solid transparent;
      border-radius: 8px; /* Rounder */
      padding: 14px 16px;
      font-weight: 900;
      font-size: 16px;
      cursor: pointer;
      min-height: 48px;
      /* NEW: Bouncy transitions, added shadow */
      transition: transform 150ms var(--ease-out-bounce),
                  filter 150ms var(--ease-out-fast),
                  background 0.2s,
                  border-color 0.2s,
                  box-shadow 150ms var(--ease-out-fast);
      box-shadow: 0 2px 0 oklch(from var(--brd) l c h / 0.5),
                  0 4px 6px -2px rgba(0,0,0,.3),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
    }

    .btn.primary {
      background: oklch(55% .18 160);
      border-color: oklch(70% .2 160);
      color: #fff;
      text-shadow: 0 1px 1px rgba(0,0,0,.3);
      box-shadow: 0 2px 0 oklch(70% .2 160), 0 4px 6px -2px oklch(55% .18 160 / 0.4), inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }

    .btn.secondary {
      background: var(--panel-2);
      border-color: var(--brd-strong);
      color: var(--text);
    }

    /* NEW: Hover/Active for modal buttons */
    .btn:not(:disabled):hover {
      transform: scale(1.05);
      filter: brightness(1.15);
      box-shadow: 0 2px 0 oklch(from var(--brd) l c h / 0.5),
                  0 6px 10px -2px rgba(0,0,0,.3),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }

    .btn.primary:not(:disabled):hover {
      box-shadow: 0 2px 0 oklch(70% .2 160),
                  0 6px 12px -2px oklch(55% .18 160 / 0.5),
                  inset 0 1px 0 oklch(from var(--text) l c h / 0.1);
    }

    .btn:not(:disabled):active {
      transform: scale(0.95);
      filter: brightness(0.9);
      box-shadow: 0 1px 0 oklch(from var(--brd) l c h / 0.5),
                  0 1px 2px -1px rgba(0,0,0,.2),
                  inset 0 2px 3px rgba(0,0,0,.2);
      transition-duration: 50ms;
    }

    .btn.primary:not(:disabled):active {
      background: oklch(50% .18 160);
      border-color: oklch(65% .2 160);
    }

    .btn.secondary:not(:disabled):active {
      background: var(--panel);
      border-color: var(--brd-strong);
    }

    /* Modal Upgrade Options */
    .modal .upgrade-option p {
      margin: 0 0 12px 0;
      color: var(--text);
      font-size: 15px;
      line-height: 1.4;
      text-align: center;
    }

    .modal .upgrade-option p small {
      color: var(--muted);
      font-size: 12px;
    }

    .modal .upgrade-option .btn {
      width: 100%;
    }

    .modal .upgrade-option .btn .badge {
      font-size: 11px;
      padding: 2px 7px;
      vertical-align: baseline;
      margin: 0 2px;
    }

    .modal .upgrade-option .btn .badge.badge-rate1 {
      background-color: var(--rate1-bg);
      color: var(--rate1-accent);
      border: 1px solid oklch(from var(--rate1-accent) l c h / 0.5);
    }

    .modal .upgrade-option .btn .badge.badge-rate2 {
      background-color: var(--rate2-bg);
      color: var(--rate2-accent);
      border: 1px solid oklch(from var(--rate2-accent) l c h / 0.5);
    }

    .modal .upgrade-option .btn .badge.badge-money {
      background-color: var(--money-bg);
      color: var(--money-text);
      border: 1px solid oklch(from var(--money-brd) l c h / 0.5);
      text-shadow: 0 1px 0 rgba(0,0,0,.45);
    }

    .modal .upgrade-option .btn .badge.badge-credit {
      background-color: var(--credit-bg);
      color: var(--credit-text);
      border: 1px solid oklch(from var(--credit-brd) l c h / 0.5);
    }

    /* ===== STATES & ANIMATIONS ===== */
    #confettiCanvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      display: none;
    }

    /* NEW: More vibrant timer warning */
    @keyframes flashRed {
      0%, 100% {
        color: oklch(90% .25 25);
        background: oklch(30% .1 25);
        border-color: oklch(60% .25 25);
        box-shadow: 0 0 10px 2px oklch(60% .25 25 / 0.5), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
      }
      50% {
        color: var(--text);
        background: var(--panel-2);
        border-color: var(--brd);
        box-shadow: var(--shadow-1), inset 0 1px 0 oklch(from var(--text) l c h / 0.05);
      }
    }

    .timer-warning {
      animation: flashRed 1.2s infinite steps(1);
    }

    /* NEW: More vibrant win pulse */
    @keyframes winPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: var(--shadow-1), inset 0 4px 8px rgba(0,0,0,.3);
        border-color: var(--brd);
      }
      50% {
        transform: scale(1.05);
        border-color: #ffdd57; /* Bright gold */
        box-shadow: 0 0 20px 8px #ffdd57, inset 0 2px 4px rgba(0,0,0,.3);
      }
    }

    .reel-win {
      animation: winPulse 0.5s 2;
    }

    /* NEW STYLE FOR SPINNING */
    .reel-spinning {
      filter: blur(4px); /* More blur */
      transform: scale(0.95); /* Add a subtle "pull-back" */
      transition: filter 0.05s, transform 0.05s;
    }

    /* ===== MEDIA QUERIES ===== */
    @media (max-width: 640px) {
      .wrap {
        width: 100vw;
      }
      .card {
        border-radius: 0;
        border-left: none;
        border-right: none;
        padding: max(12px, env(safe-area-inset-top)) max(12px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(12px, env(safe-area-inset-left));
        box-shadow: var(--shadow-2); /* NEW: Remove side-glows on mobile */
      }
      .value {
        font-size: clamp(20px, 6.5vw, 28px);
        margin-top: 6px;
      }
      .slot-actions {
        grid-template-columns: 1fr;
        gap: 8px;
        margin-top: 12px;
      }
      .controls {
        gap: 8px;
        margin-top: 10px;
        flex-wrap: wrap;
      }
      .reel {
        height: 100px;
        font-size: clamp(44px, 14vw, 72px);
      }
      .modal {
        width: min(500px, 96vw);
        padding: 16px; /* NEW: Adjust padding */
      }
      .modal .actions {
        grid-template-columns: 1fr;
      }
      .btn {
        font-size: 18px;
        padding: 16px 18px;
        min-height: 56px;
      }
      #gameTimer {
        margin-bottom: 6px;
      }
      .goal-text {
        margin-bottom: 10px;
      }
      .stats-grid {
        gap: 10px;
        margin-bottom: 16px;
      }
      .stat {
        padding: 12px 14px;
      }
      .controls {
        gap: 8px;
        margin-top: 16px;
        flex-wrap: wrap;
      }
        margin-top: 4px;
      }
      .slot {
        margin-top: 16px;
        padding-top: 16px;
      }
      .slot h2 {
        margin-bottom: 6px;
      }
      .reels {
        gap: 8px;
        margin: 12px 0;
      }
    }

    /* NEW: Reduce motion but keep color changes */
    @media (prefers-reduced-motion: reduce) {
      .reel-spinning {
        filter: blur(1px);
        transform: none;
      }
      .reel-win,
      .timer-warning {
        animation-duration: 3s !important; /* Slow down flashes */
      }
      /* Disable all other transitions and transforms */
      .card, .stat, .thumb, button.ctrl, .btn, .modal {
        transition: background 0.2s, color 0.2s, border-color 0.2s, filter 0.2s, box-shadow 0.2s, opacity 0.2s;
        transform: none !important;
        animation: none !important;
      }
      button.ctrl:not(:disabled):hover,
      .btn:not(:disabled):hover {
        transform: none !important;
        filter: brightness(1.15);
      }
      button.ctrl:not(:disabled):active,
      .btn:not(:disabled):active {
        transform: none !important;
        filter: brightness(0.9);
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div id="gameTimer">20:00</div>
      <div class="goal-text">If you can earn <strong>ONE MILLION DOLLARS</strong> before the clock runs out, you get to keep it. Any less, you win nothing.</div>

      <div class="stats-grid">
        <div class="stat money"><div class="label">Money</div><div class="value" id="val1">$0.00</div></div>
        <div class="stat credit"><div class="label">Credit</div><div class="value" id="val2">0.00</div></div>
        <div class="stat rate1"><div class="label">Rate 1</div><div class="value"><span id="rate1">3.00</span></div></div>
        <div class="stat rate2"><div class="label">Rate 2</div><div class="value"><span id="rate2">3.00</span></div></div>
      </div>

      <div class="slider-wrap">
        <div class="slider" id="uniSlider" role="group" aria-label="Growth slider">
          <div class="track"></div>
          <div class="thumb" id="thumb" role="slider" aria-valuemin="2" aria-valuemax="12" aria-valuenow="2" aria-valuetext="2" tabindex="0"></div>
          <div class="ticks ticks-top" id="ticksTop"></div>
          <div class="ticks ticks-bottom" id="ticksBottom"></div>
        </div>
      </div>
      <!-- MODIFIED: Removed helper text -->

      <div class="controls">
        <button class="ctrl ctrl-fixed" id="swapBtn">Swap</button>
        <button class="ctrl ctrl-fixed" id="pause">Pause</button>
        <button class="ctrl ctrl-fixed" id="upgradeBtn">Upgrade</button>
      </div>

      <section class="slot" aria-label="3-reel slot machine">
        <h2>3‚ÄëReel Slot</h2>
        <!-- Removed helper-slot paragraph -->
        <div class="reels">
          <div class="reel" id="reel1">üçí</div>
          <div class="reel" id="reel2">üçã</div>
          <div class="reel" id="reel3">üçá</div>
        </div>
        <div class="slot-actions">
          <!-- Removed .action wrappers and span elements -->
          <button class="ctrl" id="spin">Spin</button>
          <!-- CHANGE: Updated text to 7x -->
          <button class="ctrl ctrl-buy" id="buyBtn">Buy 7x üíé</button>
        </div>
      </section>

      <!-- REMOVED: section.summary#runSummary -->

    </div>
  </div>

  <div class="modal-backdrop" id="winModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="winTitle" aria-describedby="winDesc">
      <h3 id="winTitle">3‚Äëof‚Äëa‚Äëkind!</h3>
      <p id="winDesc">Choose your reward to continue.</p>
      <div class="actions">
        <button class="btn secondary" id="reduceBtn">Lower spin cost by 0.1 Rate Point</button>
        <!-- REMOVED: Deleted the reduceRate2Btn -->
        <button class="btn primary" id="takeMoneyBtn">Take $600</button>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" id="upgradeModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="upgradeTitle">
      <h3 id="upgradeTitle">Upgrades</h3>
      <div class="upgrade-option">
        <p>Wins (without üíé) reset Spin cost to $50.<br><small>(One-time purchase)</small></p>
        <button class="btn primary" id="buyResetSpinCost">
          <span class="badge badge-money">$5,000</span> + <span class="badge badge-rate1">10 Rate 1</span>
        </button>
      </div>
      <hr style="border:0; border-top: 1px solid var(--brd); margin: 20px 0;">
      <div class="upgrade-option">
        <!-- MODIFICATION: Updated upgrade text -->
        <p>Double all slider values.<br><small>(One-time purchase)</small></p>
        <button class="btn primary" id="buyDoubleSlider">
          <span class="badge badge-credit">15,000 C</span> + <span class="badge badge-rate2">15 Rate 2</span>
        </button>
      </div>
      <div class="actions" style="margin-top: 20px; grid-template-columns: 1fr;">
        <button class="btn secondary" id="closeUpgradeModal">Close</button>
      </div>
    </div>
  </div>

  <!-- NEW: Final Win Modal -->
  <div class="modal-backdrop-noblur" id="finalWinModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="finalWinTitle">
      <h3 id="finalWinTitle" style="text-align: center; font-size: 24px; color: var(--money-text);">Congratulations!</h3>
      <p style="text-align: center; font-size: 18px; line-height: 1.6; color: var(--text); margin: 20px 0;">
        You've succeeded in earning ONE MILLION DOLLARS!<br>Your check is in the mail! ‚úâÔ∏è üèÜ ü•≥
      </p>
    </div>
  </div>


  <canvas id="confettiCanvas"></canvas>

  <script>
  // REFACTOR: Encapsulated all game logic in an IIFE and a Game class
  // for better organization and to prevent global scope pollution.
  (function() {
    "use strict";

    // ===== CONFIG =====
    const MAX_RATE = 199;
    const SPIN_DOLLAR_COST = 50;
    const BUY_DIAMOND_COST = 500;
    const BUY_DIAMOND_RATE_COST = 1.0;
    const GAME_DURATION_SECONDS = 20 * 60; // 20 minutes
    const WIN_AMOUNT = 1000000; // NEW: Win amount constant

    // Slider growth steps (bottom = Rate 1 growth, top = Rate 2 growth)
    let growStepsBottom = [12, 10, 8, 6, 4, 2];
    let growStepsTop = [2, 4, 6, 8, 10, 12];
    const STEP_COUNT = growStepsBottom.length;
    const BASE_SYMBOLS = ['üçí','üçã','üçá','üçâ','üçä'];

    /**
     * @class Game
     * @description Encapsulates all state and logic for the slot game.
     */
    class Game {
      // ===== DOM ELEMENTS =====
      // (Initialized in constructor)

      // ===== STATE =====
      // (Initialized in constructor)

      constructor(elements) {
        // ===== DOM ELEMENTS =====
        this.dom = elements;
        this.confettiCtx = this.dom.confettiCanvas.getContext('2d');
        this.reelEls = [this.dom.reel1, this.dom.reel2, this.dom.reel3];
        
        // ===== STATE =====
        this.value1 = 0;
        this.value2 = 0;
        this.rate1 = 3;
        this.rate2 = 3;
        this.gameTimeSeconds = GAME_DURATION_SECONDS;
        this.grow1 = growStepsBottom[0];
        this.grow2 = growStepsTop[0];
        this.swapUses = 2;

        this.spinDollarCost = SPIN_DOLLAR_COST;
        this.spinRateCost = 1.0;
        this.winMoneyReward = 600;

        this.buyDiamondCost = BUY_DIAMOND_COST;
        this.buyDiamondRateCost = BUY_DIAMOND_RATE_COST;

        this.symbols = [...BASE_SYMBOLS];
        this.diamondCount = 0;
        this.running = true;
        this.modalOpen = false;

        this.isSpinCostResetPurchased = false;
        this.isSliderDoubledPurchased = false;

        this.totalSpins = 0;
        this.totalWins = 0;

        this.confettiParticles = [];
        this.confettiAnimationId = null;
        this.lastTs = undefined;

        // Bind 'this' for requestAnimationFrame
        this.boundTick = this.#tick.bind(this);
      }
      
      // ===== PUBLIC INIT =====
      
      init() {
        this.#initSlider();
        this.#updateCostMsg();
        this.#updateBuyBtnUI();
        this.#initControls();
        requestAnimationFrame(this.boundTick);
      }

      // ===== UTILS (Private) =====
      #clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
      #fmt(n) { return n.toFixed(2); }
      #fmtRatePts(x) { return x.toFixed(1); }
      #fmtTime(t) {
        const s = Math.floor(t), m = Math.floor(s / 60), sec = s % 60;
        return [m, sec].map(v => String(v).padStart(2, '0')).join(':');
      }

      // ===== CONFETTI (Private) =====
      #startConfetti() {
        this.dom.confettiCanvas.style.display = 'block';
        this.confettiParticles = [];
        this.confettiCtx.clearRect(0, 0, this.dom.confettiCanvas.width, this.dom.confettiCanvas.height);
        const colors = [
          'oklch(80% .2 150)', '#e91e63', 'oklch(80% .25 315)', '#673ab7',
          'oklch(85% .25 250)', '#2196f3', 'oklch(90% .22 200)', '#00bcd4',
          '#4caf50', '#cddc39', '#ffeb3b', '#ff9800',
          'oklch(90% 0.22 90)', 'oklch(80% 0.2 80)'
        ];
        const particleCount = 200;

        this.dom.confettiCanvas.width = window.innerWidth;
        this.dom.confettiCanvas.height = window.innerHeight;

        for (let i = 0; i < particleCount; i++) {
          this.confettiParticles.push({
            x: Math.random() * this.dom.confettiCanvas.width,
            y: Math.random() * this.dom.confettiCanvas.height - this.dom.confettiCanvas.height,
            size: Math.random() * 5 + 2,
            color: colors[Math.floor(Math.random() * colors.length)],
            vx: Math.random() * 6 - 3,
            vy: Math.random() * 5 + 3,
            opacity: 1,
          });
        }
        this.#animateConfetti();
      }

      #animateConfetti() {
        this.confettiCtx.clearRect(0, 0, this.dom.confettiCanvas.width, this.dom.confettiCanvas.height);

        this.confettiParticles.forEach((p, index) => {
          p.x += p.vx;
          p.y += p.vy;
          p.opacity -= 0.005;

          if (p.y > this.dom.confettiCanvas.height || p.opacity <= 0) {
            this.confettiParticles.splice(index, 1);
          } else {
            this.confettiCtx.globalAlpha = p.opacity;
            this.confettiCtx.fillStyle = p.color;
            this.confettiCtx.fillRect(p.x, p.y, p.size, p.size * 2);
            this.confettiCtx.globalAlpha = 1;
          }
        });

        if (this.confettiParticles.length > 0) {
          this.confettiAnimationId = requestAnimationFrame(this.#animateConfetti.bind(this));
        } else {
          this.#stopConfetti();
        }
      }

      #stopConfetti() {
        if (this.confettiAnimationId) {
          cancelAnimationFrame(this.confettiAnimationId);
        }
        this.dom.confettiCanvas.style.display = 'none';
        this.confettiCtx.clearRect(0, 0, this.dom.confettiCanvas.width, this.dom.confettiCanvas.height);
        this.confettiParticles = [];
      }

      #initConfettiResizeListener() {
         window.addEventListener('resize', () => {
          if (this.dom.confettiCanvas.style.display === 'block') {
            this.dom.confettiCanvas.width = window.innerWidth;
            this.dom.confettiCanvas.height = window.innerHeight;
          }
        });
      }

      // ===== UI UPDATE HELPERS (Private) =====
      #updateCostMsg() {
        if (this.spinRateCost <= 0) {
          this.dom.spinBtn.innerHTML = `Spin<br><small><span class="badge badge-money">$${this.spinDollarCost}</span></small>`;
        } else {
          this.dom.spinBtn.innerHTML = `Spin<br><small><span class="badge badge-money">$${this.spinDollarCost}</span> + <span class="badge badge-rate1">${this.#fmtRatePts(this.spinRateCost)} Rate 1</span></small>`;
        }
      }

      #updateBuyBtnUI() {
        if (this.diamondCount > 0) {
          this.dom.buyBtn.innerHTML = `üíé Active<br><small>(${this.diamondCount} left)</small>`;
          this.dom.buyBtn.disabled = true;
        } else {
          this.dom.buyBtn.innerHTML = `Buy 7x üíé<br><small><span class="badge badge-credit">${this.buyDiamondCost}c</span> + <span class="badge badge-rate2">${this.buyDiamondRateCost.toFixed(1)} Rate 2</span></small>`;
          this.dom.buyBtn.disabled = false;
        }
      }

      #updateReadout() {
        if (this.gameTimeSeconds > 0 || this.running) {
          this.dom.gameTimerEl.textContent = this.#fmtTime(this.gameTimeSeconds);
        }
        this.dom.val1El.textContent = `$${this.#fmt(this.value1)}`;
        this.dom.val2El.textContent = this.#fmt(this.value2);
        this.dom.rate1El.textContent = this.#fmt(this.rate1);
        this.dom.rate2El.textContent = this.#fmt(this.rate2);
      }

      // ===== SLIDER (Private) =====
      #buildTicks() {
        this.dom.ticksBottomEl.innerHTML = '';
        this.dom.ticksTopEl.innerHTML = '';

        const createTicks = (parentElement, steps) => {
          steps.forEach((value, idx) => {
            const s = document.createElement('span');
            s.textContent = value;
            s.style.position = 'absolute';

            const pct = (STEP_COUNT <= 1) ? 0 : (idx / (STEP_COUNT - 1));
            s.style.left = `${pct * 100}%`;

            if (idx === 0) {
              s.style.transform = 'translateX(0)';
            } else if (idx === STEP_COUNT - 1) {
              s.style.transform = 'translateX(-100%)';
            } else {
              s.style.transform = 'translateX(-50%)';
            }
            parentElement.appendChild(s);
          });
        };

        createTicks(this.dom.ticksBottomEl, growStepsBottom);
        createTicks(this.dom.ticksTopEl, growStepsTop);
      }

      #sliderInnerRect() {
        const r = this.dom.slider.getBoundingClientRect();
        const left = r.left + 16, right = r.right - 16, width = Math.max(0, right - left);
        return { left, right, width };
      }

      #positionHandleByIndex(idx) {
        const { left, width } = this.#sliderInnerRect();
        const pct = (STEP_COUNT <= 1) ? 0 : idx / (STEP_COUNT - 1);
        const x = left + pct * width;
        this.dom.thumb.style.left = `${x - this.dom.slider.getBoundingClientRect().left}px`;
        const val = growStepsBottom[idx];
        this.dom.thumb.setAttribute('aria-valuenow', String(val));
        this.dom.thumb.setAttribute('aria-valuetext', String(val));
      }

      #nearestIndexFromClientX(xc) {
        const { left, width } = this.#sliderInnerRect();
        const x = this.#clamp(xc - left, 0, width);
        const pct = width === 0 ? 0 : x / width;
        return this.#clamp(Math.round(pct * (STEP_COUNT - 1)), 0, STEP_COUNT - 1);
      }

      #setGrowthByIndex(idx) {
        const v1 = growStepsBottom[idx];
        const v2 = growStepsTop[idx];
        this.grow1 = v1; this.grow2 = v2;
        this.#positionHandleByIndex(idx);
      }

      #currentIndex() { return Math.max(0, growStepsBottom.indexOf(this.grow1)); }

      #initSlider() {
        this.#buildTicks();
        this.#setGrowthByIndex(0);
        let dragging = false;
        
        const onDown = (ev) => { if (this.modalOpen) return; dragging = true; this.dom.thumb.focus(); const c = ('touches' in ev) ? ev.touches[0].clientX : ev.clientX; this.#setGrowthByIndex(this.#nearestIndexFromClientX(c)); ev.preventDefault(); };
        const onMove = (ev) => { if (!dragging || this.modalOpen) return; const c = ('touches' in ev) ? ev.touches[0].clientX : ev.clientX; this.#setGrowthByIndex(this.#nearestIndexFromClientX(c)); };
        const onUp = () => { dragging = false; };
        
        this.dom.thumb.addEventListener('mousedown', onDown);
        this.dom.thumb.addEventListener('touchstart', onDown, { passive: false });
        window.addEventListener('mousemove', onMove);
        window.addEventListener('touchmove', onMove, { passive: false });
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchend', onUp);
        
        this.dom.slider.addEventListener('mousedown', (ev) => { if (ev.target === this.dom.thumb || this.modalOpen) return; const c = ev.clientX; this.#setGrowthByIndex(this.#nearestIndexFromClientX(c)); });
        this.dom.slider.addEventListener('touchstart', (ev) => { if (ev.target === this.dom.thumb || this.modalOpen) return; const c = ev.touches[0].clientX; this.#setGrowthByIndex(this.#nearestIndexFromClientX(c)); }, { passive: false });
        
        this.dom.thumb.addEventListener('keydown', (e) => {
          if (this.modalOpen) return;
          let idx = this.#currentIndex();
          if (e.key === 'ArrowLeft') { idx = this.#clamp(idx - 1, 0, STEP_COUNT - 1); this.#setGrowthByIndex(idx); e.preventDefault(); }
          if (e.key === 'ArrowRight') { idx = this.#clamp(idx + 1, 0, STEP_COUNT - 1); this.#setGrowthByIndex(idx); e.preventDefault(); }
          if (e.key === 'Home') { this.#setGrowthByIndex(0); e.preventDefault(); }
          if (e.key === 'End') { this.#setGrowthByIndex(STEP_COUNT - 1); e.preventDefault(); }
        });
        
        const ro = new ResizeObserver(() => this.#positionHandleByIndex(this.#currentIndex()));
        ro.observe(this.dom.slider);
      }

      // ===== MODALS (Private) =====
      #openWinChoice(payout, isBonus) {
        return new Promise((resolve) => {
          this.modalOpen = true;

          const winDescEl = document.getElementById('winDesc'); // Local lookup is fine here
          if (isBonus) {
            winDescEl.innerHTML = `A <strong style="color:var(--money-text)">2x Bonus</strong> hit! Choose your reward to continue.`;
          }

          if (isBonus) {
            this.dom.takeMoneyBtn.innerHTML = `Take $${payout} <span style="color: var(--money-text); font-weight: 800; background: var(--money-bg); border-radius: 6px; padding: 2px 6px; font-size: 0.8em; margin-left: 4px; border: 1px solid var(--money-brd);">(2x)</span>`;
          } else {
            this.dom.takeMoneyBtn.textContent = `Take $${payout}`;
          }

          let focusables;
          if (this.spinRateCost <= 0) {
            this.dom.reduceBtn.style.display = 'none';
            focusables = [this.dom.takeMoneyBtn];
          } else {
            this.dom.reduceBtn.style.display = 'block';
            focusables = [this.dom.reduceBtn, this.dom.takeMoneyBtn];
          }

          this.dom.backdrop.style.display = 'flex';
          this.dom.backdrop.setAttribute('aria-hidden', 'false');

          let idx = 0; focusables[idx].focus();
          const onKey = (e) => { if (e.key === 'Tab') { e.preventDefault(); idx = (idx + (e.shiftKey ? -1 : 1) + focusables.length) % focusables.length; focusables[idx].focus(); } if (e.key === 'Escape') { e.preventDefault(); } };
          document.addEventListener('keydown', onKey);

          const cleanup = () => {
            document.removeEventListener('keydown', onKey);
            this.dom.backdrop.style.display = 'none';
            this.dom.backdrop.setAttribute('aria-hidden', 'true');
            this.modalOpen = false;
            this.dom.reduceBtn.style.display = 'block';
            winDescEl.innerHTML = 'Choose your reward to continue.';
            this.dom.takeMoneyBtn.innerHTML = '';
          };

          this.dom.reduceBtn.onclick = () => { cleanup(); resolve('reduce'); };
          this.dom.takeMoneyBtn.onclick = () => { cleanup(); resolve('money'); };
        });
      }

      #openUpgradeModal() {
        this.modalOpen = true;
        this.dom.upgradeModalBackdrop.style.display = 'flex';
        this.dom.upgradeModalBackdrop.setAttribute('aria-hidden', 'false');

        this.dom.buyResetSpinCostBtn.disabled = this.isSpinCostResetPurchased;
        if (this.isSpinCostResetPurchased) {
          this.dom.buyResetSpinCostBtn.textContent = "Purchased";
        } else {
          this.dom.buyResetSpinCostBtn.innerHTML = `<span class="badge badge-money">$5,000</span> + <span class="badge badge-rate1">10 Rate 1</span>`;
        }

        let remaining = !this.isSliderDoubledPurchased;
        this.dom.buyDoubleSliderBtn.disabled = !remaining;
        if (!remaining) {
          this.dom.buyDoubleSliderBtn.textContent = "Purchased";
        } else {
          this.dom.buyDoubleSliderBtn.innerHTML = `<span class="badge badge-credit">15,000 C</span> + <span class="badge badge-rate2">15 Rate 2</span>`;
        }

        this.dom.closeUpgradeModalBtn.focus();
      }

      #closeUpgradeModal() {
        this.modalOpen = false;
        this.dom.upgradeModalBackdrop.style.display = 'none';
        this.dom.upgradeModalBackdrop.setAttribute('aria-hidden', 'true');
      }

      #showFinalWinModal() {
        this.modalOpen = true;
        this.dom.finalWinModalBackdrop.style.display = 'flex';
        this.dom.finalWinModalBackdrop.setAttribute('aria-hidden', 'false');
        this.#startConfetti();
      }

      // ===== SLOT / SPIN (Private) =====
      #visualSymbol() { return this.symbols[Math.floor(Math.random() * this.symbols.length)]; }

      #animateReel(reelEl, finalSymbol, duration) {
        return new Promise(resolve => {
          reelEl.classList.add('reel-spinning');
          const spinInterval = setInterval(() => {
            reelEl.textContent = this.#visualSymbol();
          }, 50);

          setTimeout(() => {
            clearInterval(spinInterval);
            reelEl.classList.remove('reel-spinning');
            reelEl.textContent = finalSymbol;

            if (typeof reelEl.animate === 'function') {
              reelEl.animate([
                { transform: 'scale(1.3) rotate(-5deg)', opacity: 0.8 },
                { transform: 'scale(1.0) rotate(0deg)', opacity: 1.0 }
              ], { duration: 250, easing: 'cubic-bezier(0.175, 0.885, 0.32, 1.275)' });
            }
            resolve();
          }, duration);
        });
      }

      #getReelSymbol() {
        let s = this.symbols[Math.floor(Math.random() * this.symbols.length)];
        if (s === 'üíé') {
          if (this.diamondCount > 0) {
            return 'üíé';
          } else {
            return BASE_SYMBOLS[Math.floor(Math.random() * BASE_SYMBOLS.length)];
          }
        }
        return s;
      }

      async #spinOnce() {
        if (!this.dom.spinBtn || this.dom.spinBtn.disabled || this.modalOpen) return;
        if (this.value1 < this.spinDollarCost || this.rate1 < this.spinRateCost) {
          if (typeof this.dom.spinBtn.animate === 'function') {
            this.dom.spinBtn.animate([
              { transform: 'scale(1.05) rotate(0deg)' },
              { transform: 'scale(1.05) rotate(-3deg)' },
              { transform: 'scale(1.05) rotate(3deg)' },
              { transform: 'scale(1.05) rotate(0deg)' }
            ], { duration: 200, easing: 'cubic-bezier(.2,.0,.5,3)' });
          }
          return;
        }

        this.totalSpins++;
        this.value1 -= this.spinDollarCost;
        this.rate1 = Math.max(0, this.rate1 - this.spinRateCost);
        this.spinDollarCost += 1;
        this.#updateCostMsg();
        this.#updateReadout();
        
        this.dom.spinBtn.disabled = true;
        this.dom.pauseBtn.disabled = true;
        this.dom.swapBtn.disabled = true;
        this.dom.buyBtn.disabled = true;
        this.dom.upgradeBtn.disabled = true;

        const durationPerReel = 330;
        const finalSyms = [this.#getReelSymbol(), this.#getReelSymbol(), this.#getReelSymbol()];

        await this.#animateReel(this.reelEls[0], finalSyms[0], durationPerReel);
        await this.#animateReel(this.reelEls[1], finalSyms[1], durationPerReel);
        await this.#animateReel(this.reelEls[2], finalSyms[2], durationPerReel);

        const diamondsLanded = finalSyms.filter(s => s === 'üíé').length;
        if (diamondsLanded > 0) {
          this.diamondCount = Math.max(0, this.diamondCount - diamondsLanded);
          this.#updateBuyBtnUI();
          if (this.diamondCount === 0) this.symbols = this.symbols.filter(x => x !== 'üíé');
        }

        const nonWild = finalSyms.filter(s => s !== 'üíé');
        let win = false;
        if (nonWild.length <= 1) win = true;
        else if (nonWild.length === 2) win = (nonWild[0] === nonWild[1]);
        else win = (finalSyms[0] === finalSyms[1] && finalSyms[1] === finalSyms[2]);

        if (win) {
          this.totalWins++;

          if (this.isSpinCostResetPurchased && !finalSyms.includes('üíé')) {
            this.spinDollarCost = SPIN_DOLLAR_COST;
            this.#updateCostMsg();
          }

          this.reelEls.forEach(el => el.classList.add('reel-win'));
          await new Promise(resolve => setTimeout(resolve, 1000));
          this.reelEls.forEach(el => el.classList.remove('reel-win'));

          let isBonus = Math.random() < 0.5;
          const currentWinPayout = isBonus ? this.winMoneyReward * 2 : this.winMoneyReward;

          this.#startConfetti();
          const choice = await this.#openWinChoice(currentWinPayout, isBonus);
          this.#stopConfetti();

          if (choice === 'money') {
            this.value1 += currentWinPayout;
          } else if (choice === 'reduce') {
            this.spinRateCost = Math.max(0, +(this.spinRateCost - 0.1).toFixed(1));
            this.#updateCostMsg();
          }
          
          this.winMoneyReward = this.winMoneyReward + 600;
        }

        if (this.running) {
          this.dom.pauseBtn.disabled = false;
          this.dom.swapBtn.disabled = (this.swapUses <= 0);
          this.#updateBuyBtnUI(); // Re-check disabled state
          this.dom.upgradeBtn.disabled = false;
        }
        this.dom.spinBtn.disabled = false;
        this.#updateReadout();
      }

      // ===== CONTROLS (Private) =====
      #initControls() {
        this.dom.swapBtn.textContent = `Swap (${this.swapUses})`;
        this.dom.swapBtn.addEventListener('click', () => {
          if (this.modalOpen || this.swapUses <= 0) return;
          [this.value1, this.value2] = [this.value2, this.value1];
          this.swapUses--;
          this.dom.swapBtn.textContent = `Swap (${this.swapUses})`;
          if (this.swapUses <= 0) {
            this.dom.swapBtn.disabled = true;
          }
          this.#updateReadout();
        });

        this.dom.pauseBtn.addEventListener('click', () => {
          if (this.modalOpen) return;
          this.running = !this.running;
          this.dom.pauseBtn.textContent = this.running ? 'Pause' : 'Resume';
          if (this.running) {
             // Restart game loop if it was paused
             this.lastTs = undefined; // Reset timestamp to avoid large dt jump
             requestAnimationFrame(this.boundTick);
          }
        });

        this.dom.buyBtn.addEventListener('click', () => {
          if (this.modalOpen) return;

          if (this.value2 >= this.buyDiamondCost && this.rate2 >= this.buyDiamondRateCost && this.diamondCount === 0) {
            this.value2 -= this.buyDiamondCost;
            this.rate2 = Math.max(0, this.rate2 - this.buyDiamondRateCost);
            this.diamondCount = 7;
            if (!this.symbols.includes('üíé')) this.symbols.push('üíé');
            this.buyDiamondCost += 500;
            this.buyDiamondRateCost += 1;
            this.#updateBuyBtnUI();
            this.#updateReadout();
          } else {
            if (this.value2 < this.buyDiamondCost || this.rate2 < this.buyDiamondRateCost) {
              if (typeof this.dom.buyBtn.animate === 'function') {
                this.dom.buyBtn.animate([
                  { transform: 'scale(1.05) rotate(0deg)' },
                  { transform: 'scale(1.05) rotate(-3deg)' },
                  { transform: 'scale(1.05) rotate(3deg)' },
                  { transform: 'scale(1.05) rotate(0deg)' }
                ], { duration: 200, easing: 'cubic-bezier(.2,.0,.5,3)' });
              }
            }
          }
        });

        const spinFunc = this.#spinOnce.bind(this);
        this.dom.spinBtn.addEventListener('click', spinFunc);
        this.dom.spinBtn.addEventListener('keydown', (e) => {
          if (this.modalOpen) { e.preventDefault(); return; }
          if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); spinFunc(); }
        });

        this.dom.upgradeBtn.addEventListener('click', this.#openUpgradeModal.bind(this));
        this.dom.closeUpgradeModalBtn.addEventListener('click', this.#closeUpgradeModal.bind(this));

        this.dom.buyResetSpinCostBtn.addEventListener('click', () => {
          if (this.isSpinCostResetPurchased) return;
          if (this.value1 < 5000 || this.rate1 < 10) {
            if (typeof this.dom.buyResetSpinCostBtn.animate === 'function') {
              this.dom.buyResetSpinCostBtn.animate([
                { transform: 'scale(1.05) rotate(0deg)' },
                { transform: 'scale(1.05) rotate(-3deg)' },
                { transform: 'scale(1.05) rotate(3deg)' },
                { transform: 'scale(1.05) rotate(0deg)' }
              ], { duration: 200, easing: 'cubic-bezier(.2,.0,.5,3)' });
            }
            return;
          }
          this.value1 -= 5000;
          this.rate1 -= 10;
          this.isSpinCostResetPurchased = true;
          this.dom.buyResetSpinCostBtn.disabled = true;
          this.dom.buyResetSpinCostBtn.textContent = "Purchased";
          this.#updateReadout();
        });

        this.dom.buyDoubleSliderBtn.addEventListener('click', () => {
          if (this.isSliderDoubledPurchased) return;
          if (this.value2 < 15000 || this.rate2 < 15) {
            if (typeof this.dom.buyDoubleSliderBtn.animate === 'function') {
              this.dom.buyDoubleSliderBtn.animate([
                { transform: 'scale(1.05) rotate(0deg)' },
                { transform: 'scale(1.05) rotate(-3deg)' },
                { transform: 'scale(1.05) rotate(3deg)' },
                { transform: 'scale(1.05) rotate(0deg)' }
              ], { duration: 200, easing: 'cubic-bezier(.2,.0,.5,3)' });
            }
            return;
          }

          this.value2 -= 15000;
          this.rate2 -= 15;
          growStepsBottom = growStepsBottom.map(val => val * 2);
          growStepsTop = growStepsTop.map(val => val * 2);
          this.isSliderDoubledPurchased = true;
          
          this.#buildTicks();
          this.#setGrowthByIndex(this.#currentIndex());
          this.#updateReadout();

          this.dom.buyDoubleSliderBtn.disabled = true;
          this.dom.buyDoubleSliderBtn.textContent = "Purchased";
        });

        // Add resize listener for confetti
        this.#initConfettiResizeListener();
      }

      // ===== GAME LOOP (Private) =====
      #tick(ts) {
        if (this.lastTs === undefined) this.lastTs = ts;
        const dt = (ts - this.lastTs) / 1000;
        this.lastTs = ts;

        if (this.running && dt > 0) {
          this.gameTimeSeconds -= dt;

          if (this.gameTimeSeconds <= 180) {
            if (!this.dom.gameTimerEl.classList.contains('timer-warning')) {
              this.dom.gameTimerEl.classList.add('timer-warning');
            }
          } else {
            if (this.dom.gameTimerEl.classList.contains('timer-warning')) {
              this.dom.gameTimerEl.classList.remove('timer-warning');
            }
          }

          this.value1 += this.rate1 * dt;
          this.value2 += this.rate2 * dt;
          const gps1 = (this.grow1 / 60), gps2 = (this.grow2 / 60);
          this.rate1 = Math.min(MAX_RATE, this.rate1 + gps1 * dt);
          this.rate2 = Math.min(MAX_RATE, this.rate2 + gps2 * dt);

          if (this.value1 >= WIN_AMOUNT) {
            this.value1 = WIN_AMOUNT;
            this.running = false;
            this.gameTimeSeconds = Math.max(0, this.gameTimeSeconds);
            this.dom.pauseBtn.disabled = true;
            this.dom.spinBtn.disabled = true;
            this.dom.buyBtn.disabled = true;
            if (this.dom.swapBtn) this.dom.swapBtn.disabled = true;
            if (this.dom.upgradeBtn) this.dom.upgradeBtn.disabled = true;
            this.dom.pauseBtn.textContent = "You Won!";
            this.dom.gameTimerEl.classList.remove('timer-warning');

            this.#showFinalWinModal();
            this.#updateReadout();
            return; // Exit the tick function
          }

          if (this.gameTimeSeconds <= 0) {
            this.gameTimeSeconds = 0;
            this.running = false;
            this.dom.pauseBtn.disabled = true;
            this.dom.spinBtn.disabled = true;
            this.dom.buyBtn.disabled = true;
            if (this.dom.swapBtn) this.dom.swapBtn.disabled = true;
            if (this.dom.upgradeBtn) this.dom.upgradeBtn.disabled = true;
            this.dom.pauseBtn.textContent = "Over";
            this.dom.gameTimerEl.classList.remove('timer-warning');
          }
        }

        this.#updateReadout();

        if (this.running && this.gameTimeSeconds > 0) {
          requestAnimationFrame(this.boundTick);
        } else if (this.gameTimeSeconds <= 0 && !this.running) {
          this.dom.gameTimerEl.textContent = "GAME OVER";
          this.dom.gameTimerEl.classList.remove('timer-warning');
        }
      }
    } // End class Game

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      // Perform all DOM lookups here
      const domElements = {
        gameTimerEl: document.getElementById('gameTimer'),
        val1El: document.getElementById('val1'),
        val2El: document.getElementById('val2'),
        rate1El: document.getElementById('rate1'),
        rate2El: document.getElementById('rate2'),
        slider: document.getElementById('uniSlider'),
        thumb: document.getElementById('thumb'),
        ticksTopEl: document.getElementById('ticksTop'),
        ticksBottomEl: document.getElementById('ticksBottom'),
        swapBtn: document.getElementById('swapBtn'),
        pauseBtn: document.getElementById('pause'),
        spinBtn: document.getElementById('spin'),
        buyBtn: document.getElementById('buyBtn'),
        backdrop: document.getElementById('winModalBackdrop'),
        takeMoneyBtn: document.getElementById('takeMoneyBtn'),
        reduceBtn: document.getElementById('reduceBtn'),
        upgradeBtn: document.getElementById('upgradeBtn'),
        upgradeModalBackdrop: document.getElementById('upgradeModalBackdrop'),
        closeUpgradeModalBtn: document.getElementById('closeUpgradeModal'),
        buyResetSpinCostBtn: document.getElementById('buyResetSpinCost'),
        buyDoubleSliderBtn: document.getElementById('buyDoubleSlider'),
        finalWinModalBackdrop: document.getElementById('finalWinModalBackdrop'),
        confettiCanvas: document.getElementById('confettiCanvas'),
        reel1: document.getElementById('reel1'),
        reel2: document.getElementById('reel2'),
        reel3: document.getElementById('reel3'),
      };

      // Create and initialize the game instance
      const game = new Game(domElements);
      game.init();
    });

  })();
  </script>
</body>
</html>
