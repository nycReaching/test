import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Lock, Unlock, Coins, RotateCcw } from "lucide-react";

// Minimal, portrait-first emoji slot machine
// - Fast-paced spin cadence
// - Coins system with bet control
// - Perks: tap-to-lock reels, optional sticky keep for matches
// - Clean UI, large reels, little chrome

const EMOJIS = [
  { s: "ðŸ’", w: 30, p: 4 },
  { s: "ðŸ‹", w: 25, p: 5 },
  { s: "ðŸ””", w: 15, p: 10 },
  { s: "ðŸ€", w: 12, p: 16 },
  { s: "ðŸ’Ž", w: 8,  p: 25 },
  { s: "â­", w: 6,  p: 40 },
  { s: "ðŸ‘‘", w: 4,  p: 60 },
];

const TOTAL_W = EMOJIS.reduce((a, b) => a + b.w, 0);
const pickEmoji = () => {
  const r = Math.random() * TOTAL_W;
  let acc = 0;
  for (const e of EMOJIS) {
    acc += e.w;
    if (r <= acc) return e.s;
  }
  return EMOJIS[0].s;
};

const reelStopDelays = [220, 340, 460];

export default function EmojiSlots() {
  const [coins, setCoins] = useState(100);
  const [bet, setBet] = useState(1);
  const [reels, setReels] = useState(["ðŸ’", "ðŸ’", "ðŸ’"]);
  const [spinning, setSpinning] = useState(false);
  const [locks, setLocks] = useState([false, false, false]);
  const [keepMode, setKeepMode] = useState(true);
  const [keptAuto, setKeptAuto] = useState([false, false, false]);
  const [boom, setBoom] = useState(0); // trigger confetti pulse
  const [shake, setShake] = useState(0);
  const intervalsRef = useRef([] as number[]);

  useEffect(() => () => intervalsRef.current.forEach((id) => clearInterval(id)), []);

  const canSpin = useMemo(() => !spinning && coins >= bet, [spinning, coins, bet]);

  const vibrate = (pattern: number | number[]) => {
    if ("vibrate" in navigator) {
      try { (navigator as any).vibrate(pattern); } catch {}
    }
  };

  const evalWin = (vals: string[]) => {
    // 3 of a kind wins
    if (vals[0] === vals[1] && vals[1] === vals[2]) {
      const emo = vals[0];
      const pay = (EMOJIS.find((e) => e.s === emo)?.p ?? 0) * bet;
      setCoins((c) => c + pay);
      setBoom((n) => n + 1);
      vibrate([40, 30, 60]);
      // Clear auto-keeps after a full win
      setKeptAuto([false, false, false]);
      return { win: true, pay };
    }
    // Optionally auto-keep any matching pair for next spin
    if (keepMode) {
      const nextKept = [false, false, false];
      if (vals[0] === vals[1]) { nextKept[0] = nextKept[1] = true; }
      else if (vals[1] === vals[2]) { nextKept[1] = nextKept[2] = true; }
      else if (vals[0] === vals[2]) { nextKept[0] = nextKept[2] = true; }
      setKeptAuto(nextKept);
    } else {
      setKeptAuto([false, false, false]);
    }
    return { win: false, pay: 0 };
  };

  const spin = async () => {
    if (!canSpin) {
      setShake((n) => n + 1);
      vibrate(60);
      return;
    }
    setSpinning(true);
    setCoins((c) => c - bet);

    // start cycling reels that are not locked
    const newIntervals: number[] = [];
    const startVals = [...reels];
    const targetVals = [...reels];

    for (let i = 0; i < 3; i++) {
      if (locks[i] || keptAuto[i]) continue;
      const id = window.setInterval(() => {
        startVals[i] = pickEmoji();
        setReels([...startVals]);
      }, 45); // fast-paced
      newIntervals.push(id);
    }

    intervalsRef.current = newIntervals;

    // stop in cadence and assign final symbols
    await Promise.all(
      [0, 1, 2].map(
        (i) =>
          new Promise<void>((res) => {
            const delay = reelStopDelays[i];
            setTimeout(() => {
              if (!(locks[i] || keptAuto[i])) {
                const final = pickEmoji();
                targetVals[i] = final;
                startVals[i] = final;
              }
              setReels([...startVals]);
              res();
            }, delay);
          })
      )
    );

    // stop and clear all intervals
    intervalsRef.current.forEach((id) => clearInterval(id));
    intervalsRef.current = [];

    // Evaluate win and manage keeps
    const result = evalWin(startVals);

    // Auto-unlock any manual locks after one spin
    setLocks((prev) => prev.map(() => false));

    setSpinning(false);
  };

  const toggleLock = (i: number) => {
    if (spinning) return;
    // Limit to max 2 manual locks for balance
    const count = locks.filter(Boolean).length;
    setLocks((prev) => {
      const next = [...prev];
      next[i] = !prev[i];
      if (next[i] && count >= 2) {
        // If exceeding, turn off the earliest other lock
        const j = prev.findIndex((v) => v);
        if (j >= 0 && j !== i) next[j] = false;
      }
      return next;
    });
  };

  const reset = () => {
    setCoins(100);
    setBet(1);
    setLocks([false, false, false]);
    setKeptAuto([false, false, false]);
    setReels(["ðŸ’", "ðŸ’", "ðŸ’"]);
  };

  const payoutOf = (s: string) => EMOJIS.find((e) => e.s === s)?.p ?? 0;

  return (
    <div className="w-full h-full min-h-screen bg-black text-white flex flex-col items-center justify-between p-4 select-none">
      {/* Top bar */}
      <div className="w-full max-w-sm flex items-center justify-between">
        <div className="flex items-center gap-2 text-xl">
          <Coins className="w-5 h-5" />
          <span className="font-medium">{coins}</span>
        </div>
        <div className="flex items-center gap-2 text-xl">
          <button
            className="px-2 py-1 rounded-lg bg-neutral-900 border border-neutral-800 active:scale-95"
            onClick={() => setBet((b) => Math.max(1, b - 1))}
            aria-label="Decrease bet"
          >
            âˆ’
          </button>
          <span className="min-w-[2ch] text-center">{bet}</span>
          <button
            className="px-2 py-1 rounded-lg bg-neutral-900 border border-neutral-800 active:scale-95"
            onClick={() => setBet((b) => Math.min(10, b + 1))}
            aria-label="Increase bet"
          >
            +
          </button>
        </div>
        <button
          onClick={reset}
          className="p-2 rounded-xl bg-neutral-900 border border-neutral-800 active:scale-95"
          aria-label="Reset"
        >
          <RotateCcw className="w-5 h-5" />
        </button>
      </div>

      {/* Reels */}
      <motion.div
        key={shake}
        initial={{ x: 0 }}
        animate={{ x: [0, 6, -6, 4, -4, 0] }}
        transition={{ duration: 0.28 }}
        className="relative w-full max-w-sm aspect-[9/12] grid grid-cols-3 gap-2 place-items-center"
      >
        {[0, 1, 2].map((i) => (
          <motion.button
            key={i}
            onClick={() => toggleLock(i)}
            className={`relative w-full h-full rounded-3xl bg-neutral-950 border border-neutral-800 flex items-center justify-center overflow-hidden ${locks[i] ? "ring-2 ring-yellow-400" : keptAuto[i] ? "ring-2 ring-cyan-400" : ""}`}
          >
            <AnimatePresence mode="popLayout">
              <motion.div
                key={reels[i]}
                initial={{ y: -30, scale: 0.9, opacity: 0 }}
                animate={{ y: 0, scale: 1, opacity: 1 }}
                exit={{ y: 30, scale: 0.9, opacity: 0 }}
                transition={{ type: "spring", stiffness: 400, damping: 24 }}
                className="text-[18vw] sm:text-[12vw] leading-none"
              >
                {reels[i]}
              </motion.div>
            </AnimatePresence>
            <div className="absolute top-2 right-2 opacity-80">
              {locks[i] ? <Lock className="w-5 h-5" /> : keptAuto[i] ? <Lock className="w-5 h-5" /> : null}
            </div>
            <div className="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs text-neutral-400">
              x{payoutOf(reels[i])}
            </div>
          </motion.button>
        ))}

        {/* Win pulse */}
        <AnimatePresence>
          <motion.div
            key={boom}
            className="pointer-events-none absolute inset-0 rounded-3xl"
            initial={{ opacity: 0 }}
            animate={{ opacity: [0, 0.25, 0] }}
            transition={{ duration: 0.5 }}
            style={{ background: "radial-gradient(ellipse at center, rgba(255,255,255,0.25), transparent 60%)" }}
          />
        </AnimatePresence>
      </motion.div>

      {/* Bottom controls */}
      <div className="w-full max-w-sm flex items-center justify-between gap-3">
        <button
          onClick={() => setKeepMode((k) => !k)}
          className={`px-3 py-2 rounded-2xl border text-sm ${keepMode ? "bg-neutral-900 border-neutral-700" : "bg-neutral-950 border-neutral-800"}`}
          aria-pressed={keepMode}
        >
          keep
        </button>
        <motion.button
          onClick={spin}
          disabled={!canSpin}
          whileTap={{ scale: 0.98 }}
          className={`flex-1 py-3 rounded-2xl text-lg font-semibold tracking-wide ${canSpin ? "bg-white text-black" : "bg-neutral-800 text-neutral-500"}`}
        >
          {spinning ? "spinning" : "spin"}
        </motion.button>
        <div className="text-xs text-neutral-500 w-[72px] text-right">
          3Ã— match pays
        </div>
      </div>

      <FooterHint />
    </div>
  );
}

function FooterHint() {
  return (
    <div className="fixed bottom-2 inset-x-0 flex items-center justify-center pointer-events-none">
      <div className="text-[10px] text-neutral-500">tap reels to lock â€¢ pairs keep if enabled</div>
    </div>
  );
}
