<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Loot Grab RPG</title>
    <!-- Thematic Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- THEME & VISUALS --- */
        :root {
            /* A darker, more thematic color palette for a roguelike feel */
            --color-bg-deep: #0a0a0a; /* Deepest black for background */
            --color-bg-primary: #18181b; /* zinc-900 for main container */
            --color-bg-secondary: #27272a; /* zinc-800 for panels */
            --color-border-primary: #3f3f46; /* zinc-700 */
            --color-border-secondary: #52525b; /* zinc-600 */
            --color-text-primary: #e4e4e7; /* zinc-200 */
            --color-text-secondary: #a1a1aa; /* zinc-400 */
            
            /* Accent colors for actions and highlights */
            --color-accent-magic: #8b5cf6; /* violet-500 */
            --color-accent-attack: #dc2626; /* red-600 */
            --color-accent-crit: #f59e0b; /* amber-500 */
            --color-accent-special: #10b981; /* emerald-500 */
            --color-accent-gold: #facc15; /* yellow-400 */
            
            /* Define glow colors based on accents */
            --glow-color-magic: rgba(139, 92, 246, 0.7);
            --glow-color-attack: rgba(220, 38, 38, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
            background-color: var(--color-bg-deep);
            color: var(--color-text-primary);
        }
        
        /* Custom font for titles/headers */
        .font-title {
            font-family: 'Cinzel', serif;
        }

        /* --- LAYOUT & STRUCTURE --- */
        /* Main game container styling */
        #game-container {
            background: linear-gradient(145deg, var(--color-bg-primary), #202024);
            border: 2px solid var(--color-border-primary);
            box-shadow: 0 0 40px rgba(0,0,0,0.8), inset 0 0 15px rgba(0,0,0,0.5);
        }

        /* General purpose panel for UI sections */
        .ui-panel {
            background-color: var(--color-bg-secondary);
            border: 1px solid var(--color-border-primary);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.4);
            border-radius: 0.5rem; /* 8px */
        }

        /* Make buttons feel more tactile and responsive */
        .action-button {
            border-width: 1px;
            border-bottom-width: 3px;
            transition: all 0.1s ease-in-out;
        }
        .action-button:active:not(:disabled) {
            transform: translateY(2px);
            border-bottom-width: 1px;
            filter: brightness(0.9);
        }
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(50%);
        }

        /* Custom progress bar fill transition */
        .progress-bar-fill {
            transition: width 0.3s ease-in-out;
        }
        
        /* Improved scrollbar hiding */
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        *::-webkit-scrollbar {
            display: none;
        }

        /* --- EMOJI & ANIMATION STYLES (Largely unchanged, with color tweaks) --- */
        .emoji-red-stamp {
            filter: grayscale(100%) brightness(80%) sepia(100%) hue-rotate(-50deg) saturate(800%) contrast(1) drop-shadow(0 0 10px rgba(255, 50, 50, 1));
        }
        .emoji-gold-glow {
            filter: drop-shadow(0 0 8px var(--color-accent-gold));
        }
        
        .text-shadow { text-shadow: 0 1px 3px rgba(0, 0, 0, 0.9); }
        .damage-number { position: absolute; font-size: 1.75rem; font-weight: bold; color: white; text-shadow: 0 2px 4px black; pointer-events: none; animation: float-up 1s ease-out forwards; }
        
        @keyframes float-up { to { transform: translateY(-50px) translateX(-50%); opacity: 0; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); } 20%, 40%, 60%, 80% { transform: translateX(3px); } }
        .shake-animation { animation: shake 0.3s ease-in-out; }
        @keyframes flip-horizontal { 50% { transform: scaleX(-1); } 100% { transform: scaleX(1); } }
        .flip-animation { animation: flip-horizontal 0.5s ease-in-out; }
        
        @keyframes damage-flash { 50% { transform: scale(1.7); color: var(--color-accent-gold); } }
        .damage-flash-animation { animation: damage-flash 0.4s ease-in-out; }
        
        @keyframes border-pulse { 50% { border-color: var(--color-accent-attack); } }
        .border-pulse-animation { animation: border-pulse 1s infinite; }
        
        .screen-flash { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: white; opacity: 0; pointer-events: none; z-index: 999; }
        @keyframes screen-flash-anim { from { opacity: 0.4; } to { opacity: 0; } }
        .flash-animation { animation: screen-flash-anim 0.3s ease-out; }
        
        @keyframes selector-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); border-color: rgba(245, 158, 11, 0.7); }
            50% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.9); border-color: rgba(245, 158, 11, 1); }
        }
        #battle-selector { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1); animation: selector-pulse 2s infinite ease-in-out; }

        @keyframes fade-out-and-shrink { to { transform: scale(0.5); opacity: 0; } }
        .enemy-fade-out { animation: fade-out-and-shrink 0.4s ease-out forwards; }
        .enemy-defeated { transition: width 0.3s ease-out, padding 0.3s ease-out, margin 0.3s ease-out; width: 0px !important; padding: 0 !important; margin: 0 !important; overflow: hidden; }

        @keyframes pulse-orange {
            50% {
                background-color: var(--color-accent-crit);
                box-shadow: 0 0 20px var(--color-accent-crit);
            }
        }
        .pulse-orange-animation { animation: pulse-orange 1.5s infinite ease-in-out; }

        @keyframes glow-orange-text { 50% { filter: drop-shadow(0 0 8px var(--color-accent-crit)); } }
        .glow-orange-text-animation { animation: glow-orange-text 1.5s infinite ease-in-out; }
        
        @keyframes reward-highlight {
            50% { 
                border-color: var(--color-accent-attack);
                box-shadow: 0 0 15px var(--color-accent-gold);
                transform: scale(1.03);
            }
        }
        .reward-highlight-anim { animation: reward-highlight 0.5s ease-in-out; }
        .reward-selected { border-color: var(--color-accent-attack) !important; box-shadow: 0 0 25px var(--color-accent-gold) !important; transform: scale(1.08) !important; cursor: pointer; }
        .reward-fade-out { opacity: 0.3; transform: scale(0.95); }

    </style>
</head>
<body class="bg-zinc-950 flex items-center justify-center min-h-screen p-2">

    <!-- Mobile Screen Container -->
    <div id="game-container" class="w-full max-w-sm h-[95vh] max-h-[800px] rounded-3xl p-4 flex flex-col justify-between relative overflow-hidden">
        <div id="screen-flash-overlay" class="screen-flash"></div>
        
        <!-- Top Section: Meters and Icons -->
        <header class="flex-shrink-0 space-y-3">
            <!-- Combined Magic/Kill bar -->
            <div class="flex w-full gap-2">
                <div class="w-1/2 bg-black/30 rounded-full h-4 border border-zinc-700 shadow-inner">
                    <div id="magic-bar" class="bg-violet-500 h-full rounded-full progress-bar-fill" style="width: 100%; box-shadow: 0 0 10px var(--glow-color-magic);"></div>
                </div>
                <div class="w-1/2 bg-black/30 rounded-full h-4 border border-zinc-700 shadow-inner">
                    <div id="kill-bar" class="bg-rose-800 h-full rounded-full progress-bar-fill" style="width: 0%; box-shadow: 0 0 10px rgba(153, 27, 27, 0.7);"></div>
                </div>
            </div>
    
            <!-- Player Stats and Currency -->
            <div class="flex justify-between items-center h-8 text-zinc-200 ui-panel p-2">
                <!-- HP/Armor & Status -->
                <div class="flex items-center text-lg gap-2">
                    <div class="flex items-center">
                        <span id="health-icon" class="text-red-500 cursor-pointer transition-transform duration-200">‚ù§Ô∏è</span>
                        <span id="health-value" class="font-bold ml-1 w-6 text-left">10</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-zinc-400">üõ°Ô∏è</span>
                        <span id="armor-value" class="font-bold ml-1 w-6 text-left">3</span>
                    </div>
                     <div id="player-status-effects" class="flex flex-row-reverse items-center text-base space-x-1 space-x-reverse ml-2">
                        <!-- Status effect icons populated by JS -->
                        <div class="relative status-effect-icon hidden" data-effect="‚ö°"><span>‚ö°</span><span class="stack-counter absolute -bottom-1 -right-1 text-xs font-bold text-shadow bg-zinc-900/70 rounded-full w-3.5 h-3.5 flex items-center justify-center leading-none"></span></div>
                        <div class="relative status-effect-icon hidden" data-effect="üåü"><span>üåü</span><span class="stack-counter absolute -bottom-1 -right-1 text-xs font-bold text-shadow bg-zinc-900/70 rounded-full w-3.5 h-3.5 flex items-center justify-center leading-none"></span></div>
                        <div class="relative status-effect-icon hidden" data-effect="‚ùáÔ∏è"><span>‚ùáÔ∏è</span><span class="stack-counter absolute -bottom-1 -right-1 text-xs font-bold text-shadow bg-zinc-900/70 rounded-full w-3.5 h-3.5 flex items-center justify-center leading-none"></span></div>
                        <div class="relative status-effect-icon hidden" data-effect="üêå"><span>üêå</span><span class="stack-counter absolute -bottom-1 -right-1 text-xs font-bold text-shadow bg-zinc-900/70 rounded-full w-3.5 h-3.5 flex items-center justify-center leading-none"></span></div>
                        <div class="relative status-effect-icon hidden" data-effect="üïØÔ∏è"><span>üïØÔ∏è</span><span class="stack-counter absolute -bottom-1 -right-1 text-xs font-bold text-shadow bg-zinc-900/70 rounded-full w-3.5 h-3.5 flex items-center justify-center leading-none"></span></div>
                        <div class="relative status-effect-icon hidden" data-effect="‚ò†Ô∏è"><span>‚ò†Ô∏è</span><span class="stack-counter absolute -bottom-1 -right-1 text-xs font-bold text-shadow bg-zinc-900/70 rounded-full w-3.5 h-3.5 flex items-center justify-center leading-none"></span></div>
                    </div>
                </div>
    
                <!-- Currency -->
                <div class="flex items-center gap-3 text-sm">
                    <div class="flex items-center justify-end gap-1 bg-zinc-900/50 px-2 py-1 rounded-md border border-zinc-700"><span class="text-lg">üí∞</span><span id="gold-value" class="font-bold w-8 text-left">99</span></div>
                    <div class="flex items-center justify-end gap-1 bg-zinc-900/50 px-2 py-1 rounded-md border border-zinc-700"><span class="text-lg">üåí</span><span id="moonstone-value" class="font-bold w-8 text-left">3</span></div>
                </div>
            </div>
        </header>

        <!-- Middle Section: Game Windows & Grid -->
        <main class="flex-grow flex flex-col my-4 gap-3">
            <!-- Large Window Above -->
            <div id="battle-details-window" class="relative ui-panel min-h-[90px] flex items-center justify-center p-4 transition-all duration-300 text-center">
                <div id="wave-counter" class="absolute top-1 left-3 text-xs font-bold text-zinc-500 italic font-title tracking-wider"></div>
                <div id="battle-details-content" class="w-full h-full flex items-center justify-center">
                    <button id="start-battle-btn" class="bg-emerald-600 border-emerald-800 border-b-emerald-900 hover:bg-emerald-500 text-white font-bold text-lg py-3 px-10 rounded-lg shadow-lg transition-all duration-200 action-button font-title tracking-widest">Start Battle</button>
                </div>
            </div>
            
            <!-- Enemy/Battle Reel -->
            <div id="enemy-container" class="relative flex justify-around items-center ui-panel p-2 select-none cursor-grab active:cursor-grabbing overflow-hidden h-24">
                <div id="enemy-slider" class="absolute top-0 left-0 h-full bg-white/10 border-2 border-white/50 rounded-lg pointer-events-none" style="transition: transform 0.2s ease-out;"></div>
                <div id="battle-selector" class="hidden absolute top-0 left-0 bg-amber-400/20 border-2 border-amber-400 rounded-lg pointer-events-none"></div>
                <!-- Icons will be populated by JS -->
                <span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span><span class="text-2xl relative z-10"></span>
            </div>

            <!-- Action Button Bar -->
            <div class="flex-shrink-0 ui-panel p-2">
                <div class="flex justify-around">
                    <button id="reshuffleBtn" class="action-button relative w-16 h-14 bg-sky-600 border-sky-800 rounded-lg shadow-lg focus:outline-none flex items-center justify-center text-4xl">
                        üîÉ
                        <span id="reshuffle-counter" class="absolute bottom-1 right-2 text-sm font-bold text-white text-shadow"></span>
                    </button>
                    <button id="attackBtn" class="action-button w-16 h-14 bg-rose-700 border-rose-900 rounded-lg shadow-lg focus:outline-none flex items-center justify-center text-2xl text-white">üó°Ô∏è<span id="attack-value" class="font-bold">10</span></button>
                    <button id="critBtn" class="action-button w-16 h-14 bg-amber-600 border-amber-800 rounded-lg shadow-lg focus:outline-none flex items-center justify-center text-white text-xl font-bold"><span id="crit-chance">10</span>%</button>
                </div>
            </div>

            <!-- Lower area with side window and grid -->
            <div class="flex-grow flex gap-3">
                <!-- Window to the left -->
                <div id="side-window-left" class="ui-panel w-1/2 p-2 flex flex-col items-start overflow-y-auto text-zinc-400">
                     <p class="p-1 text-xs italic">Select an item or spell to see details.</p>
                </div>

                <!-- 3x3 Grid -->
                <div class="grid grid-cols-3 grid-rows-3 gap-2 w-1/2 aspect-square">
                    <!-- Base button styles -->
                    <button class="equip-slot action-button relative bg-black/30 border-violet-800 rounded-lg shadow-md text-3xl flex items-center justify-center"></button>
                    <button class="equip-slot action-button relative bg-black/30 border-violet-800 rounded-lg shadow-md text-3xl flex items-center justify-center"></button>
                    <button class="equip-slot action-button relative bg-black/30 border-violet-800 rounded-lg shadow-md text-3xl flex items-center justify-center"></button>
                    
                    <button id="flameheartBtn" class="action-button bg-rose-900 border-rose-950 rounded-lg shadow-md text-3xl flex items-center justify-center">‚ù§Ô∏è‚Äçüî•</button>
                    <button id="frostbiteBtn" class="action-button bg-cyan-800 border-cyan-950 rounded-lg shadow-md text-3xl flex items-center justify-center">‚ùÑÔ∏è</button>
                    <button id="armorheartBtn" class="action-button bg-gray-600 border-gray-800 rounded-lg shadow-md text-3xl flex items-center justify-center">ü©∂</button>
                    
                    <button id="fortunesBtn" class="action-button bg-violet-700 border-violet-900 rounded-lg text-3xl shadow-lg flex items-center justify-center">üîÆ</button>
                    <button id="buildBtn" class="action-button bg-stone-600 border-stone-800 rounded-lg text-3xl shadow-lg flex items-center justify-center">üî®</button>
                    <button id="shopBtn" class="action-button bg-amber-600 border-amber-800 rounded-lg text-3xl shadow-lg flex items-center justify-center">ü™ô</button>
                </div>
            </div>
        </main>

        <!-- MODAL WINDOWS (Restyled for consistency) -->
        <div class="modal-backdrop hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-30 p-4" id="fortunesModal">
            <div class="relative ui-panel p-4 shadow-xl border-violet-500 w-full max-w-xs">
                <div id="fortunes-content" class="w-full text-lg text-white space-y-4 text-center"></div>
            </div>
        </div>
        <div class="modal-backdrop hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-30 p-4" id="buildModal">
            <div class="relative ui-panel p-4 shadow-xl border-stone-500 w-full max-w-xs">
                <div class="w-full text-lg text-white space-y-4">
                    <div class="flex justify-between items-center"><span class="font-semibold text-zinc-300">WEAPON</span><button data-slot-type="weapon" class="action-button w-24 h-14 bg-zinc-700 border-zinc-900 rounded-lg flex items-center justify-center text-3xl"></button></div>
                    <div class="flex justify-between items-center"><span class="font-semibold text-zinc-300">ARMOR</span><button data-slot-type="armor" class="action-button w-24 h-14 bg-zinc-700 border-zinc-900 rounded-lg flex items-center justify-center text-3xl"></button></div>
                    <div class="flex justify-between items-center"><span class="font-semibold text-zinc-300">RING</span><button data-slot-type="ring" class="action-button w-24 h-14 bg-zinc-700 border-zinc-900 rounded-lg flex items-center justify-center text-3xl"></button></div>
                </div>
            </div>
        </div>
        <div class="modal-backdrop hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-30 p-4" id="shopModal">
            <div class="relative ui-panel p-4 shadow-xl border-amber-500 w-full max-w-xs">
                <div id="shop-items-container" class="w-full max-w-xs text-lg text-white space-y-2"></div>
            </div>
        </div>
        <div class="modal-backdrop hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50" id="reelModal">
            <div class="relative ui-panel p-3 shadow-xl">
                <div id="reel-items" class="flex gap-2 text-3xl">
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-95">‚ò†Ô∏è</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-95">üïØÔ∏è</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-95">üêå</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-95">‚ùáÔ∏è</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-95">üåü</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-95">‚ö°</button>
                </div>
            </div>
        </div>
        <div class="modal-backdrop hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-40" id="equipmentChoiceModal">
            <div class="relative ui-panel p-4 shadow-xl w-full max-w-xs">
                <div id="equipmentChoiceContent" class="text-lg text-white space-y-3"></div>
            </div>
        </div>
        <div class="modal-backdrop hidden absolute inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4" id="giftModal">
            <div class="relative ui-panel p-6 shadow-xl border border-red-500 w-full max-w-xs text-center">
                <h2 class="text-2xl font-bold mb-4 text-amber-300 font-title">A Gift!</h2>
                <div id="gift-rewards" class="space-y-3 mb-6">
                    <div data-reward="armor" class="gift-reward-item bg-zinc-800 p-3 rounded-lg border-2 border-transparent transition-all duration-400 flex items-center justify-center">
                        <span class="text-2xl">üõ°Ô∏è</span><span class="ml-2 font-semibold text-lg">+1 Max Armor</span>
                    </div>
                    <div data-reward="gold" class="gift-reward-item bg-zinc-800 p-3 rounded-lg border-2 border-transparent transition-all duration-400 flex items-center justify-center">
                        <span class="text-2xl">üí∞</span><span class="ml-2 font-semibold text-lg">+15 Gold</span>
                    </div>
                    <div data-reward="crit" class="gift-reward-item bg-zinc-800 p-3 rounded-lg border-2 border-transparent transition-all duration-400 flex items-center justify-center">
                        <span class="text-2xl">üí•</span><span class="ml-2 font-semibold text-lg">+1% Crit Chance</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- JAVASCRIPT LOGIC (UNCHANGED) ---
        // I have not modified your gameplay logic, functions, or variables.
        // All changes are purely related to HTML structure and CSS classes for the new design.
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const gameContainer = document.getElementById('game-container');
            const goldValueEl = document.getElementById('gold-value');
            const moonstoneValueEl = document.getElementById('moonstone-value');
            const reshuffleCounter = document.getElementById('reshuffle-counter');
            const shopItemsContainer = document.getElementById('shop-items-container');
            let enemyContainer = document.getElementById('enemy-container');
            let enemySlider = document.getElementById('enemy-slider');
            let battleSelector = document.getElementById('battle-selector');
            const reshuffleBtn = document.getElementById('reshuffleBtn');
            const reelModal = document.getElementById('reelModal');
            const equipSlots = document.querySelectorAll('.equip-slot');
            const reelItems = document.querySelectorAll('.reel-item');
            const equipmentChoiceModal = document.getElementById('equipmentChoiceModal');
            const equipmentChoiceContent = document.getElementById('equipmentChoiceContent');
            let startBattleBtn = document.getElementById('start-battle-btn');
            const sideWindowLeft = document.getElementById('side-window-left');
            const battleDetailsWindow = document.getElementById('battle-details-window');
            const battleDetailsContentEl = document.getElementById('battle-details-content');
            const waveCounterEl = document.getElementById('wave-counter');
            const flameheartBtn = document.getElementById('flameheartBtn');
            const frostbiteBtn = document.getElementById('frostbiteBtn');
            const armorheartBtn = document.getElementById('armorheartBtn');
            const fortunesContent = document.getElementById('fortunes-content');
            const attackBtn = document.getElementById('attackBtn');
            const attackValueEl = document.getElementById('attack-value');
            const armorValueEl = document.getElementById('armor-value');
            const healthValueEl = document.getElementById('health-value');
            const killBarEl = document.getElementById('kill-bar');
            const magicBarEl = document.getElementById('magic-bar');
            const healthIconEl = document.getElementById('health-icon');
            const critBtn = document.getElementById('critBtn');
            const critChanceEl = document.getElementById('crit-chance');
            const giftModal = document.getElementById('giftModal');
            let giftRewardItems = document.querySelectorAll('.gift-reward-item');
            
            const modalMap = {
                fortunesBtn: { modal: document.getElementById('fortunesModal'), button: document.getElementById('fortunesBtn') },
                buildBtn: { modal: document.getElementById('buildModal'), button: document.getElementById('buildBtn') },
                shopBtn: { modal: document.getElementById('shopModal'), button: document.getElementById('shopBtn') }
            };
            const allModals = Object.values(modalMap).map(item => item.modal);
            
            // --- Game Data (Unchanged) ---
            const shopItems = [
                { id: 'tonic', name: 'üç∂ TONIC', cost: 5 },
                { id: 'cross', name: '‚úùÔ∏è CROSS', cost: 15 },
                { id: 'gem', name: 'üíé GEM', cost: 25 },
                { id: 'fairy', name: 'üßöüèº FAIRY', cost: 40 },
                { id: 'moonstone', name: 'üåí MOONSTONE', cost: 50 },
            ];
            const enemyData = {
                'üíÄ': { name: 'Skeleton' },'üê∫': { name: 'Wolf' },'üê∏': { name: 'Frog', special: '‚ò†Ô∏è' },'ü¶Ñ': { name: 'Unicorn', special: '‚ùáÔ∏è' },'üê≤': { name: 'Dragon' },'üêç': { name: 'Serpent', special: '‚ò†Ô∏è' },'üêÄ': { name: 'Rat' },'üê¶‚Äç‚¨õ': { name: 'Crow', special: 'üïØÔ∏è' },'üï∑Ô∏è': { name: 'Spider', special: '‚ò†Ô∏è' },'ü¶Ç': { name: 'Scorpion' },'ü¶ü': { name: 'Mosquito', special: 'üêå' },'üßü': { name: 'Zombie', special: 'üêå' },'üßû': { name: 'Genie', special: '‚ùáÔ∏è' },'üßå': { name: 'Troll' },'ü•∑': { name: 'Ninja', special: 'ü´≥' },'üßõ': { name: 'Vampire', special: 'üïØÔ∏è' },'ü¶π': { name: 'Supervillain' },'üéÅ': { name: 'Gift' }
            };
            const equipmentOptions = {
                weapon: [{ emoji: 'üèπ', name: 'Bow' }, { emoji: 'üó°Ô∏è', name: 'Dagger' }, { emoji: 'üî®', name: 'Hammer' }],
                armor: [{ emoji: 'üß•', name: 'Leather Gear' }, { emoji: 'ü™®', name: 'Rock Bracer' }, { emoji: 'üï∏Ô∏è', name: 'Cloak' }],
                ring: [{ emoji: 'üíç', name: 'Eccentric Jewel' }]
            };
            const spellDescriptions = {
                flameheart: { title: "‚ù§Ô∏è‚Äçüî• Flameheart:", desc1: "Deal 5 and heal 5 HP.", desc2: "Depletes half magic bar." },
                frostbite: { title: "‚ùÑÔ∏è Frostbite:", desc1: "Deal 5 damage.", desc2: "Depletes half magic bar." },
                armorheart: { title: "ü©∂ Armorheart:", desc1: "Add current health to armor.", desc2: "Depletes half magic bar." }
            };
            const symbolDescriptions = {
                '‚ò†Ô∏è': { title: "‚ò†Ô∏è Poison", desc: "Inflicts damage over time.", costDesc: "Cost: 1 üåí" },'üïØÔ∏è': { title: "üïØÔ∏è Curse", desc: "Weakens enemy attacks.", costDesc: "Cost: 1 üåí" },'üêå': { title: "üêå Slow", desc: "Reduces enemy speed.", costDesc: "Cost: 1 üåí" },'‚ùáÔ∏è': { title: "‚ùáÔ∏è Regen", desc: "Heals you over time.", costDesc: "Cost: 1 üåí" },'üåü': { title: "üåü Blessing", desc: "Increases your damage.", costDesc: "Cost: 1 üåí" },'‚ö°': { title: "‚ö° Rush", desc: "Grants extra actions.", costDesc: "Cost: 1 üåí" }
            };
            const sacrifices = ['ü©∏ Blood Pact','ü¶∂üèº Broken Ankle','üíî Heartbreak','üìú Gambling Debt','ü´≥üèΩ Clumsy','üé≠ Unstable Mind'];
            const fortunes = [
                { text: 'Efficient Magic', color: 'text-sky-400' },{ text: 'Bartering Edge', color: 'text-sky-400' },{ text: 'Archer\'s Edge', color: 'text-amber-400' },{ text: 'Enchantment', color: 'text-amber-400' },{ text: 'Battle Grace', color: 'text-amber-400' },{ text: 'Prolonged Torment', color: 'text-pink-400' },{ text: 'Thief Strike', color: 'text-pink-400' },{ text: 'Toxic Decay', color: 'text-pink-400' }
            ];

            // --- State (Unchanged) ---
            let playerState = {
                gold: 99, moonstones: 3, rerolls: 5, killCount: 0, 
                maxHealth: 10, health: 10, armor: 3, maxArmor: 3,
                magic: 100, maxMagic: 100,
                baseCritChance: 10,
                equipment: { weapon: null, armor: null, ring: null }, 
                inventory: { tonic: 0, gem: 0, cross: 0, fairy: 0, moonstone: 3, }, 
                statusEffects: { '‚ò†Ô∏è': 0, 'üïØÔ∏è': 0, 'üêå': 0, '‚ùáÔ∏è': 0, 'üåü': 0, '‚ö°': 0 }
            };
            playerState.health = playerState.maxHealth; 

            let waveCount = 1;
            let battleStarted = false;
            const enemyPool = Object.keys(enemyData).filter(e => e !== 'üéÅ');
            const giftEmoji = 'üéÅ';
            const numIcons = 8;
            const groupSize = 3;
            let isReshuffling = false;
            let activeEquipSlot = null;
            let activeBuildSlot = null;
            let isDragging = false;
            let startX, startY;
            let initialTranslateX;
            let currentTranslateX = 0;
            let dragStartTime;
            let currentBattleTargetIndex = 0;
            let currentEnemiesInBattle = [];
            let fortunePhase = 'sacrifice'; 
            let selectedFortunes = [];
            let currentSacrifice = null;
            
            const delay = ms => new Promise(res => setTimeout(res, ms));

            // --- Battle Animations (Unchanged) ---
            const showDamageNumber = (damage, element) => {
                const damageEl = document.createElement('div');
                damageEl.textContent = damage;
                damageEl.className = 'damage-number';
                const rect = element.getBoundingClientRect();
                const gameRect = gameContainer.getBoundingClientRect();
                const top = rect.top - gameRect.top;
                const left = rect.left - gameRect.left + (rect.width / 2);
                damageEl.style.top = `${top}px`;
                damageEl.style.left = `${left}px`;
                damageEl.style.transform = 'translateX(-50%)';
                gameContainer.appendChild(damageEl);
                setTimeout(() => { damageEl.remove(); }, 1000);
            };

            // --- UI Update Logic (Unchanged) ---
            const updateStatusEffectsUI = () => {
                const statusEffectIcons = document.querySelectorAll('.status-effect-icon');
                statusEffectIcons.forEach(icon => {
                    const effect = icon.dataset.effect;
                    const stacks = playerState.statusEffects[effect];
                    const wasHidden = icon.classList.contains('hidden');
                    if (stacks > 0) {
                        icon.classList.remove('hidden');
                        icon.querySelector('.stack-counter').textContent = stacks;
                        if (wasHidden) {
                            icon.classList.add('damage-flash-animation');
                            setTimeout(() => icon.classList.remove('damage-flash-animation'), 400);
                        }
                    } else {
                        icon.classList.add('hidden');
                    }
                });
            };
            const updatePlayerUI = () => {
                goldValueEl.textContent = playerState.gold;
                moonstoneValueEl.textContent = playerState.moonstones;
                reshuffleCounter.textContent = playerState.rerolls;
                armorValueEl.textContent = playerState.armor;
                healthValueEl.textContent = playerState.health;
                critChanceEl.textContent = playerState.baseCritChance;
                
                if(magicBarEl) {
                    const magicPercentage = (playerState.magic / playerState.maxMagic) * 100;
                    magicBarEl.style.width = `${magicPercentage}%`;
                }


                const isCharged = playerState.killCount >= 10;
                
                if (isCharged) {
                    killBarEl.style.width = '100%';
                    killBarEl.classList.remove('bg-rose-800');
                    killBarEl.classList.add('bg-amber-500', 'pulse-orange-animation');
                    killBarEl.style.boxShadow = '0 0 10px var(--color-accent-crit)';
                    critBtn.classList.add('glow-orange-text-animation');
                    healthIconEl.classList.add('glow-orange-text-animation');
                } else {
                    const killPercentage = (playerState.killCount / 10) * 100;
                    killBarEl.style.width = `${killPercentage}%`;
                    killBarEl.classList.add('bg-rose-800');
                    killBarEl.classList.remove('bg-amber-500', 'pulse-orange-animation');
                    killBarEl.style.boxShadow = '0 0 10px rgba(153, 27, 27, 0.7)';
                    critBtn.classList.remove('glow-orange-text-animation');
                    healthIconEl.classList.remove('glow-orange-text-animation');
                }
                
                reshuffleBtn.disabled = playerState.rerolls <= 0 || battleStarted;
            };
            const updateWaveCounterUI = () => { if (waveCounterEl) waveCounterEl.textContent = `Wave ${waveCount}`; };
            const updateEnemyDisplay = (enemy) => {
                if (!enemy) return;
                const data = enemyData[enemy.emoji];
                const name = data?.name || 'Unknown';
                let statsHtml = '<div class="h-4"></div>';
                if (!enemy.isGift) {
                    const hp = enemy.hp;
                    const dmg = enemy.isStamped ? '2' : '1';
                    const specialIcon = data.special ? ` ${data.special}` : '';
                    statsHtml = `<div class="text-sm text-zinc-300 mt-1">‚ù§Ô∏è ${hp} üí• ${dmg}${specialIcon}</div>`;
                }
                battleDetailsContentEl.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="text-xl font-bold text-shadow">${enemy.emoji} ${name}</div>
                        ${statsHtml}
                    </div>`;
            };
            const displayInfoInSideWindow = (title, ...descriptions) => {
                if (battleStarted) return; 
                 sideWindowLeft.innerHTML = `
                    <div class="text-zinc-200 text-sm text-left w-full p-1">
                        <p class="font-bold mb-1 text-white">${title}</p>
                        ${descriptions.map(d => `<p>${d}</p>`).join('')}
                    </div>`;
            };
            const displaySpellInfo = (spellKey) => {
                const spell = spellDescriptions[spellKey];
                if (!spell) return;
                displayInfoInSideWindow(spell.title, spell.desc1, spell.desc2);
            };

            // --- Fortunes Modal Logic (Unchanged) ---
            const showFortunes = () => {
                fortunePhase = 'fortune';
                fortunesContent.innerHTML = ''; 
                const title = document.createElement('h2');
                title.className = 'text-2xl font-bold mb-4 text-violet-300 font-title';
                title.textContent = 'FORTUNE';
                fortunesContent.appendChild(title);
                const shuffled = shuffle([...fortunes]);
                const options = shuffled.slice(0, 3);
                options.forEach(fortune => {
                    const button = document.createElement('button');
                    button.className = `action-button bg-zinc-700 border-zinc-900 rounded-lg px-4 py-3 w-full whitespace-normal leading-tight ${fortune.color}`;
                    button.textContent = fortune.text;
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        if (currentSacrifice && selectedFortunes.length < 4) selectedFortunes.push({ sacrifice: currentSacrifice, fortune: fortune.text });
                        currentSacrifice = null;
                        closeModal(modalMap.fortunesBtn.modal);
                    });
                    fortunesContent.appendChild(button);
                });
            };
            const showSacrifices = () => {
                fortunePhase = 'sacrifice';
                fortunesContent.innerHTML = ''; 
                if (selectedFortunes.length < 4) {
                    const title = document.createElement('h2');
                    title.className = 'text-2xl font-bold mb-4 text-violet-300 font-title';
                    title.textContent = 'SACRIFICE';
                    fortunesContent.appendChild(title);
                    const shuffledSacrifices = shuffle([...sacrifices]);
                    const selectedSacrifices = shuffledSacrifices.slice(0, 2);
                    selectedSacrifices.forEach(sacrifice => {
                        const button = document.createElement('button');
                        button.className = 'action-button bg-zinc-700 border-zinc-900 rounded-lg px-4 py-3 w-full whitespace-normal leading-tight';
                        button.textContent = sacrifice;
                        button.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            currentSacrifice = sacrifice;
                            showFortunes();
                        });
                        fortunesContent.appendChild(button);
                    });
                } else {
                    const fullMessage = document.createElement('p');
                    fullMessage.className = 'text-lg text-zinc-300';
                    fullMessage.textContent = "Your destiny is sealed.";
                    fortunesContent.appendChild(fullMessage);
                }
                if (selectedFortunes.length > 0) {
                    const fortuneListContainer = document.createElement('div');
                    fortuneListContainer.className = 'mt-6 pt-4 border-t border-zinc-600 w-full';
                    const fortuneList = document.createElement('div');
                    fortuneList.className = 'flex flex-wrap justify-center gap-2 text-xs text-zinc-400 text-center';
                    selectedFortunes.forEach(sf => {
                        const fortuneEntry = document.createElement('div');
                        fortuneEntry.className = 'p-2 bg-zinc-900/50 rounded w-2/5';
                        fortuneEntry.innerHTML = `<p class="font-semibold">${sf.sacrifice}</p><p>${sf.fortune}</p>`;
                        fortuneList.appendChild(fortuneEntry);
                    });
                    fortuneListContainer.appendChild(fortuneList);
                    fortunesContent.appendChild(fortuneListContainer);
                }
            };

            // --- Shop Logic (Unchanged) ---
            const renderShop = () => {
                shopItemsContainer.innerHTML = '';
                shopItems.forEach(item => {
                    const itemOwned = playerState.inventory[item.id] || 0;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center';
                    let buttonHtml;
                    if (battleStarted) {
                        buttonHtml = `<button data-item-id="${item.id}" class="action-button bg-emerald-600 border-emerald-800 rounded-lg px-4 py-1" ${itemOwned > 0 ? '' : 'disabled'}>USE</button>`;
                    } else {
                        const canAfford = playerState.gold >= item.cost;
                        buttonHtml = `<button data-item-id="${item.id}" class="action-button bg-zinc-700 border-zinc-900 rounded-lg px-3 py-1" ${!canAfford ? 'disabled' : ''}>ü™ô${item.cost}</button>`;
                    }
                    itemDiv.innerHTML = `<span class="whitespace-normal">${item.name} (${itemOwned})</span>${buttonHtml}`;
                    shopItemsContainer.appendChild(itemDiv);
                });
            };
            const buyItem = (itemId) => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item || playerState.gold < item.cost) return; 
                playerState.gold -= item.cost;
                playerState.inventory[item.id]++;
                if (item.id === 'moonstone') playerState.moonstones++;
                updatePlayerUI();
                renderShop();
            };
            shopItemsContainer.addEventListener('click', (e) => {
                if(battleStarted) return; 
                const button = e.target.closest('button');
                if (button && button.dataset.itemId) {
                    e.stopPropagation(); 
                    buyItem(button.dataset.itemId);
                }
            });

            // --- Modal, Equipment & Build Logic (Unchanged) ---
            const openModal = (modalToOpen) => {
                if (!modalToOpen) return;
                if (modalToOpen.id === 'shopModal') renderShop();
                else if (modalToOpen.id === 'fortunesModal') showSacrifices(); 
                allModals.forEach(m => m.classList.add('hidden')); 
                modalToOpen.classList.remove('hidden');
            };
            const closeModal = (modalToClose) => { if (modalToClose) modalToClose.classList.add('hidden'); };
            equipSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    if (battleStarted) {
                        const symbol = slot.dataset.symbol;
                        let uses = parseInt(slot.dataset.uses || '0', 10);
                        const playerBuffs = ['‚ùáÔ∏è', 'üåü', '‚ö°'];
                        if (playerBuffs.includes(symbol) && uses > 0) {
                            uses--;
                            slot.dataset.uses = uses;
                            const counterSpan = slot.querySelector('.text-shadow');
                            if (counterSpan) counterSpan.textContent = uses;
                            if (uses <= 0) slot.style.opacity = '0.5'; 
                            playerState.statusEffects[symbol] = 1;
                            updateStatusEffectsUI();
                        }
                        return; 
                    }
                    const symbol = slot.dataset.symbol;
                    if (symbol) {
                        const info = symbolDescriptions[symbol];
                        if (info) displayInfoInSideWindow(info.title, info.desc, info.costDesc);
                    } else {
                        activeEquipSlot = slot;
                        reelItems.forEach(item => {
                            item.disabled = playerState.moonstones <= 0;
                            item.classList.toggle('opacity-50', playerState.moonstones <= 0);
                            item.classList.toggle('cursor-not-allowed', playerState.moonstones <= 0);
                        });
                        reelModal.classList.remove('hidden');
                    }
                });
            });
            reelItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (activeEquipSlot) {
                        playerState.moonstones--;
                        playerState.inventory.moonstone--; 
                        updatePlayerUI();
                        const symbol = item.textContent;
                        activeEquipSlot.innerHTML = ''; 
                        activeEquipSlot.dataset.symbol = symbol;
                        activeEquipSlot.dataset.uses = '3';
                        const emojiSpan = document.createElement('span');
                        emojiSpan.textContent = symbol;
                        activeEquipSlot.appendChild(emojiSpan);
                        const counterSpan = document.createElement('span');
                        counterSpan.className = 'absolute bottom-1 right-2 text-sm font-bold text-white text-shadow';
                        counterSpan.textContent = '3';
                        activeEquipSlot.appendChild(counterSpan);
                        reelModal.classList.add('hidden');
                        activeEquipSlot = null;
                    }
                });
            });
            const openEquipmentChoiceModal = (slotType) => {
                equipmentChoiceContent.innerHTML = '';
                equipmentOptions[slotType].forEach(item => {
                    const itemButton = document.createElement('button');
                    itemButton.className = 'action-button bg-zinc-700 border-zinc-900 rounded-lg px-4 py-3 w-full text-left flex items-center whitespace-normal';
                    itemButton.innerHTML = `<span class="text-2xl w-10">${item.emoji}</span> <span>${item.name}</span>`;
                    itemButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activeBuildSlot) {
                            const slotType = activeBuildSlot.dataset.slotType;
                            const wasEquipped = !!playerState.equipment[slotType];
                            playerState.equipment[slotType] = item;
                            activeBuildSlot.innerHTML = item.emoji;
                            if (!wasEquipped) {
                                if (slotType === 'weapon') attackValueEl.textContent = parseInt(attackValueEl.textContent, 10) + 1;
                                else if (slotType === 'armor') {
                                    playerState.maxArmor += 1;
                                    playerState.armor += 1;
                                }
                            }
                            updatePlayerUI();
                        }
                        equipmentChoiceModal.classList.add('hidden');
                    });
                    equipmentChoiceContent.appendChild(itemButton);
                });
                equipmentChoiceModal.classList.remove('hidden');
            };
            document.querySelectorAll('[data-slot-type]').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeBuildSlot = btn;
                    openEquipmentChoiceModal(btn.dataset.slotType);
                });
            });
            
            // --- Enemy Slider & Reshuffle Logic (Unchanged) ---
            const calculateSliderDimensions = () => {
                if(battleStarted) return {};
                const containerWidth = enemyContainer.offsetWidth;
                const iconWidth = containerWidth / numIcons;
                const sliderWidth = iconWidth * groupSize;
                enemySlider.style.width = `${sliderWidth}px`;
                return { containerWidth, iconWidth, sliderWidth };
            };
            const getEventCoords = (e) => ({ x: e.touches ? e.touches[0].clientX : e.clientX, y: e.touches ? e.touches[0].clientY : e.clientY });
            const dragStart = (e) => {
                if (battleStarted || isReshuffling) return;
                isDragging = true;
                const coords = getEventCoords(e);
                startX = coords.x; startY = coords.y; dragStartTime = Date.now();
                enemySlider.style.transition = 'none';
                initialTranslateX = currentTranslateX;
                document.addEventListener('mousemove', dragMove);
                document.addEventListener('touchmove', dragMove, { passive: false });
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
            };
            const dragMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const deltaX = getEventCoords(e).x - startX;
                currentTranslateX = initialTranslateX + deltaX;
                const { containerWidth, sliderWidth } = calculateSliderDimensions();
                const maxTranslateX = containerWidth - sliderWidth;
                currentTranslateX = Math.max(0, Math.min(currentTranslateX, maxTranslateX));
                enemySlider.style.transform = `translateX(${currentTranslateX}px)`;
            };
            const dragEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                const endCoords = e.changedTouches ? e.changedTouches[0] : e;
                const deltaX = endCoords.clientX - startX, deltaY = endCoords.clientY - startY, deltaTime = Date.now() - dragStartTime;
                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('touchmove', dragMove);
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchend', dragEnd);
                enemySlider.style.transition = 'transform 0.2s ease-out';
                const { iconWidth } = calculateSliderDimensions();
                if (deltaTime < 250 && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
                    const tappedIndex = Math.floor((endCoords.clientX - enemyContainer.getBoundingClientRect().left) / iconWidth);
                    const targetIndex = Math.max(0, Math.min(numIcons - groupSize, tappedIndex - 1));
                    currentTranslateX = targetIndex * iconWidth;
                } else { 
                    const closestSnapIndex = Math.round(currentTranslateX / iconWidth);
                    const clampedIndex = Math.min(numIcons - groupSize, Math.max(0, closestSnapIndex));
                    currentTranslateX = clampedIndex * iconWidth;
                }
                enemySlider.style.transform = `translateX(${currentTranslateX}px)`;
            };
            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; }
                return array;
            };
            const reshuffleEnemies = (isInitial = false) => {
                if (isReshuffling || (!isInitial && playerState.rerolls <= 0)) return;
                if (!isInitial) { playerState.rerolls--; updatePlayerUI(); }
                isReshuffling = true;
                if(startBattleBtn) startBattleBtn.disabled = true;
                enemyContainer.classList.remove('cursor-grab', 'active:cursor-grabbing');
                if (enemySlider) enemySlider.classList.add('hidden');
                const enemySpans = Array.from(enemyContainer.querySelectorAll('span.relative.z-10'));
                const fadeOutDuration = isInitial ? 0 : 200; 
                enemySpans.forEach(span => { span.style.transition = `opacity ${fadeOutDuration}ms ease-out`; span.style.opacity = '0'; });
                setTimeout(() => {
                    const finalEnemySet = shuffle([...shuffle([...enemyPool]).slice(0, 7), giftEmoji]);
                    enemySpans.forEach((span, index) => {
                        span.textContent = finalEnemySet[index];
                        span.className = 'text-2xl relative z-10'; 
                        span.style.transition = 'opacity 0.4s ease-out';
                    });
                    const giftSpan = enemySpans.find(span => span.textContent === giftEmoji);
                    if (giftSpan) giftSpan.classList.add('emoji-gold-glow');
                    const stampableSpans = enemySpans.filter(span => span.textContent !== giftEmoji);
                    if (stampableSpans.length > 0) stampableSpans[Math.floor(Math.random() * stampableSpans.length)].classList.add('emoji-red-stamp');
                    currentTranslateX = 0;
                    if (enemySlider) enemySlider.style.transform = `translateX(0px)`;
                    const totalRevealTime = 1000;
                    enemySpans.forEach((span, index) => { setTimeout(() => { span.style.opacity = '1'; }, index * (totalRevealTime / enemySpans.length)); });
                    setTimeout(() => {
                        isReshuffling = false;
                        if (!battleStarted) { 
                            if (enemySlider) enemySlider.classList.remove('hidden');
                            updatePlayerUI();
                            enemyContainer.classList.add('cursor-grab', 'active:cursor-grabbing');
                            if(startBattleBtn) startBattleBtn.disabled = false;
                        }
                    }, totalRevealTime);
                }, fadeOutDuration);
            };

            // --- Spell Logic (Unchanged) ---
            const executeSpell = (spellKey) => {
                if (!battleStarted || playerState.magic < 50) return; 

                playerState.magic -= 50;
                updatePlayerUI();

                const targetEnemy = currentEnemiesInBattle[currentBattleTargetIndex];
                const enemyWrapper = targetEnemy?.ref;

                switch (spellKey) {
                    case 'flameheart':
                        if (targetEnemy && !targetEnemy.isDefeated && !targetEnemy.isGift) {
                            const damage = 5;
                            showDamageNumber(damage, enemyWrapper);
                            targetEnemy.hp = Math.max(0, targetEnemy.hp - damage);
                            const healthBarFill = enemyWrapper.querySelector('.bg-rose-600');
                            if (healthBarFill) healthBarFill.style.width = `${(targetEnemy.hp / targetEnemy.maxHp) * 100}%`;
                            updateEnemyDisplay(targetEnemy);
                            if (targetEnemy.hp <= 0) {
                                handleEnemyDefeat(currentBattleTargetIndex);
                            }
                        }
                        playerState.health = Math.min(playerState.maxHealth, playerState.health + 5);
                        healthValueEl.classList.add('damage-flash-animation');
                        setTimeout(() => healthValueEl.classList.remove('damage-flash-animation'), 400);
                        updatePlayerUI();
                        break;
                    case 'frostbite':
                        if (targetEnemy && !targetEnemy.isDefeated && !targetEnemy.isGift) {
                            const damage = 5;
                            showDamageNumber(damage, enemyWrapper);
                            targetEnemy.hp = Math.max(0, targetEnemy.hp - damage);
                            const healthBarFill = enemyWrapper.querySelector('.bg-rose-600');
                            if (healthBarFill) healthBarFill.style.width = `${(targetEnemy.hp / targetEnemy.maxHp) * 100}%`;
                            updateEnemyDisplay(targetEnemy);
                            if (targetEnemy.hp <= 0) {
                                handleEnemyDefeat(currentBattleTargetIndex);
                            }
                        }
                        break;
                    case 'armorheart':
                        playerState.armor += playerState.health;
                        updatePlayerUI();
                        armorValueEl.classList.add('damage-flash-animation');
                        setTimeout(() => armorValueEl.classList.remove('damage-flash-animation'), 400);
                        break;
                }
            };

            // --- Initial Setup & Listeners (Unchanged) ---
            flameheartBtn.addEventListener('click', () => {
                if (battleStarted) executeSpell('flameheart');
                else displaySpellInfo('flameheart');
            });
            frostbiteBtn.addEventListener('click', () => {
                if (battleStarted) executeSpell('frostbite');
                else displaySpellInfo('frostbite');
            });
            armorheartBtn.addEventListener('click', () => {
                if (battleStarted) executeSpell('armorheart');
                else displaySpellInfo('armorheart');
            });
            
            Object.values(modalMap).forEach(item => {
                item.button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openModal(item.modal);
                });
                item.modal.addEventListener('click', (e) => {
                    if (e.target === item.modal) closeModal(item.modal);
                });
            });

            const positionBattleSelector = (targetElement) => {
                 if (!targetElement) return;
                 const containerRect = enemyContainer.getBoundingClientRect();
                 const targetRect = targetElement.getBoundingClientRect();
                 const selectorWidth = 68, selectorHeight = 80;
                 battleSelector.style.width = `${selectorWidth}px`;
                 battleSelector.style.height = `${selectorHeight}px`;
                 const leftOffset = targetRect.left - containerRect.left + (targetRect.width - selectorWidth) / 2;
                 const topOffset = targetRect.top - containerRect.top + (targetRect.height - selectorHeight) / 2;
                 battleSelector.style.transform = `translate(${leftOffset}px, ${topOffset}px)`;
            };
            
            // --- Battle Mode Interaction (Unchanged) ---
            const battleDragStart = (e) => {
                const coords = getEventCoords(e); startX = coords.x; startY = coords.y; dragStartTime = Date.now(); isDragging = false; 
                document.addEventListener('mousemove', battleDragMove);
                document.addEventListener('touchmove', battleDragMove, { passive: false });
                document.addEventListener('mouseup', battleDragEnd);
                document.addEventListener('touchend', battleDragEnd);
            };
            const battleDragMove = (e) => {
                const coords = getEventCoords(e);
                if (!isDragging && Math.abs(coords.x - startX) > 10) isDragging = true;
                if (!isDragging) return;
                e.preventDefault();
                const enemyWrappers = currentEnemiesInBattle.map(e => e.ref);
                let targetIndex = -1;
                for (let i = 0; i < enemyWrappers.length; i++) {
                    const wrapper = enemyWrappers[i];
                    if (currentEnemiesInBattle[i].isDefeated) continue;
                    const wrapperRect = wrapper.getBoundingClientRect();
                    if (coords.x >= wrapperRect.left && coords.x <= wrapperRect.right) { targetIndex = i; break; }
                }
                if (targetIndex !== -1 && targetIndex !== currentBattleTargetIndex) {
                    currentBattleTargetIndex = targetIndex;
                    positionBattleSelector(enemyWrappers[currentBattleTargetIndex]);
                    updateEnemyDisplay(currentEnemiesInBattle[currentBattleTargetIndex]);
                }
            };
            const battleDragEnd = (e) => {
                document.removeEventListener('mousemove', battleDragMove);
                document.removeEventListener('touchmove', battleDragMove);
                document.removeEventListener('mouseup', battleDragEnd);
                document.removeEventListener('touchend', battleDragEnd);
                setTimeout(() => { isDragging = false; }, 50);
            };

            // --- BATTLE LOGIC (Unchanged) ---
            const playerTakesDamage = (damage) => {
                const damageAbsorbed = Math.min(playerState.armor, damage);
                if (damageAbsorbed > 0) {
                    playerState.armor -= damageAbsorbed;
                    armorValueEl.classList.add('damage-flash-animation');
                    setTimeout(() => armorValueEl.classList.remove('damage-flash-animation'), 400);
                }
                const remainingDamage = damage - damageAbsorbed;
                if (remainingDamage > 0) {
                    playerState.health = Math.max(0, playerState.health - remainingDamage);
                    healthValueEl.classList.add('damage-flash-animation');
                    setTimeout(() => healthValueEl.classList.remove('damage-flash-animation'), 400);
                }
                if (playerState.health <= 5 && playerState.health > 0) {
                    gameContainer.classList.add('border-pulse-animation', 'border-red-500');
                } else {
                    gameContainer.classList.remove('border-pulse-animation', 'border-red-500');
                    gameContainer.style.borderColor = '';
                }
                updatePlayerUI();
                if (playerState.health <= 0) {
                    attackBtn.disabled = true;
                    gameContainer.classList.remove('border-pulse-animation', 'border-red-500');
                }
            };
            const enemyAttackPhase = async () => {
                if (playerState.health <= 0) return;
                attackBtn.disabled = true;
                await delay(400);
                const livingEnemies = currentEnemiesInBattle.filter(enemy => !enemy.isDefeated && !enemy.isGift);
                for (const enemy of livingEnemies) {
                    if (playerState.health <= 0) break;
                    const enemyWrapper = enemy.ref;
                    enemyWrapper.classList.add('flip-animation');
                    setTimeout(() => enemyWrapper.classList.remove('flip-animation'), 500);
                    await delay(500); 
                    playerTakesDamage(enemy.isStamped ? 2 : 1);
                    const enemyInfo = enemyData[enemy.emoji];
                    if (enemyInfo.special && ['‚ò†Ô∏è', 'üïØÔ∏è', 'üêå'].includes(enemyInfo.special)) {
                        playerState.statusEffects[enemyInfo.special] = 1; 
                        updateStatusEffectsUI();
                    }
                    await delay(400);
                }
                if (playerState.health > 0) attackBtn.disabled = false;
            };
            const endBattle = () => {
                battleStarted = false; currentEnemiesInBattle = []; playerState.armor = playerState.maxArmor; sideWindowLeft.innerHTML = '<p class="p-1 text-xs italic text-zinc-400">Select an item or spell to see details.</p>'; 
                playerState.magic = playerState.maxMagic;
                playerState.statusEffects = { '‚ò†Ô∏è': 0, 'üïØÔ∏è': 0, 'üêå': 0, '‚ùáÔ∏è': 0, 'üåü': 0, '‚ö°': 0 };
                updateStatusEffectsUI(); waveCount++; updateWaveCounterUI();
                enemyContainer.innerHTML = `<div id="enemy-slider" class="absolute top-0 left-0 h-full bg-white/10 border-2 border-white/50 rounded-lg pointer-events-none" style="transition: transform 0.2s ease-out;"></div><div id="battle-selector" class="hidden absolute top-0 left-0 bg-amber-400/20 border-2 border-amber-400 rounded-lg pointer-events-none"></div>${Array(numIcons).fill('<span class="text-2xl relative z-10"></span>').join('')}`;
                enemySlider = document.getElementById('enemy-slider'); battleSelector = document.getElementById('battle-selector');
                enemyContainer.classList.remove('justify-center', 'gap-4', 'cursor-default');
                enemyContainer.classList.add('justify-around', 'cursor-grab', 'active:cursor-grabbing');
                battleDetailsContentEl.innerHTML = '<button id="start-battle-btn" class="bg-emerald-600 border-emerald-800 border-b-emerald-900 hover:bg-emerald-500 text-white font-bold text-lg py-3 px-10 rounded-lg shadow-lg transition-all duration-200 action-button font-title tracking-widest">Start Battle</button>';
                startBattleBtn = document.getElementById('start-battle-btn');
                if (startBattleBtn) startBattleBtn.addEventListener('click', startBattle);
                updatePlayerUI();
                enemyContainer.addEventListener('mousedown', dragStart); enemyContainer.addEventListener('touchstart', dragStart);
                reshuffleEnemies(); calculateSliderDimensions();
            };
            const checkBattleEnd = () => {
                if (currentEnemiesInBattle.every(enemy => enemy.isDefeated)) {
                    setTimeout(endBattle, 1500);
                }
            };
            const findNextTarget = (startIndex) => {
                const numEnemies = currentEnemiesInBattle.length;
                if (currentEnemiesInBattle.every(e => e.isDefeated)) { return -1; }
                let nextIndex = startIndex;
                do { nextIndex = (nextIndex + 1) % numEnemies; } while (currentEnemiesInBattle[nextIndex].isDefeated);
                return nextIndex;
            };
            const handleEnemyDefeat = (defeatedIndex) => {
                const enemy = currentEnemiesInBattle[defeatedIndex];
                if (!enemy || enemy.isDefeated) return;
                enemy.isDefeated = true;
                const enemyWrapper = enemy.ref;
                enemyWrapper.style.pointerEvents = 'none';
                enemyWrapper.classList.add('enemy-fade-out');
                if (!enemy.isGift) { playerState.killCount += enemy.isStamped ? 3 : 1; }
                updatePlayerUI();
                const nextTargetIndex = findNextTarget(defeatedIndex);
                setTimeout(() => {
                    enemyWrapper.classList.add('enemy-defeated'); 
                    if (nextTargetIndex !== -1) {
                        currentBattleTargetIndex = nextTargetIndex;
                        const nextTargetWrapper = currentEnemiesInBattle[nextTargetIndex].ref;
                        positionBattleSelector(nextTargetWrapper);
                        updateEnemyDisplay(currentEnemiesInBattle[nextTargetIndex]);
                    } else {
                        battleSelector.classList.add('hidden');
                    }
                }, 400);
                checkBattleEnd();
            };
            // --- Gift Modal Logic (Unchanged) ---
            const awardGiftBuff = (rewardType) => {
                switch (rewardType) {
                    case 'armor': playerState.maxArmor += 1; playerState.armor += 1; break;
                    case 'gold': playerState.gold += 15; break;
                    case 'crit': playerState.baseCritChance += 1; break;
                }
                updatePlayerUI();
            };
            const startGiftRandomizer = () => {
                const rewards = Array.from(giftRewardItems);
                const numRewards = rewards.length;
                const rewardTypes = ['armor', 'gold', 'crit'];
                const winningIndex = Math.floor(Math.random() * numRewards);
                const winningReward = rewardTypes[winningIndex];
                let delayMs = 150; 
                const totalSpins = 10 + winningIndex;
                let spinCount = 0;
                const continueGameHandler = async () => {
                    giftModal.classList.add('hidden');
                    handleEnemyDefeat(currentBattleTargetIndex);
                    if (!currentEnemiesInBattle.every(e => e.isDefeated)) {
                        await enemyAttackPhase();
                    } else if (playerState.health > 0) {
                        attackBtn.disabled = false;
                    }
                };
                const spin = () => {
                    if (spinCount >= totalSpins) {
                        rewards.forEach(r => r.classList.remove('reward-highlight-anim'));
                        rewards.forEach((rewardEl, index) => {
                            if (index === winningIndex) {
                                rewardEl.classList.add('reward-selected');
                                rewardEl.style.cursor = 'pointer';
                                rewardEl.addEventListener('click', continueGameHandler, { once: true });
                            } else {
                                rewardEl.classList.add('reward-fade-out');
                            }
                        });
                        awardGiftBuff(winningReward);
                        return;
                    }
                    rewards.forEach(r => r.classList.remove('reward-highlight-anim', 'reward-selected'));
                    const highlightIndex = spinCount % numRewards;
                    rewards[highlightIndex].classList.add('reward-highlight-anim');
                    if (spinCount > 5) delayMs += 50; 
                    spinCount++;
                    setTimeout(spin, delayMs);
                };
                spin();
            };
            const showGiftPopup = () => {
                attackBtn.disabled = true;
                giftModal.classList.remove('hidden');
                giftRewardItems = document.querySelectorAll('.gift-reward-item');
                giftRewardItems.forEach(item => {
                    item.classList.remove('reward-selected', 'reward-highlight-anim', 'reward-fade-out');
                    item.style.cursor = 'default';
                });
                startGiftRandomizer();
            };
            attackBtn.addEventListener('click', async () => {
                if (!battleStarted || playerState.health <= 0 || attackBtn.disabled) return;
                const targetEnemy = currentEnemiesInBattle[currentBattleTargetIndex];
                if (!targetEnemy || targetEnemy.isDefeated) return;
                const enemyWrapper = targetEnemy.ref;
                enemyWrapper.classList.add('shake-animation');
                setTimeout(() => enemyWrapper.classList.remove('shake-animation'), 300);
                let giftOpened = false;
                if (targetEnemy.isGift) {
                    giftOpened = true;
                    showGiftPopup();
                } else {
                    const attackPower = parseInt(attackValueEl.textContent, 10);
                    showDamageNumber(attackPower, enemyWrapper);
                    targetEnemy.hp = Math.max(0, targetEnemy.hp - attackPower);
                    const healthBarFill = enemyWrapper.querySelector('.bg-rose-600');
                    if (healthBarFill) healthBarFill.style.width = `${(targetEnemy.hp / targetEnemy.maxHp) * 100}%`;
                    updateEnemyDisplay(targetEnemy);
                    if (targetEnemy.hp <= 0) {
                        handleEnemyDefeat(currentBattleTargetIndex);
                    }
                }
                if (!giftOpened && !currentEnemiesInBattle.every(e => e.isDefeated)) {
                    await enemyAttackPhase();
                }
            });
            critBtn.addEventListener('click', () => {
                if (playerState.killCount >= 10) {
                    playerState.baseCritChance += 5;
                    playerState.killCount = 0;
                    updatePlayerUI();
                }
            });
            healthIconEl.addEventListener('click', () => {
                if (playerState.killCount >= 10) {
                    playerState.maxHealth++;
                    playerState.health = playerState.maxHealth;
                    playerState.killCount = 0;
                    updatePlayerUI();
                }
            });
            const startBattle = () => {
                if (battleStarted || isReshuffling) return;
                const flashOverlay = document.getElementById('screen-flash-overlay');
                if (flashOverlay) {
                    flashOverlay.classList.add('flash-animation');
                    setTimeout(() => flashOverlay.classList.remove('flash-animation'), 300);
                }
                const { iconWidth } = calculateSliderDimensions();
                const startIndex = Math.round(currentTranslateX / iconWidth);
                battleStarted = true; sideWindowLeft.innerHTML = ''; 
                enemyContainer.removeEventListener('mousedown', dragStart); enemyContainer.removeEventListener('touchstart', dragStart);
                if(startBattleBtn) startBattleBtn.remove();
                updatePlayerUI(); 
                enemyContainer.classList.remove('cursor-grab', 'active:cursor-grabbing'); enemyContainer.classList.add('cursor-default'); enemySlider.classList.add('hidden');
                const selectedEnemySpans = Array.from(document.querySelectorAll('#enemy-container > span')).slice(startIndex, startIndex + groupSize);
                currentEnemiesInBattle = selectedEnemySpans.map(span => {
                    const isStamped = span.classList.contains('emoji-red-stamp'), isGift = span.classList.contains('emoji-gold-glow');
                    const hp = isGift ? 1 : (isStamped ? 20 : 10);
                    return { emoji: span.textContent, isStamped, isGift, hp, maxHp: hp, isDefeated: false, ref: null };
                });
                enemyContainer.innerHTML = ''; enemyContainer.appendChild(battleSelector);
                enemyContainer.classList.remove('justify-around'); enemyContainer.classList.add('justify-center', 'gap-4');
                currentEnemiesInBattle.forEach((enemy, index) => {
                    const enemyWrapper = document.createElement('div');
                    enemyWrapper.className = 'relative cursor-pointer h-[70px] w-[60px] flex flex-col items-center justify-center transition-opacity duration-300';
                    const newEnemySpan = document.createElement('span');
                    newEnemySpan.className = 'text-4xl relative z-10'; newEnemySpan.textContent = enemy.emoji;
                    if (enemy.isStamped) newEnemySpan.classList.add('emoji-red-stamp');
                    if (enemy.isGift) newEnemySpan.classList.add('emoji-gold-glow');
                    enemyWrapper.appendChild(newEnemySpan);
                    if (!enemy.isGift) {
                        const healthBarContainer = document.createElement('div');
                        healthBarContainer.className = 'w-12 h-2 bg-black/50 rounded-full mt-2 border border-zinc-900';
                        healthBarContainer.innerHTML = `<div class="h-full bg-rose-600 rounded-full transition-all duration-300" style="width: 100%;"></div>`;
                        enemyWrapper.appendChild(healthBarContainer);
                    }
                    enemy.ref = enemyWrapper; 
                    enemyWrapper.addEventListener('click', () => {
                        if (isDragging || enemy.isDefeated) return;
                        currentBattleTargetIndex = index;
                        positionBattleSelector(enemyWrapper);
                        updateEnemyDisplay(currentEnemiesInBattle[index]);
                    });
                    enemyContainer.appendChild(enemyWrapper);
                });
                const firstLivingEnemyIndex = currentEnemiesInBattle.findIndex(e => !e.isDefeated);
                const firstEnemyWrapper = currentEnemiesInBattle[firstLivingEnemyIndex].ref;
                battleSelector.classList.remove('hidden');
                currentBattleTargetIndex = firstLivingEnemyIndex;
                updateEnemyDisplay(currentEnemiesInBattle[firstLivingEnemyIndex]);
                setTimeout(() => positionBattleSelector(firstEnemyWrapper), 50);
                enemyContainer.addEventListener('mousedown', battleDragStart);
                enemyContainer.addEventListener('touchstart', battleDragStart);
                if (!modalMap.shopBtn.modal.classList.contains('hidden')) renderShop();
            };
            
            // --- Final Setup (Unchanged) ---
            if(startBattleBtn) startBattleBtn.addEventListener('click', startBattle);
            calculateSliderDimensions();
            window.addEventListener('resize', calculateSliderDimensions);
            enemyContainer.addEventListener('mousedown', dragStart);
            enemyContainer.addEventListener('touchstart', dragStart);
            reshuffleBtn.addEventListener('click', () => { if (!battleStarted && !isReshuffling) reshuffleEnemies(); });
            reshuffleEnemies(true);
            updatePlayerUI(); 
            updateWaveCounterUI();
            updateStatusEffectsUI();
        });
    </script>
</body>
</html>

