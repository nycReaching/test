<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji Slot Machine</title>
    <style>
        /* --- Core Layout & Typography --- */
        @import url('https://fonts.googleapis.com/css2?family=Anton&display=swap');

        :root {
            --bg-color: #1a1a2e;
            --machine-color: #16213e;
            --window-bg: #0f3460;
            --text-color: #e94560;
            --highlight-color: #e94560;
            --button-bg: #3e236d; 
            --button-text: #ffffff;
            --font-family: 'Anton', sans-serif;
            --glow-color: rgba(233, 69, 96, 0.7);
        }

        html {
            height: -webkit-fill-available;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: var(--font-family);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--button-text);
            padding: clamp(5px, 2vw, 10px);
            box-sizing: border-box;
            margin: 0;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            letter-spacing: 1.5px; 
        }

        .game-container {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 2vh, 15px);
            padding: clamp(10px, 2vw, 15px);
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            border: 2px solid var(--highlight-color);
            box-shadow: 0 0 30px var(--glow-color), inset 0 0 10px rgba(255,255,255,0.1);
            width: 100%;
            max-width: 480px;
            box-sizing: border-box;
            max-height: 100vh;
            overflow-y: auto;
            transition: border-color 0.5s ease, box-shadow 0.5s ease; /* Smooth transition for theme change */
        }

        /* NEW: Class to switch game border to teal theme */
        .game-container.line-active-theme {
            --highlight-color: #00CED1; /* darkturquoise */
            --glow-color: rgba(0, 206, 209, 0.7);
        }
        
        /* --- Info Bars --- */
        .top-bar-container, .bottom-bar-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: clamp(5px, 2vw, 10px);
            width: 100%;
        }
        
        .bottom-bar-container {
            grid-template-columns: 1.5fr 2fr 1.5fr;
        }

        .info-box {
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-size: clamp(18px, 5vw, 24px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            min-height: 54px; 
            box-sizing: border-box; 
            transition: background-color 0.3s ease, filter 0.3s ease, transform 0.2s ease, background-image 0.3s ease, border-color 0.3s ease;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.6);
            position: relative;
        }
        .info-box:active {
            transform: scale(0.97);
        }
        
        /* --- Flippable Coin Display --- */
        .info-box-container { 
            perspective: 1000px; 
            height: 100%;
        }
        #coins-display { 
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s, background-color 0.3s;
            cursor: pointer;
            background-color: #ffd700; 
            border: 2px solid #e0bd00;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(#a17d00 45%, transparent 46%);
            background-size: 10px 10px;
        }
        #coins-display.is-flipped { transform: rotateY(180deg); }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }
        #coins-display .card-front {
            color: #ffffff;
            font-size: clamp(28px, 8vw, 36px);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            transition: color 0.3s ease, text-shadow 0.3s ease;
        }
        
        .card-back { 
            transform: rotateY(180deg); 
            flex-direction: column;
            position: relative;
            padding: 5px;
            box-sizing: border-box;
        }
        .bomb-icon {
            font-size: 1.6em;
            line-height: 1;
        }
        
        .bomb-mode-coin-count {
            position: absolute;
            bottom: 2px;
            right: 5px;
            font-size: clamp(14px, 4vw, 18px);
            color: white;
            background-color: transparent;
            padding: 1px 4px;
            border-radius: 4px;
            font-family: var(--font-family);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
        }


        #price-display { 
            background-color: #2E8B57; 
            color: #fff; 
            border: 2px solid #A4DE02; 
            font-size: clamp(32px, 9vw, 44px);
            cursor: pointer; 
            transition: all 0.2s ease; 
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 20 Q 10 10, 20 20 T 40 20' stroke='%23006400' fill='none' stroke-width='4' stroke-linecap='round'/%3E%3C/svg%3E");
            background-size: 20px 20px;
        }

        #selector-display { 
            background: repeating-linear-gradient(45deg, #2b8de2, #2b8de2 10px, #ff69b4 10px, #ff69b4 20px); 
            border: 2px solid #ff69b4;
            justify-content: space-around;
            padding: 0;
        }
        .selector-option {
            font-size: clamp(28px, 8vw, 38px);
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            padding: 5px;
        }
        .selector-option.deselected {
            filter: grayscale(100%) opacity(0.5);
            transform: scale(0.9);
        }

        .locked-feature {
            filter: grayscale(100%);
            pointer-events: none;
            opacity: 0.7;
        }
        .lock-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(32px, 9vw, 44px);
            color: white;
            text-shadow: 2px 2px 5px rgba(0,0,0,0.8);
            z-index: 10;
            display: none;
        }
        .locked-feature .lock-icon {
            display: block;
        }


        #gamble-button { 
            background-color: #98FB98; 
            color: #006400; 
            border: 4px solid #006400; 
            cursor: pointer; 
            transition: all 0.2s ease; 
        }
        
        .bottom-box-2 {
            background-color: #000000;
            background-image: 
                linear-gradient(45deg, #4B0082 25%, transparent 25%), 
                linear-gradient(-45deg, #4B0082 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #4B0082 75%),
                linear-gradient(-45deg, transparent 75%, #4B0082 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 2px solid #4B0082;
            padding: 0 10px;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            padding: 0;
        }
        .slider-control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .slider-label {
            font-size: clamp(24px, 7vw, 30px);
        }
        #clown-counter {
            font-size: clamp(14px, 4vw, 18px);
            line-height: 1;
            margin-top: -5px;
            color: #ff69b4;
            text-shadow: 1px 1px 2px #000;
        }

        .left-buttons-container {
            display: flex;
            gap: 5px;
        }
        
        .left-buttons-container .info-box {
            flex: 1 1 0;
            width: 0;
            font-size: 20px;
        }
        
        #tokens-button {
            background-color: #007bff;
            border: 4px solid #0056b3;
            color: white;
            cursor: pointer;
        }

        .right-buttons-container {
            display: flex;
            gap: 5px;
        }

        #link-button, #help-button { 
            flex: 1 1 0;
            width: 0;
            font-size: 20px;
        }

        #link-button {
            background-color: #ffffff;
            color: #1a1a2e;
            border: 4px solid #a0a0a0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        #link-button.link-used {
            background-color: #4a4a4a;
            color: #888;
            border-color: #333;
            cursor: not-allowed;
            filter: grayscale(80%);
        }
        #link-button:disabled { background-color: #555; cursor: not-allowed; color: #888; }

        #help-button {
            background-color: #FFA500;
            color: #ffffff;
            border: 4px solid #cc8400;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        @keyframes green-glow-button {
            0%, 100% {
                box-shadow: 0 0 10px 2px #32cd32, 0 0 5px 0px #adff2f inset;
                background-color: #32cd32;
            }
            50% {
                box-shadow: 0 0 20px 5px #adff2f, 0 0 10px 2px #32cd32 inset;
                background-color: #55ff55;
            }
        }

        #gamble-button.gamble-active {
            color: #fff;
            border-color: #fff;
            transform: scale(1.05);
            animation: green-glow-button 1.5s infinite ease-in-out;
        }

        .machine {
            background-color: #000000;
            background-image: 
                linear-gradient(45deg, #4B0082 25%, transparent 25%), 
                linear-gradient(-45deg, #4B0082 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #4B0082 75%),
                linear-gradient(-45deg, transparent 75%, #4B0082 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            padding: clamp(10px, 3vw, 15px);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(10px, 3vw, 15px);
            border: 2px solid #4B0082;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            box-shadow: inset 0 0 15px rgba(75, 0, 130, 0.6);
        }
        
        .controls {
            background-image: linear-gradient(to bottom, #16213e, #0f3460);
            padding: clamp(10px, 3vw, 15px);
            border-radius: 15px;
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            align-items: center;
            gap: clamp(10px, 3vw, 15px);
            border: 2px solid #0f3460;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .slot-windows {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(5px, 2vw, 10px);
            width: 100%;
            background-color: #000;
            padding: clamp(5px, 2vw, 10px);
            border-radius: 10px;
            border: 2px solid #0a2444;
            box-sizing: border-box;
        }

        .reel-window {
            aspect-ratio: 1 / 1; 
            width: 100%;
            background: radial-gradient(circle at 70% 30%, #2a4b7c, var(--window-bg) 70%);
            border-radius: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(24px, 10vw, 50px);
            overflow: hidden; 
            box-shadow: 3px 3px 8px rgba(0,0,0,0.5), inset 1px 1px 2px rgba(255,255,255,0.2), 0 0 10px rgba(42, 75, 124, 0.5);
            border: 2px solid #0a2444;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, filter 0.3s ease-out, background 0.3s ease;
            position: relative;
        }
        
        .reel-window.bombed {
            background: radial-gradient(circle, #555, #222);
        }

        .bomb-counter {
            position: absolute;
            bottom: 5px;
            right: 8px;
            font-size: clamp(14px, 4vw, 18px);
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 2px 6px;
            border-radius: 5px;
            font-family: sans-serif;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }
        
        #spin-button {
            padding: 15px 20px;
            font-size: clamp(22px, 6vw, 30px);
            background-color: #e60023;
            color: var(--button-text);
            border: 2px solid #990017;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.3), 0 0 20px rgba(230, 0, 35, 0.5);
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s, background-color 0.2s, background-image 0.2s, border-color 0.2s, color 0.2s;
            text-transform: uppercase;
            letter-spacing: 2px;
            width: 100%;
            font-family: var(--font-family);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        }

        #spin-button:active:not(:disabled) {
            transform: translateY(2px) scale(0.98);
            box-shadow: inset 0 -1px 0 rgba(0,0,0,0.3);
        }

        #spin-button:disabled {
            background-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            transform: scale(1);
            border-color: #333;
        }

        .reel-inventories {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(5px, 2vw, 10px);
            width: 100%;
            box-sizing: border-box;
            padding: 0 clamp(5px, 2vw, 10px);
        }

        .inventory {
            width: 100%;
            padding: 2px;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: clamp(10px, 3vw, 14px);
            min-height: 50px;
            box-sizing: border-box;
            border: 2px solid transparent;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            cursor: pointer;
        }
        .inventory:active {
            transform: scale(0.97);
        }

        .inventory.selected {
            border-color: gold;
            box-shadow: 0 0 10px gold, inset 0 0 5px rgba(255, 215, 0, 0.3);
        }

        .inventory-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            width: 100%;
            border-radius: 6px;
            position: relative; 
            transition: all 0.2s ease;
        }
        
        .inventory-row.blacked-out {
            background-color: #111;
            border-color: #333;
        }
        .inventory-row.blacked-out .symbol-display {
            opacity: 0.1;
        }
        
        .inventory-row.merged-row {
            grid-template-columns: 1fr;
            text-align: center;
        }

        .inventory .symbol-display {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 20px;
            font-size: clamp(14px, 4vw, 18px);
        }
        
        .inventory-row.link-highlight::after, .inventory-row.linked::after {
            content: '';
            position: absolute;
            top: 0;
            left: -2px; 
            width: calc(100% + 4px); 
            height: 100%;
            background: rgba(255, 255, 255, 0.25);
            pointer-events: none;
            border-radius: 6px;
        }
        
        /* UPDATED: More subtle highlight for potential lines */
        .inventory-row.line-possible::after {
            background: rgba(0, 206, 209, 0.35) !important; /* Lighter teal */
            box-shadow: inset 0 0 6px rgba(0, 206, 209, 0.5);
        }

        /* NEW: Stronger glow animation for completed lines */
        @keyframes teal-glow-pulse {
            0%, 100% {
                background: rgba(0, 206, 209, 0.6);
                box-shadow: inset 0 0 10px #00CED1;
            }
            50% {
                background: rgba(64, 224, 208, 0.7); /* turquoise */
                box-shadow: inset 0 0 18px #40E0D0;
            }
        }

        .inventory-row.line-connected::after {
            animation: teal-glow-pulse 1.5s infinite ease-in-out;
        }


        .control-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(5px, 2vw, 10px);
            width: 100%;
        }
        
        .btn {
            padding: 12px 5px;
            border-radius: 8px;
            border: 2px solid transparent;
            background-color: var(--button-bg);
            color: var(--button-text);
            font-size: clamp(14px, 4vw, 16px);
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-family);
            letter-spacing: 1.5px;
        }
        
        .btn:active:not(:disabled) { transform: translateY(0px) scale(0.95); }
        
        .symbol-btn { 
            font-size: clamp(20px, 7vw, 30px);
            padding: 15px 5px;
            border-width: 2px;
            border-style: solid;
            background-color: #000000;
            letter-spacing: 0;
            position: relative;
        }
        
        #reset-symbols-btn {
            background-color: #000000;
            border-color: #999999;
        }

        .symbol-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: #2a2a2a;
            transform: none;
        }
        .spinning { filter: blur(4px); }

        @keyframes win-pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); text-shadow: 0 0 25px #fffc79; }
            100% { transform: scale(1); }
        }

        .win-animation { animation: win-pulse 1s ease-in-out; }

        @keyframes shake {
          0% { transform: translate(1px, 1px) rotate(0deg); }
          10% { transform: translate(-1px, -2px) rotate(-1deg); }
          20% { transform: translate(-3px, 0px) rotate(1deg); }
          30% { transform: translate(3px, 2px) rotate(0deg); }
          40% { transform: translate(1px, -1px) rotate(1deg); }
          50% { transform: translate(-1px, 2px) rotate(-1deg); }
          60% { transform: translate(-3px, 1px) rotate(0deg); }
          70% { transform: translate(3px, 1px) rotate(-1deg); }
          80% { transform: translate(-1px, -1px) rotate(1deg); }
          90% { transform: translate(1px, 2px) rotate(0deg); }
          100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shake-animation {
            animation: shake 0.5s;
        }
        
        @keyframes inventory-shake {
          0% { transform: translate(1px, 1px) rotate(0deg); }
          10% { transform: translate(-2px, -3px) rotate(-2deg); }
          20% { transform: translate(-4px, 0px) rotate(2deg); }
          30% { transform: translate(4px, 3px) rotate(0deg); }
          40% { transform: translate(2px, -2px) rotate(2deg); }
          50% { transform: translate(-2px, 3px) rotate(-2deg); }
          60% { transform: translate(-4px, 2px) rotate(0deg); }
          70% { transform: translate(4px, 2px) rotate(-2deg); }
          80% { transform: translate(-2px, -2px) rotate(2deg); }
          90% { transform: translate(2px, 3px) rotate(0deg); }
          100% { transform: translate(2px, -3px) rotate(-2deg); }
        }

        .inventory-shake-animation {
            animation: inventory-shake 0.5s;
        }

        @keyframes lime-shake {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-3px, 0) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translate(3px, 0) rotate(2deg); }
        }
        .lime-shake-animation {
            animation: lime-shake 1.5s ease-in-out;
        }

        @keyframes clover-glow {
            0%, 100% { text-shadow: 0 0 5px #32cd32, 0 0 10px #32cd32; }
            50% { text-shadow: 0 0 15px #adff2f, 0 0 20px #adff2f; }
        }
        .clover {
            animation: clover-glow 1.5s infinite ease-in-out;
        }

        @keyframes bomb-glow {
            0%, 100% { text-shadow: 0 0 8px #ff0000, 0 0 12px #ff4500, 0 0 16px #ff0000; }
            50% { text-shadow: 0 0 16px #ff4500, 0 0 20px #ff0000, 0 0 24px #ff4500; }
        }
        .bomb-symbol-glow {
            animation: bomb-glow 1.2s infinite ease-in-out;
        }

        @keyframes bonus-glow {
            0%, 100% { text-shadow: 0 0 8px #fff, 0 0 12px #fff, 0 0 16px #fff; }
            50% { text-shadow: 0 0 16px #eee, 0 0 20px #eee, 0 0 24px #eee; }
        }
        .bonus-symbol {
            animation: bonus-glow 1.5s infinite ease-in-out;
        }
        .bonus-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 16px;
            color: #FFD700;
            background-color: transparent;
            width: 24px;
            height: 24px;
            display: none;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            font-weight: bold;
            text-shadow: 0 0 3px black, 0 0 5px black;
        }
        .bonus-symbol .bonus-indicator {
            display: flex;
        }


        #message-box {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            background: radial-gradient(circle, rgba(255, 223, 0, 0.95), rgba(255, 215, 0, 0.85));
            color: #4a2c00;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #fff3a8;
            box-shadow: 0 0 15px 5px rgba(255, 215, 0, 0.5);
            font-size: clamp(18px, 5vw, 24px);
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        #message-box.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }
        
        .custom-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: repeating-linear-gradient(
                45deg,
                #2b8de2,
                #2b8de2 10px,
                #ff69b4 10px,
                #ff69b4 20px
            );
            outline: none;
            opacity: 0.9;
            transition: opacity .2s;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .custom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #ff69b4;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -7px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .custom-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #ff69b4;
            border: 2px solid #333;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #2c2c3e;
            color: #f0f0f0;
            margin: auto;
            padding: 20px 30px;
            border: 2px solid var(--highlight-color);
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
            font-family: var(--font-family);
            box-shadow: 0 0 25px rgba(233, 69, 96, 0.4);
            max-height: 80vh;
            overflow-y: auto;
        }

        #help-modal .modal-content {
            background-color: #0f3460; /* Dark blue base */
            background-image: repeating-linear-gradient(
                -45deg,
                rgba(255, 0, 0, 0.7),      /* Red */
                rgba(255, 0, 0, 0.7) 20px,
                rgba(255, 165, 0, 0.7) 20px, /* Orange */
                rgba(255, 165, 0, 0.7) 40px,
                rgba(255, 255, 0, 0.7) 40px, /* Yellow */
                rgba(255, 255, 0, 0.7) 60px,
                rgba(0, 128, 0, 0.7) 60px,  /* Green */
                rgba(0, 128, 0, 0.7) 80px,
                rgba(0, 0, 255, 0.7) 80px,  /* Blue */
                rgba(0, 0, 255, 0.7) 100px,
                rgba(138, 43, 226, 0.7) 100px, /* Violet */
                rgba(138, 43, 226, 0.7) 120px
            );
            background-attachment: scroll;
            border-color: #2b8de2;
            box-shadow: 0 0 25px rgba(43, 141, 226, 0.4);
        }
        
        #tokens-modal .modal-content {
            background-color: #8B4513; /* SaddleBrown */
            background-image: 
                linear-gradient(45deg, #D4AF37 25%, transparent 25%), 
                linear-gradient(-45deg, #D4AF37 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #D4AF37 75%),
                linear-gradient(-45deg, transparent 75%, #D4AF37 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-color: #D4AF37;
        }
        
        .modal-content h2, .modal-content h3 {
            color: var(--highlight-color);
            text-align: center;
            margin-top: 10px;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative; 
            z-index: 2;
        }

        #help-modal .modal-content h2, #help-modal .modal-content h3 {
             color: #ffffff;
             text-shadow: 0 0 10px #2b8de2;
        }

        .modal-content h3 {
            margin-top: 25px;
            margin-bottom: 5px;
            border-bottom: 1px solid var(--highlight-color);
            padding-bottom: 5px;
        }

        #help-modal .modal-content h3 {
            border-bottom: 1px solid #2b8de2;
        }

        #tokens-modal h2 {
            color: #fff;
        }

        .modal-content p, .modal-content ul {
            position: relative; 
            z-index: 2;
        }

        .modal-content p {
            line-height: 1.6;
            margin-bottom: 1em;
            text-align: center;
        }
        .modal-content ul {
            list-style-type: none;
            padding: 0;
        }
        .modal-content li {
            margin: 10px 0;
            letter-spacing: 1px;
            text-align: left;
            background-color: #1a253c;
            padding: 8px;
            border-radius: 5px;
        }
        
        #help-modal #core-gameplay-list strong { color: #c398fb; } /* Purple */
        #help-modal #costs-list strong { color: #98fb98; } /* Green */
        #help-modal #special-mechanics-list strong { color: #e94560; } /* Red */
        #help-modal #payouts-list strong { color: #f9d423; } /* Yellow */
        #help-modal #unlocks-list strong { color: #00bfff; } /* Blue */

        .modal-content .symbol {
            font-size: 1.2em;
            display: inline-block;
            width: 25px;
            text-align: center;
        }
        
        .token-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }
        .token-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-image: linear-gradient(to bottom, #16213e, #0f3460);
            padding: 10px 15px;
            border-radius: 8px;
            border-width: 2px;
            border-style: solid;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-family);
            color: var(--button-text);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #unlock-lime-btn { border-color: #32cd32; }
        #unlock-selector-btn { border-color: #e60023; }
        #reset-links-btn { border-color: #cccccc; }

        .token-option:not(:disabled):hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        .token-option:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-image: none;
            background-color: #333;
            color: #888;
            border-color: #555;
        }
        .token-icon {
            font-size: 2em;
        }
        .token-description {
            flex-grow: 1;
            text-align: center;
            letter-spacing: 1.5px;
            font-size: clamp(16px, 4vw, 20px);
        }
        .token-cost {
            font-weight: bold;
            font-size: clamp(16px, 4vw, 20px);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 32px;
            position: absolute;
            top: 5px;
            right: 15px;
            z-index: 5; /* Ensure close button is on top */
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="game-container">
        <div class="top-bar-container">
            <div class="info-box-container">
                <div id="coins-display" class="info-box">
                    <div class="card-face card-front">100</div>
                    <div class="card-face card-back">
                        <span class="bomb-icon">💣</span>
                        <span class="bomb-mode-coin-count"></span>
                    </div>
                </div>
            </div>
            <div id="price-display" class="info-box">
                🍋‍🟩
                <div class="lock-icon">🔒</div>
            </div>
            <div id="selector-display" class="info-box">
                <span class="selector-option" data-choice="balloon">🎈</span>
                <span class="selector-option" data-choice="flower">🌼</span>
                <div class="lock-icon">🔒</div>
            </div>
        </div>

        <div class="machine">
            <div id="message-box"></div>
            <div class="slot-windows">
                <div class="reel-window" data-reel-window="0"><div class="reel-display">❌</div></div>
                <div class="reel-window" data-reel-window="1"><div class="reel-display">❌</div></div>
                <div class="reel-window" data-reel-window="2"><div class="reel-display">❌</div></div>
                <div class="reel-window" data-reel-window="3"><div class="reel-display">❌</div></div>
            </div>
            <div class="reel-inventories">
                <div class="inventory" id="inventory-0" data-reel="0"></div>
                <div class="inventory" id="inventory-1" data-reel="1"></div>
                <div class="inventory" id="inventory-2" data-reel="2"></div>
                <div class="inventory" id="inventory-3" data-reel="3"></div>
            </div>
            <div class="controls">
                <div class="control-grid symbol-buttons">
                    <button class="btn symbol-btn">🍒<span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn">🍊<span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn">🍇<span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn">🍋‍🟩<span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn">🔔<span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn">💎<span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn"><span class="clown-icon">🤡</span><span class="bonus-indicator">+1</span></button>
                    <button class="btn symbol-btn" id="reset-symbols-btn">🗑️</button>
                </div>
            </div>
            <button id="spin-button"></button>
        </div>
        
        <div class="bottom-bar-container">
            <div class="left-buttons-container">
                <div id="tokens-button" class="info-box">🔒</div>
                <div id="gamble-button" class="info-box">🍀</div>
            </div>
            <div class="info-box bottom-box-2 slider-container">
                <input type="range" min="0" max="4" value="0" step="1" class="custom-slider">
            </div>
            <div class="right-buttons-container">
                <div id="link-button" class="info-box">⬜ Link</div>
                <div id="help-button" class="info-box">❔</div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="help-modal">&times;</span>
            <h2>How to Play</h2>
            <p>Strategically add symbols to the four inventories, then spin to win!</p>

            <h3>Core Gameplay</h3>
            <ul id="core-gameplay-list">
                <li><strong>Select an Inventory:</strong> Tap one of the four inventory boxes below the slot windows to select it.</li>
                <li><strong>Add Symbols:</strong> Pay coins to add symbols to the 8 slots in the selected inventory. Each symbol can only be added once per inventory.</li>
                <li><strong>Spin:</strong> Pay the spin cost to draw one random symbol from each of the four inventories.</li>
            </ul>

            <h3>Costs</h3>
            <ul id="costs-list">
                <li><strong>Spin:</strong> Starts at <strong>5 🪙</strong>. Increases by 1 for each symbol that appears 4 or more times in a single inventory.</li>
                <li><strong>Add Symbol:</strong> <strong>2 🪙</strong> per symbol.</li>
                <li><strong>Reset Inventory (🗑️):</strong> <strong>50 🪙</strong> to clear all symbols from the selected inventory.</li>
            </ul>

            <h3>Special Mechanics</h3>
            <ul id="special-mechanics-list">
                <li><strong>Bomb Mode (💣):</strong> Click the coin display to toggle. Spins are <strong>FREE</strong>, but have a 15% chance to add a 💣 to a random inventory slot. If the 💣 is drawn on a spin, that reel is disabled for 10 spins.</li>
                <li><strong>Clover Mode (🍀):</strong> Costs <strong>2 🪙</strong> to activate. When adding a symbol, there's a 50% chance it becomes a 🍀. If it fails, the original symbol is permanently removed from that inventory's options.</li>
                <li><strong>Link (⬜):</strong> Costs <strong>5 🪙</strong>. Links two symbols in a random row on the selected inventory, creating a new symbol.
                    <ul>
                        <li><span class="symbol">🍒</span> + <span class="symbol">🍊</span> (any two fruits) → <span class="symbol">🍬</span> (Candy)</li>
                        <li><span class="symbol">🔔</span> + <span class="symbol">💎</span> → <span class="symbol">💍</span> (Ring)</li>
                    </ul>
                </li>
                <li>
                    <strong>Clown Rotation (🤡):</strong> Use the slider to rotate the Clown. The more it's rotated, the higher the risk and reward!
                    <ul>
                        <li><strong>Upright:</strong> 100% Wild, no bonus.</li>
                        <li><strong>Slight Tilt:</strong> 85% Wild, +25 coin bonus on wins.</li>
                        <li><strong>Sideways:</strong> 75% Wild, +50 coin bonus on wins.</li>
                        <li><strong>Mostly Flipped:</strong> 65% Wild, 2x multiplier on wins.</li>
                        <li><strong>Upside Down:</strong> 15% Wild, 5x multiplier on wins.</li>
                    </ul>
                </li>
            </ul>

            <h3>Symbol Payouts</h3>
            <p>Match 3 or 4 symbols across the reels to win. The <strong>Clown (🤡)</strong> is WILD and substitutes for any symbol below (if it doesn't fail!).</p>
            <ul id="payouts-list">
                <li><strong><span class="symbol">🍬</span> (Candy):</strong> <strong>50 🪙</strong> for each that appears.</li>
                <li><strong><span class="symbol">💍</span> (Ring):</strong> <strong>75 🪙</strong> for each that appears.</li>
                <li><strong><span class="symbol">🍒</span><span class="symbol">🍊</span><span class="symbol">🍇</span><span class="symbol">🍋‍🟩</span>:</strong> 3-of-a-kind: <strong>50 🪙</strong> / 4-of-a-kind: <strong>100 🪙</strong></li>
                <li><strong><span class="symbol">🔔</span>:</strong> 3-of-a-kind: <strong>75 🪙</strong> / 4-of-a-kind: <strong>150 🪙</strong></li>
                <li><strong><span class="symbol">💎</span>:</strong> 3-of-a-kind: <strong>100 🪙</strong> / 4-of-a-kind: <strong>200 🪙</strong></li>
                <li><strong><span class="symbol">🍀</span>:</strong> 3-of-a-kind: <strong>250 🪙</strong> / 4-of-a-kind: <strong>500 🪙</strong></li>
            </ul>

            <h3>Unlockables (via Tokens 🔒)</h3>
            <ul id="unlocks-list">
                <li><strong>Unlock Lime Removal (1 🪙):</strong> Unlocks the 🍋‍🟩 button, which removes all limes from all inventories when clicked.</li>
                <li><strong>Unlock Selector (1 🪙):</strong> Unlocks the 🎈/🌼 button. (Functionality not yet implemented).</li>
                <li><strong>Reset Links (1 🪙):</strong> Resets all used Links, allowing you to use the Link button again on every inventory.</li>
            </ul>
        </div>
    </div>
    
    <div id="tokens-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal="tokens-modal">&times;</span>
            <h2>Tokens</h2>
            <div class="token-options">
                <button class="token-option" id="unlock-lime-btn">
                    <span class="token-icon">🟢</span>
                    <span class="token-description">Unlock Lime Removal</span>
                    <span class="token-cost">1 🪙</span>
                </button>
                <button class="token-option" id="unlock-selector-btn">
                    <span class="token-icon">🔴</span>
                    <span class="token-description">Unlock Selector</span>
                    <span class="token-cost">1 🪙</span>
                </button>
                <button class="token-option" id="reset-links-btn">
                    <span class="token-icon">⚪</span>
                    <span class="token-description">Reset Links</span>
                    <span class="token-cost">1 🪙</span>
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BLANK_SYMBOL = '❌';
            const ELIMINATED_SLOT = 'REMOVED'; 
            const BOMB_SYMBOL = '💣';
            const BOMB_EXPLOSION_SYMBOL = '💥';
            const BOMB_DURATION = 10;
            const LUCKY_SYMBOL = '🍀';
            const CANDY_SYMBOL = '🍬'; 
            const RING_SYMBOL = '💍'; 
            const FRUITS = ['🍒', '🍊', '🍇', '🍋‍🟩']; 
            const SPECIAL_SYMBOLS = ['🤡', '🍀']; 
            
            const REEL_COUNT = 4;
            const SYMBOLS_PER_REEL = 8;
            const ROWS_PER_REEL = 4;
            const BASE_SPIN_PRICE = 5;
            const SYMBOL_ADD_COST = 2;

            let totalCoins = 100;
            let spinPrice = BASE_SPIN_PRICE;
            let selectedReel = 0;
            const reels = Array(REEL_COUNT).fill(0).map(() => Array(SYMBOLS_PER_REEL).fill(BLANK_SYMBOL));
            let gambleModeActive = false;
            let riskModeActive = false;
            let isAnimating = false;
            let currentClownRotation = 0;
            let clownRiskLevel = 0; 
            const usedSymbols = {};
            
            let symbolsAddedCounter = 0;
            let bonusSymbol = null;
            let activeSelection = 'balloon';

            let isLimeUnlocked = false;
            let isSelectorUnlocked = false;

            let bombCounters = [0, 0, 0, 0];

            let linkedReels = new Set();
            let linkedRowState = {};

            const gameContainer = document.querySelector('.game-container');
            const reelInventoriesContainer = document.querySelector('.reel-inventories');
            const symbolButtonsContainer = document.querySelector('.symbol-buttons');
            const spinButton = document.getElementById('spin-button');
            const inventoryDisplays = Array(REEL_COUNT).fill(0).map((_, i) => document.getElementById(`inventory-${i}`));
            const reelWindowElements = document.querySelectorAll('.reel-window');
            const reelDisplayElements = Array.from(reelWindowElements).map(w => w.querySelector('.reel-display'));
            const coinsDisplay = document.getElementById('coins-display');
            const priceDisplay = document.getElementById('price-display');
            const selectorDisplay = document.getElementById('selector-display');
            const messageBox = document.getElementById('message-box');
            const linkButton = document.getElementById('link-button');
            const gambleButton = document.getElementById('gamble-button');
            const helpButton = document.getElementById('help-button');
            const helpModal = document.getElementById('help-modal');
            const resetButton = document.getElementById('reset-symbols-btn');
            const clownSlider = document.querySelector('.custom-slider');
            
            const tokensButton = document.getElementById('tokens-button');
            const tokensModal = document.getElementById('tokens-modal');
            const closeButtons = document.querySelectorAll('.close-button');

            const unlockLimeBtn = document.getElementById('unlock-lime-btn');
            const unlockSelectorBtn = document.getElementById('unlock-selector-btn');
            const resetLinksBtn = document.getElementById('reset-links-btn');

            /**
             * UPDATED: Checks for and highlights potential and completed lines with more flexible logic.
             * A line is valid if each adjacent linked reel is at most 1 row away from the previous one.
             */
            const checkAndHighlightLines = () => {
                // Clear all previous line highlights and the theme
                document.querySelectorAll('.inventory-row.line-connected, .inventory-row.line-possible').forEach(row => {
                    row.classList.remove('line-connected', 'line-possible');
                });
                gameContainer.classList.remove('line-active-theme');

                const linked = Object.entries(linkedRowState)
                    .map(([k, v]) => [parseInt(k), v])
                    .sort((a, b) => a[0] - b[0]);

                if (linked.length < 1) return;

                const allValidPaths = [];
                let currentPath = [linked[0]];

                // Iterate through linked reels to find all valid *contiguous* paths
                for (let i = 1; i < linked.length; i++) {
                    const prevReel = linked[i - 1];
                    const currentReel = linked[i];

                    const isAdjacent = currentReel[0] === prevReel[0] + 1;
                    const isCloseEnough = Math.abs(currentReel[1] - prevReel[1]) <= 1;

                    if (isAdjacent && isCloseEnough) {
                        currentPath.push(currentReel);
                    } else {
                        if (currentPath.length >= 2) {
                            allValidPaths.push([...currentPath]);
                        }
                        currentPath = [currentReel];
                    }
                }
                
                // Add the last processed path
                if (currentPath.length >= 2) {
                    allValidPaths.push([...currentPath]);
                }

                let isFullLine = false;
                // Apply highlights to all found valid paths
                allValidPaths.forEach(path => {
                    if (path.length === REEL_COUNT) {
                        isFullLine = true;
                    }
                    const highlightClass = path.length === REEL_COUNT ? 'line-connected' : 'line-possible';
                    path.forEach(([index, row]) => {
                        const inventory = inventoryDisplays[index];
                        const rowToHighlight = inventory.children[row];
                        if (rowToHighlight) {
                            rowToHighlight.classList.add(highlightClass);
                        }
                    });
                });

                // If a full line exists, apply the theme to the game container
                if (isFullLine) {
                    gameContainer.classList.add('line-active-theme');
                }
            };

            const applyClownRotation = () => {
                const clownSymbol = '🤡';
                const rotationStyle = `rotate(${currentClownRotation}deg)`;

                document.querySelectorAll('.clown-icon').forEach(icon => {
                    icon.style.transform = rotationStyle;
                    icon.style.display = 'inline-block';
                });

                document.querySelectorAll('.reel-display, .inventory .symbol-display').forEach(el => {
                    if (el.textContent.includes(clownSymbol)) {
                        if (el.textContent.trim() === clownSymbol) {
                            el.style.transform = rotationStyle;
                        }
                    } else {
                        el.style.transform = 'none';
                    }
                });
            };

            const initializeGame = () => {
                for (let i = 0; i < REEL_COUNT; i++) {
                    const availableFruits = [...FRUITS];
                    const firstFruitIndex = Math.floor(Math.random() * availableFruits.length);
                    const firstFruit = availableFruits.splice(firstFruitIndex, 1)[0];
                    reels[i][0] = firstFruit;
                    const secondFruitIndex = Math.floor(Math.random() * availableFruits.length);
                    const secondFruit = availableFruits[secondFruitIndex];
                    reels[i][1] = secondFruit;
                }
            };

            const showWinMessage = (text, duration = 1000) => {
                messageBox.innerHTML = text; // Use innerHTML to support <br>
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            };

            const calculatePriceModifier = () => {
                let modifier = 0;
                reels.forEach(reel => {
                    const counts = reel.reduce((acc, symbol) => {
                        if (symbol !== BLANK_SYMBOL && symbol !== ELIMINATED_SLOT) {
                            acc[symbol] = (acc[symbol] || 0) + 1;
                        }
                        return acc;
                    }, {});
                    Object.values(counts).forEach(count => {
                        if (count >= 4) {
                            modifier++;
                        }
                    });
                });
                return modifier;
            };

            const updateTopBar = () => {
                const priceModifier = calculatePriceModifier();
                spinPrice = BASE_SPIN_PRICE + priceModifier;
                const coinsDisplayFront = coinsDisplay.querySelector('.card-front');
                coinsDisplayFront.textContent = totalCoins;

                const coinsDisplayBackCounter = coinsDisplay.querySelector('.bomb-mode-coin-count');
                if (coinsDisplayBackCounter) {
                    coinsDisplayBackCounter.textContent = totalCoins;
                }
                
                const riskPolkaDotBg = 'radial-gradient(rgba(0,0,0,0.25) 45%, transparent 46%)';

                if (riskModeActive) {
                    spinButton.innerHTML = `💣 Spin`;
                    spinButton.style.backgroundImage = riskPolkaDotBg;
                    spinButton.style.backgroundSize = '12px 12px';
                    spinButton.style.backgroundColor = '#e60023';
                    spinButton.style.borderColor = '#ff4500';
                    spinButton.style.color = '#ffffff';
                    spinButton.style.textShadow = '2px 2px 4px rgba(0,0,0,0.7)';
                    
                    coinsDisplay.style.backgroundImage = riskPolkaDotBg;
                    coinsDisplay.style.backgroundSize = '12px 12px';
                    coinsDisplay.style.backgroundColor = '#e60023';
                    coinsDisplay.style.borderColor = '#ff4500';

                } else {
                    spinButton.innerHTML = `🪙 ${spinPrice} &nbsp; Spin`;
                    spinButton.style.backgroundImage = '';
                    spinButton.style.backgroundSize = '';
                    spinButton.style.backgroundColor = '#e60023';
                    spinButton.style.borderColor = '#990017';
                    spinButton.style.color = 'var(--button-text)';
                    spinButton.style.textShadow = '2px 2px 5px rgba(0, 0, 0, 0.5)';

                    coinsDisplay.style.backgroundImage = 'radial-gradient(#a17d00 45%, transparent 46%)';
                    coinsDisplay.style.backgroundSize = '10px 10px';
                    coinsDisplay.style.backgroundColor = '#ffd700';
                    coinsDisplay.style.borderColor = '#e0bd00';
                }
                
                applyClownRotation();
            };
            
            const updateSelectorUI = () => {
                document.querySelectorAll('.selector-option').forEach(opt => {
                    if (opt.dataset.choice === activeSelection) {
                        opt.classList.remove('deselected');
                    } else {
                        opt.classList.add('deselected');
                    }
                });
            };

            const updateLockedFeaturesUI = () => {
                priceDisplay.classList.toggle('locked-feature', !isLimeUnlocked);
                selectorDisplay.classList.toggle('locked-feature', !isSelectorUnlocked);
                
                unlockLimeBtn.disabled = isLimeUnlocked;
                unlockSelectorBtn.disabled = isSelectorUnlocked;
            };

            const updateLinkButtonUI = () => {
                const hasLink = linkedReels.has(selectedReel);
                linkButton.disabled = hasLink;
                linkButton.classList.toggle('link-used', hasLink);
            };

            const updateSelectedReelUI = () => {
                inventoryDisplays.forEach((inventory, index) => {
                    inventory.classList.toggle('selected', index === selectedReel);
                });
                updateLinkButtonUI(); 
            };
            
            const updateBonusSymbolUI = () => {
                document.querySelectorAll('.symbol-btn').forEach(btn => {
                    btn.classList.remove('bonus-symbol');
                    if (bonusSymbol && btn.textContent.includes(bonusSymbol)) {
                        btn.classList.add('bonus-symbol');
                    }
                });
            };

            const triggerBonusSymbol = () => {
                const availableButtons = [...document.querySelectorAll('.symbol-btn')]
                    .filter(btn => !SPECIAL_SYMBOLS.includes(btn.textContent[0]) && btn.id !== 'reset-symbols-btn');
                
                if (availableButtons.length > 0) {
                    const randomButton = availableButtons[Math.floor(Math.random() * availableButtons.length)];
                    bonusSymbol = randomButton.textContent.replace(/\+1/g, '').trim();
                    updateBonusSymbolUI();
                }
            };


            const updateSymbolButtonsUI = () => {
                const disabledForThisReel = usedSymbols[selectedReel] || [];
                document.querySelectorAll('.symbol-btn').forEach(btn => {
                    const symbol = btn.textContent.replace(/\+1/g, '').trim();
                    if (symbol === BLANK_SYMBOL || btn.id === 'reset-symbols-btn') {
                        btn.disabled = false;
                        return;
                    }
                    btn.disabled = disabledForThisReel.includes(symbol);
                });
            };
            
            const renderInventories = () => {
                reels.forEach((reel, reelIndex) => {
                    const inventory = inventoryDisplays[reelIndex];
                    inventory.innerHTML = '';

                    for (let i = 0; i < ROWS_PER_REEL; i++) {
                        const rowEl = document.createElement('div');
                        rowEl.className = 'inventory-row';

                        // Add the base 'linked' class if this row is the linked one for its reel
                        if (linkedRowState[reelIndex] === i) {
                            rowEl.classList.add('linked');
                        }

                        const symbol1 = reel[i * 2];
                        const symbol2 = reel[i * 2 + 1];

                        if (symbol1 === ELIMINATED_SLOT && symbol2 === ELIMINATED_SLOT) {
                            rowEl.classList.add('blacked-out');
                            rowEl.innerHTML = `<div class="symbol-display">❌</div><div class="symbol-display">❌</div>`;
                        } 
                        else if ([CANDY_SYMBOL, RING_SYMBOL].includes(symbol1) && symbol2 === ELIMINATED_SLOT) {
                            rowEl.classList.add('merged-row');
                            const symbolEl1 = document.createElement('div');
                            symbolEl1.className = 'symbol-display';
                            symbolEl1.textContent = symbol1;
                            rowEl.appendChild(symbolEl1);
                        }
                        else {
                            const symbolEl1 = document.createElement('div');
                            symbolEl1.className = 'symbol-display';
                            symbolEl1.textContent = symbol1;
                            if (symbol1 === LUCKY_SYMBOL) symbolEl1.classList.add('clover');
                            if (symbol1 === BOMB_SYMBOL) symbolEl1.classList.add('bomb-symbol-glow');
                            
                            const symbolEl2 = document.createElement('div');
                            symbolEl2.className = 'symbol-display';
                            symbolEl2.textContent = symbol2;
                            if (symbol2 === LUCKY_SYMBOL) symbolEl2.classList.add('clover');
                            if (symbol2 === BOMB_SYMBOL) symbolEl2.classList.add('bomb-symbol-glow');

                            rowEl.appendChild(symbolEl1);
                            rowEl.appendChild(symbolEl2);
                        }
                        inventory.appendChild(rowEl);
                    }
                });
                applyClownRotation();
            };

            const handleResetReel = () => {
                if (totalCoins < 50) return;
                totalCoins -= 50;

                reels[selectedReel] = Array(SYMBOLS_PER_REEL).fill(BLANK_SYMBOL);
                delete usedSymbols[selectedReel];
                
                linkedReels.delete(selectedReel);
                delete linkedRowState[selectedReel];

                renderInventories();
                checkAndHighlightLines(); // Check if a line was broken
                updateTopBar();
                updateSymbolButtonsUI();
                updateLinkButtonUI(); 
            };
            
            const handleGambleClick = () => {
                if (!gambleModeActive) {
                    if (totalCoins < 2) return;
                    totalCoins -= 2;
                    updateTopBar();
                }
                gambleModeActive = !gambleModeActive;
                gambleButton.classList.toggle('gamble-active', gambleModeActive);
            };

            const handleSymbolAdd = async (event) => {
                const button = event.target.closest('.symbol-btn');
                if (!button || button.disabled || button.id === 'reset-symbols-btn') return;

                const symbol = button.textContent.replace(/\+1/g, '').trim();
                const reel = reels[selectedReel];
                const blankIndex = reel.indexOf(BLANK_SYMBOL);
                
                if (blankIndex === -1) return;
                
                const isBonus = symbol === bonusSymbol;
                if (isBonus) {
                    totalCoins += 1;
                    bonusSymbol = null;
                    updateBonusSymbolUI();
                } else {
                    if (totalCoins < SYMBOL_ADD_COST) return;
                    totalCoins -= SYMBOL_ADD_COST;
                    symbolsAddedCounter++;
                }

                updateTopBar();

                if (gambleModeActive && symbol !== BLANK_SYMBOL) {
                    button.classList.add('shake-animation');
                    symbolButtonsContainer.querySelectorAll('.btn').forEach(b => b.disabled = true);
                    await new Promise(resolve => setTimeout(resolve, 500)); 
                    button.classList.remove('shake-animation');
                    
                    const gambleWin = Math.random() < 0.5;
                    
                    if (gambleWin) {
                        reel[blankIndex] = LUCKY_SYMBOL;
                    } else {
                        reel[blankIndex] = symbol;
                        if (!usedSymbols[selectedReel]) usedSymbols[selectedReel] = [];
                        usedSymbols[selectedReel].push(symbol);
                    }
                    
                    gambleModeActive = false;
                    gambleButton.classList.remove('gamble-active');
                    symbolButtonsContainer.querySelectorAll('.btn').forEach(b => b.disabled = false);
                    updateSymbolButtonsUI();
                } else {
                    reel[blankIndex] = symbol;
                }
                
                renderInventories();
                updateTopBar();
                updateSymbolButtonsUI();

                if (!isBonus && symbolsAddedCounter >= 4 && bonusSymbol === null) {
                    symbolsAddedCounter = 0;
                    triggerBonusSymbol();
                }
            };
            
            const handleLimeClick = () => {
                if (isAnimating || !isLimeUnlocked) return;
                const LIME_SYMBOL = '🍋‍🟩';
                const limeElements = [];
                document.querySelectorAll('.inventory .symbol-display').forEach(el => {
                    if (el.textContent === LIME_SYMBOL) {
                        limeElements.push(el);
                    }
                });

                if (limeElements.length > 0) {
                    isAnimating = true;
                    priceDisplay.classList.add('lime-shake-animation');
                    limeElements.forEach(el => el.classList.add('lime-shake-animation'));

                    setTimeout(() => {
                        priceDisplay.classList.remove('lime-shake-animation');
                        limeElements.forEach(el => el.classList.remove('lime-shake-animation'));

                        reels.forEach(reel => {
                            for (let i = 0; i < reel.length; i++) {
                                if (reel[i] === LIME_SYMBOL) {
                                    reel[i] = BLANK_SYMBOL;
                                }
                            }
                        });

                        renderInventories();
                        updateTopBar(); 
                        updateSymbolButtonsUI();
                        isAnimating = false;
                    }, 1500);
                }
            };

            const handleLink = () => {
                if (isAnimating || linkedReels.has(selectedReel)) {
                    return;
                }
                if (totalCoins < 5) {
                    showWinMessage("Not enough coins!", 800);
                    return;
                }

                totalCoins -= 5;
                updateTopBar();
                
                isAnimating = true;
                linkButton.disabled = true;
                
                const inventory = inventoryDisplays[selectedReel];
                const rows = inventory.querySelectorAll('.inventory-row');
                
                let currentHighlight = 0;
                let interval = 70;
                let elapsed = 0;
                const totalDuration = 2000;
                const minDuration = 1500;
                
                const finalRow = Math.floor(Math.random() * ROWS_PER_REEL);

                const runAnimation = () => {
                    rows.forEach(row => row.classList.remove('link-highlight'));
                    if (rows[currentHighlight]) {
                       rows[currentHighlight].classList.add('link-highlight');
                    }

                    if (elapsed >= minDuration && currentHighlight === finalRow) {
                        setTimeout(() => {
                            rows.forEach(row => row.classList.remove('link-highlight'));
                            
                            linkedReels.add(selectedReel);
                            linkedRowState[selectedReel] = finalRow;
                            
                            const reel = reels[selectedReel];
                            const symbol1 = reel[finalRow * 2];
                            const symbol2 = reel[finalRow * 2 + 1];

                            if (symbol1 !== symbol2 && !SPECIAL_SYMBOLS.includes(symbol1) && !SPECIAL_SYMBOLS.includes(symbol2)) {
                                if (FRUITS.includes(symbol1) && FRUITS.includes(symbol2)) {
                                    reel[finalRow * 2] = CANDY_SYMBOL;
                                    reel[finalRow * 2 + 1] = ELIMINATED_SLOT;
                                }
                                else if ((symbol1 === '🔔' && symbol2 === '💎') || (symbol1 === '💎' && symbol2 === '🔔')) {
                                    reel[finalRow * 2] = RING_SYMBOL;
                                    reel[finalRow * 2 + 1] = ELIMINATED_SLOT;
                                }
                            }
                            
                            renderInventories(); 
                            checkAndHighlightLines(); // Check for new or potential lines
                            updateTopBar();
                            updateLinkButtonUI(); 
                            isAnimating = false;
                        }, 200);
                    } else {
                        currentHighlight = (currentHighlight + 1) % ROWS_PER_REEL;
                        elapsed += interval;
                        if (elapsed > totalDuration * 0.8) interval = 350;
                        else if (elapsed > totalDuration * 0.5) interval = 180;
                        setTimeout(runAnimation, interval);
                    }
                };
                
                runAnimation();
            };
            
            const handleSpin = async () => {
                if (isAnimating) return;
                if (!riskModeActive && totalCoins < spinPrice) return;

                bombCounters = bombCounters.map(c => Math.max(0, c - 1));
                bombCounters.forEach((counter, index) => {
                    const reelWindow = reelWindowElements[index];
                    const counterEl = reelWindow.querySelector('.bomb-counter');
                    if (counter > 0 && counterEl) {
                        counterEl.textContent = counter;
                    } else if (counter === 0 && counterEl) {
                        reelWindow.classList.remove('bombed');
                        counterEl.remove();
                    }
                });

                if (!riskModeActive) {
                    totalCoins -= spinPrice;
                }
                
                updateTopBar();
                spinButton.disabled = true;
                isAnimating = true;
                reelWindowElements.forEach(rw => rw.classList.remove('win-animation'));

                if (riskModeActive && Math.random() < 0.15) {
                    const validSlots = [];
                    reels.forEach((reel, reelIndex) => {
                        reel.forEach((symbol, symbolIndex) => {
                            if (symbol !== ELIMINATED_SLOT) {
                                validSlots.push({ reelIndex, symbolIndex });
                            }
                        });
                    });

                    if (validSlots.length > 0) {
                        const randomSlot = validSlots[Math.floor(Math.random() * validSlots.length)];
                        reels[randomSlot.reelIndex][randomSlot.symbolIndex] = BOMB_SYMBOL;
                        renderInventories();
                        
                        const bombedInventory = document.getElementById(`inventory-${randomSlot.reelIndex}`);
                        if (bombedInventory) {
                            bombedInventory.classList.add('inventory-shake-animation');
                            setTimeout(() => {
                                bombedInventory.classList.remove('inventory-shake-animation');
                            }, 500);
                        }
                    }
                }

                const results = [];
                for (let i = 0; i < REEL_COUNT; i++) {
                    const finalSymbol = await spinReel(i);
                    results.push(finalSymbol);
                }

                for (let i = 0; i < REEL_COUNT; i++) {
                    if (results[i] === BOMB_SYMBOL) {
                        const reelWindow = reelWindowElements[i];
                        
                        reelWindow.classList.add('shake-animation');
                        await new Promise(resolve => setTimeout(resolve, 500));
                        reelWindow.classList.remove('shake-animation');
                        
                        reelDisplayElements[i].textContent = BOMB_EXPLOSION_SYMBOL;
                        bombCounters[i] = BOMB_DURATION;

                        reelWindow.classList.add('bombed');
                        const counterEl = document.createElement('div');
                        counterEl.className = 'bomb-counter';
                        counterEl.textContent = bombCounters[i];
                        reelWindow.appendChild(counterEl);

                        const reel = reels[i];
                        const bombIndex = reel.indexOf(BOMB_SYMBOL);
                        if (bombIndex !== -1) {
                            reel[bombIndex] = BLANK_SYMBOL;
                        }
                    }
                }
                renderInventories();

                checkForWin(results);
                isAnimating = false;
            };

            const spinReel = (reelIndex) => {
                return new Promise(resolve => {
                    if (bombCounters[reelIndex] > 0) {
                        reelDisplayElements[reelIndex].textContent = BOMB_EXPLOSION_SYMBOL;
                        resolve(BOMB_EXPLOSION_SYMBOL);
                        return;
                    }
                    
                    const reel = reels[reelIndex];
                    const spinnableSymbols = reel.filter(s => s !== ELIMINATED_SLOT);

                    if (spinnableSymbols.length === 0) {
                        reelDisplayElements[reelIndex].textContent = BLANK_SYMBOL;
                        resolve(BLANK_SYMBOL);
                        return;
                    }

                    const display = reelDisplayElements[reelIndex];
                    const windowEl = reelWindowElements[reelIndex];
                    
                    windowEl.classList.add('spinning');
                    const spinAnimDuration = 600;
                    const flickerInterval = 50;

                    const flicker = setInterval(() => {
                        const randomSymbol = spinnableSymbols[Math.floor(Math.random() * spinnableSymbols.length)];
                        display.textContent = randomSymbol;
                    }, flickerInterval);

                    setTimeout(() => {
                        clearInterval(flicker);
                        const finalSymbol = spinnableSymbols[Math.floor(Math.random() * spinnableSymbols.length)];
                        display.textContent = finalSymbol;
                        windowEl.classList.remove('spinning');
                        applyClownRotation();
                        resolve(finalSymbol);
                    }, spinAnimDuration);
                });
            };

            const checkForWin = (results) => {
                if (results.includes(BLANK_SYMBOL) || results.includes(BOMB_EXPLOSION_SYMBOL)) {
                    spinButton.disabled = false;
                    return;
                }

                let baseWinnings = 0;
                results.forEach(symbol => {
                    if (symbol === CANDY_SYMBOL) baseWinnings += 50;
                    else if (symbol === RING_SYMBOL) baseWinnings += 75;
                });

                const payoutTable = {
                    '🍒': { 3: 50, 4: 100 }, '🍊': { 3: 50, 4: 100 },
                    '🍇': { 3: 50, 4: 100 }, '🍋‍🟩': { 3: 50, 4: 100 },
                    '🔔': { 3: 75, 4: 150 }, '💎': { 3: 100, 4: 200 },
                    '🍀': { 3: 250, 4: 500 }
                };

                const rawWildCount = results.filter(s => s === '🤡').length;
                const nonSpecialResults = results.filter(s => s !== CANDY_SYMBOL && s !== RING_SYMBOL && s !== '🤡');
                const symbolCounts = nonSpecialResults.reduce((acc, symbol) => {
                    acc[symbol] = (acc[symbol] || 0) + 1;
                    return acc;
                }, {});

                let isWinPossibleWithClown = false;
                if (rawWildCount > 0) {
                    for (const symbol in symbolCounts) {
                        if (payoutTable[symbol] && (symbolCounts[symbol] + rawWildCount >= 3)) {
                            isWinPossibleWithClown = true;
                            break;
                        }
                    }
                }

                const clownRiskTiers = [
                    { wildChance: 1.00, bonusCoins: 0, bonusMultiplier: 1 },
                    { wildChance: 0.85, bonusCoins: 25, bonusMultiplier: 1 },
                    { wildChance: 0.75, bonusCoins: 50, bonusMultiplier: 1 },
                    { wildChance: 0.65, bonusCoins: 0, bonusMultiplier: 2 },
                    { wildChance: 0.15, bonusCoins: 0, bonusMultiplier: 5 }
                ];
                const currentTier = clownRiskTiers[clownRiskLevel];
                
                let effectiveWildCount = 0;
                let clownFailed = false;

                if (rawWildCount > 0) {
                    if (clownRiskLevel === 0 || Math.random() < currentTier.wildChance) {
                        effectiveWildCount = rawWildCount;
                    } else {
                        clownFailed = true;
                    }
                }

                let matchWinnings = 0;
                let winTypeFound = 0;

                for (const symbol in symbolCounts) {
                    if (payoutTable[symbol] && symbolCounts[symbol] + effectiveWildCount === 4) {
                        matchWinnings += payoutTable[symbol][4];
                        winTypeFound = 4;
                        break;
                    }
                }
                if (!winTypeFound) {
                    for (const symbol in symbolCounts) {
                        if (payoutTable[symbol] && symbolCounts[symbol] + effectiveWildCount === 3) {
                            matchWinnings += payoutTable[symbol][3];
                            winTypeFound = 3;
                            break;
                        }
                    }
                }

                const totalWinnings = baseWinnings + matchWinnings;

                if (totalWinnings > 0) {
                    let finalWinnings = totalWinnings;
                    let clownMessage = '';

                    if (rawWildCount > 0 && !clownFailed && clownRiskLevel > 0 && matchWinnings > 0) {
                        finalWinnings = (totalWinnings * currentTier.bonusMultiplier) + currentTier.bonusCoins;
                        let bonusText = '';
                        if (currentTier.bonusCoins > 0) bonusText = `+${currentTier.bonusCoins} Coins`;
                        else if (currentTier.bonusMultiplier > 1) bonusText = `${currentTier.bonusMultiplier}x Win`;
                        clownMessage = `🤡 Extra ${bonusText}! 🎉<br>`;
                    }
                    
                    const mainMessage = `Win ${finalWinnings}!`;
                    
                    totalCoins += finalWinnings;
                    showWinMessage(clownMessage + mainMessage, 2000);
                    reelWindowElements.forEach(rw => rw.classList.add('win-animation'));
                    
                    setTimeout(() => {
                        reelWindowElements.forEach(rw => rw.classList.remove('win-animation'));
                        updateTopBar();
                        spinButton.disabled = false;
                    }, 2000);

                } else if (clownFailed && isWinPossibleWithClown) {
                    showWinMessage("🤡 Oops.", 1000);
                    spinButton.disabled = false;
                } else {
                    spinButton.disabled = false;
                }
            };

            const handleResetLinks = () => {
                if (totalCoins >= 1) {
                    totalCoins -= 1;
                    linkedReels.clear();
                    Object.keys(linkedRowState).forEach(key => delete linkedRowState[key]);
                    
                    updateTopBar();
                    renderInventories();
                    checkAndHighlightLines(); // Clear all line highlights
                    updateLinkButtonUI();
                    hideModal(tokensModal);
                } else {
                    showWinMessage("Not enough coins!", 800);
                }
            };

            const showModal = (modalElement) => {
                modalElement.style.display = 'flex';
            };
            const hideModal = (modalElement) => {
                modalElement.style.display = 'none';
            };
            
            const applySymbolButtonBorders = () => {
                const symbolColors = {
                    '🍒': '#E01F3D', '🍊': '#F58216', '🍇': '#8A2BE2', 
                    '🍋‍🟩': '#A4DE02', '🔔': '#FFD700', '💎': '#50A6C2', '🤡': '#FF69B4'
                };

                document.querySelectorAll('.symbol-btn').forEach(button => {
                    const symbol = button.textContent.replace(/\+1/g, '').trim();
                    if (symbolColors[symbol]) {
                        button.style.borderColor = symbolColors[symbol];
                    }
                });
            };

            reelInventoriesContainer.addEventListener('click', (event) => {
                if (isAnimating) return;
                const inventory = event.target.closest('.inventory');
                if (inventory) {
                    selectedReel = parseInt(inventory.dataset.reel);
                    updateSelectedReelUI();
                    updateSymbolButtonsUI();
                }
            });

            symbolButtonsContainer.addEventListener('click', handleSymbolAdd);
            resetButton.addEventListener('click', handleResetReel);
            spinButton.addEventListener('click', handleSpin);
            linkButton.addEventListener('click', handleLink);
            gambleButton.addEventListener('click', handleGambleClick);
            priceDisplay.addEventListener('click', handleLimeClick); 
            
            coinsDisplay.addEventListener('click', () => {
                coinsDisplay.classList.toggle('is-flipped');
                riskModeActive = coinsDisplay.classList.contains('is-flipped');
                updateTopBar();
            });
            
            helpButton.addEventListener('click', () => showModal(helpModal));
            tokensButton.addEventListener('click', () => showModal(tokensModal));
            
            closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modalId = button.dataset.modal;
                    const modalToClose = document.getElementById(modalId);
                    if(modalToClose) hideModal(modalToClose);
                });
            });

            selectorDisplay.addEventListener('click', (event) => {
                if (!isSelectorUnlocked) return;
                const choice = event.target.dataset.choice;
                if (choice && choice !== activeSelection) {
                    activeSelection = choice;
                    updateSelectorUI();
                }
            });

            unlockLimeBtn.addEventListener('click', () => {
                if (totalCoins >= 1) {
                    totalCoins -= 1;
                    isLimeUnlocked = true;
                    updateTopBar();
                    updateLockedFeaturesUI();
                    hideModal(tokensModal);
                } else {
                    showWinMessage("Not enough coins!", 800);
                }
            });

            unlockSelectorBtn.addEventListener('click', () => {
                if (totalCoins >= 1) {
                    totalCoins -= 1;
                    isSelectorUnlocked = true;
                    updateTopBar();
                    updateLockedFeaturesUI();
                    hideModal(tokensModal);
                } else {
                    showWinMessage("Not enough coins!", 800);
                }
            });

            resetLinksBtn.addEventListener('click', handleResetLinks);

            clownSlider.addEventListener('input', (event) => {
                const sliderValue = parseInt(event.target.value, 10);
                clownRiskLevel = sliderValue;
                currentClownRotation = sliderValue * 45;
                applyClownRotation();
            });

            window.addEventListener('click', (event) => {
                if (event.target == helpModal) {
                    hideModal(helpModal);
                }
                if (event.target == tokensModal) {
                    hideModal(tokensModal);
                }
            });
            
            // --- Game Initialization ---
            initializeGame();
            applySymbolButtonBorders();
            updateSelectedReelUI();
            renderInventories();
            updateTopBar();
            updateSymbolButtonsUI();
            updateSelectorUI();
            updateLockedFeaturesUI();
        });
    </script>
</body>
</html>
