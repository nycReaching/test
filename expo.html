<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Game Concept</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a more game-like feel */
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation; /* Disables double-tap zoom on mobile */
        }
        .btn-glow:active {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.7);
        }
        .progress-bar-fill {
            transition: width 0.3s ease-in-out;
        }
        .emoji-red-stamp {
            /* This filter chain converts the emoji into a red silhouette and adds a brighter glow */
            filter: grayscale(100%) brightness(80%) sepia(100%) hue-rotate(-50deg) saturate(800%) contrast(1) drop-shadow(0 0 10px rgba(255, 50, 50, 1));
        }
        .emoji-gold-glow {
            filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .pulse-animation {
            animation: pulse 1.5s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <!-- Mobile Screen Container -->
    <div id="game-container" class="w-full max-w-sm h-[80vh] max-h-[700px] bg-gray-800 rounded-3xl shadow-2xl p-4 flex flex-col justify-between relative overflow-hidden">

        <!-- Top Section: Meters and Icons -->
        <div class="flex-shrink-0">
            <div class="flex justify-between items-start gap-2 mb-3">
                <!-- Left Column -->
                <div class="w-2/3 space-y-2 pt-1">
                    <!-- HP/Armor -->
                    <div class="flex items-center h-5 text-xl">
                        <span class="text-red-500">‚ù§Ô∏è</span>
                        <span id="health-value" class="font-bold ml-2 w-6 text-left">10</span>
                        <span class="ml-2">üõ°Ô∏è</span>
                        <span id="armor-value" class="font-bold ml-1 w-6 text-left">3</span>
                    </div>
                    <!-- XP Bar -->
                    <div class="bg-gray-700 rounded-full h-5 w-full border-2 border-gray-600">
                        <div id="xp-bar" class="bg-teal-800 h-full rounded-full progress-bar-fill" style="width: 50%"></div>
                    </div>
                </div>

                <!-- Right Column (2x2 Grid) -->
                <div class="grid grid-cols-2 gap-x-1 gap-y-2 text-base flex-shrink-0">
                    <!-- Kill Count -->
                    <div class="flex items-center justify-end gap-1">
                        <span class="text-lg">‚öîÔ∏è</span>
                        <span id="kill-count-value" class="font-bold w-6 text-left">0</span>
                    </div>
                    <!-- Moonstone -->
                    <div class="flex items-center justify-end gap-1">
                        <span class="text-lg">üåí</span>
                        <span id="moonstone-value" class="font-bold w-6 text-left">3</span>
                    </div>
                    <!-- Level -->
                    <div class="flex items-center justify-end gap-1">
                        <span class="text-lg">üìà</span>
                        <span id="level-value" class="font-bold w-6 text-left">1</span>
                    </div>
                    <!-- Gold -->
                    <div class="flex items-center justify-end gap-1">
                        <span class="text-lg">üí∞</span>
                        <span id="gold-value" class="font-bold w-6 text-left">99</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Section: Game Windows & Grid -->
        <div class="flex-grow flex flex-col my-4 gap-3">
            <!-- Large Window Above -->
            <div id="battle-details-window" class="bg-gray-700/50 rounded-lg flex-grow flex items-center justify-center p-4 transition-all duration-300 text-center">
                <button id="start-battle-btn" class="bg-green-600 active:bg-green-700 text-white font-bold text-lg py-3 px-10 rounded-lg shadow-lg transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">Start Battle</button>
            </div>
            
            <!-- Enemy/Battle Reel -->
            <div id="enemy-container" class="relative flex justify-around items-center bg-gray-900/50 rounded-lg p-2 select-none cursor-grab active:cursor-grabbing overflow-hidden h-24">
                <!-- The draggable slider window -->
                <div id="enemy-slider" class="absolute top-0 left-0 h-full bg-white/20 border-2 border-white rounded-lg pointer-events-none" style="transition: transform 0.2s ease-out;"></div>
                <!-- The yellow selector for battle -->
                <div id="battle-selector" class="hidden absolute top-0 left-0 bg-yellow-400/20 border-2 border-yellow-400 rounded-lg pointer-events-none transition-transform duration-200 ease-in-out"></div>

                <!-- Reroll Animation Overlay -->
                <div id="reroll-overlay" class="hidden absolute inset-0 bg-gray-800 z-20" style="transition: transform 3s ease-in-out;"></div>

                <!-- Icons (z-10 to appear above the slider bg) - These will be populated by JS -->
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
                <span class="text-2xl relative z-10"></span>
            </div>

            <!-- Action Button Bar (Previously at the bottom) -->
            <div class="flex-shrink-0 bg-gray-900/50 rounded-lg p-2">
                <div class="flex justify-around">
                    <button id="reshuffleBtn" class="relative w-16 h-14 bg-gray-700 rounded-lg shadow-lg focus:outline-none transition duration-150 ease-in-out active:bg-gray-600 btn-glow flex items-center justify-center text-4xl">
                        üîÉ
                        <span id="reshuffle-counter" class="absolute bottom-1 right-2 text-sm font-bold text-white"></span>
                    </button>
                    <button id="attackBtn" class="w-16 h-14 bg-red-600 rounded-lg shadow-lg focus:outline-none transition duration-150 ease-in-out active:bg-red-700 btn-glow flex items-center justify-center text-2xl text-white">üó°Ô∏è<span id="attack-value" class="font-bold">13</span></button>
                    <button id="critBtn" class="w-16 h-14 bg-orange-600 rounded-lg shadow-lg focus:outline-none transition duration-150 ease-in-out active:bg-orange-700 btn-glow flex items-center justify-center text-white text-xl font-bold"><span id="crit-chance">10</span>%</button>
                </div>
            </div>

            <!-- Lower area with side window and grid -->
            <div class="flex gap-3">
                <!-- Window to the left -->
                <div id="side-window-left" class="bg-gray-700/50 rounded-lg w-1/2 p-2 flex flex-col items-start justify-start">
                     <!-- Spell descriptions will appear here -->
                </div>

                <!-- 3x3 Grid -->
                <div class="grid grid-cols-3 grid-rows-3 gap-2 w-1/2 aspect-square">
                    <!-- Row 1 (Equipment Slots) -->
                    <button class="equip-slot relative bg-blue-900/50 rounded-lg shadow-md focus:outline-none transition duration-150 ease-in-out active:bg-blue-800/50 btn-glow text-3xl flex items-center justify-center"></button>
                    <button class="equip-slot relative bg-blue-900/50 rounded-lg shadow-md focus:outline-none transition duration-150 ease-in-out active:bg-blue-800/50 btn-glow text-3xl flex items-center justify-center"></button>
                    <button class="equip-slot relative bg-blue-900/50 rounded-lg shadow-md focus:outline-none transition duration-150 ease-in-out active:bg-blue-800/50 btn-glow text-3xl flex items-center justify-center"></button>
                    <!-- Row 2 -->
                    <button id="flameheartBtn" class="bg-teal-800 rounded-lg shadow-md focus:outline-none transition duration-150 ease-in-out active:bg-teal-700 btn-glow text-3xl flex items-center justify-center">‚ù§Ô∏è‚Äçüî•</button>
                    <button id="frostbiteBtn" class="bg-teal-800 rounded-lg shadow-md focus:outline-none transition duration-150 ease-in-out active:bg-teal-700 btn-glow text-3xl flex items-center justify-center">‚ùÑÔ∏è</button>
                    <button id="armorheartBtn" class="bg-teal-800 rounded-lg shadow-md focus:outline-none transition duration-150 ease-in-out active:bg-teal-700 btn-glow text-3xl flex items-center justify-center">ü©∂</button>
                    <!-- Row 3 -->
                    <button id="fortunesBtn" class="bg-purple-500 rounded-lg text-3xl shadow-lg focus:outline-none transition duration-150 ease-in-out active:bg-purple-600 btn-glow flex items-center justify-center">üîÆ</button>
                    <button id="buildBtn" class="bg-gray-500 rounded-lg text-3xl shadow-lg focus:outline-none transition duration-150 ease-in-out active:bg-gray-600 btn-glow flex items-center justify-center">üî®</button>
                    <button id="shopBtn" class="bg-yellow-500 rounded-lg text-3xl shadow-lg focus:outline-none transition duration-150 ease-in-out active:bg-yellow-600 btn-glow flex items-center justify-center">ü™ô</button>
                </div>
            </div>
        </div>

        <!-- MODAL WINDOWS -->
        <!-- Fortunes Modal -->
        <div id="fortunesModal" class="hidden absolute bottom-0 left-0 w-full h-2/3 bg-gray-800 rounded-t-2xl border-t-4 border-purple-500 p-4 flex flex-col justify-center items-center transition-transform duration-300 ease-in-out z-20">
            <div class="w-full max-w-xs text-xl text-white space-y-4">
                <button class="bg-gray-700 rounded-lg px-4 py-3 btn-glow active:bg-gray-600 w-full">ü©∏ Blood Pact</button>
                <button class="bg-gray-700 rounded-lg px-4 py-3 btn-glow active:bg-gray-600 w-full">ü¶∂üèº Broken Ankle</button>
                <button class="bg-gray-700 rounded-lg px-4 py-3 btn-glow active:bg-gray-600 w-full">üé≠ Unstable Mind</button>
            </div>
        </div>

        <!-- Build Modal -->
        <div id="buildModal" class="hidden absolute bottom-0 left-0 w-full h-2/3 bg-gray-800 rounded-t-2xl border-t-4 border-gray-500 p-4 flex flex-col items-center justify-center transition-transform duration-300 ease-in-out z-20">
            <div class="w-full max-w-xs text-xl text-white space-y-4">
                <div class="flex justify-between items-center">
                    <span>WEAPON</span>
                    <button data-slot-type="weapon" class="w-24 h-14 bg-gray-700 rounded-lg btn-glow active:bg-gray-600 flex items-center justify-center text-3xl"></button>
                </div>
                <div class="flex justify-between items-center">
                    <span>ARMOR</span>
                    <button data-slot-type="armor" class="w-24 h-14 bg-gray-700 rounded-lg btn-glow active:bg-gray-600 flex items-center justify-center text-3xl"></button>
                </div>
                <div class="flex justify-between items-center">
                    <span>RING</span>
                    <button data-slot-type="ring" class="w-24 h-14 bg-gray-700 rounded-lg btn-glow active:bg-gray-600 flex items-center justify-center text-3xl"></button>
                </div>
            </div>
        </div>

        <!-- Shop Modal -->
        <div id="shopModal" class="hidden absolute bottom-0 left-0 w-full h-2/3 bg-gray-800 rounded-t-2xl border-t-4 border-yellow-500 p-4 flex flex-col items-center justify-center transition-transform duration-300 ease-in-out z-20">
            <div id="shop-items-container" class="w-full max-w-xs text-xl text-white space-y-2">
                <!-- Shop items will be dynamically generated here -->
            </div>
        </div>

        <!-- Equipment Reel Modal -->
        <div id="reelModal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="relative bg-gray-900/80 backdrop-blur-sm rounded-xl p-3 shadow-xl border border-gray-700">
                <div id="reel-items" class="flex gap-2 text-3xl">
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-100">‚ò†Ô∏è</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-100">üïØÔ∏è</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-100">üêå</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-100">‚ùáÔ∏è</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-100">üåü</button>
                    <button class="reel-item p-1 rounded-lg transition-transform active:scale-100">‚ö°</button>
                </div>
            </div>
        </div>
        
        <!-- Equipment Choice Modal -->
        <div id="equipmentChoiceModal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-40">
            <div class="relative bg-gray-900/80 backdrop-blur-sm rounded-xl p-4 shadow-xl border border-gray-700 w-full max-w-xs">
                <div id="equipmentChoiceContent" class="text-xl text-white space-y-3">
                    <!-- JS will populate this -->
                </div>
            </div>
        </div>


    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const gameContainer = document.getElementById('game-container');
            const goldValueEl = document.getElementById('gold-value');
            const moonstoneValueEl = document.getElementById('moonstone-value');
            const reshuffleCounter = document.getElementById('reshuffle-counter');
            const shopItemsContainer = document.getElementById('shop-items-container');
            const enemyContainer = document.getElementById('enemy-container');
            const enemySlider = document.getElementById('enemy-slider');
            const rerollOverlay = document.getElementById('reroll-overlay');
            const battleSelector = document.getElementById('battle-selector');
            const reshuffleBtn = document.getElementById('reshuffleBtn');
            const reelModal = document.getElementById('reelModal');
            const equipSlots = document.querySelectorAll('.equip-slot');
            const reelItems = document.querySelectorAll('.reel-item');
            const equipmentChoiceModal = document.getElementById('equipmentChoiceModal');
            const equipmentChoiceContent = document.getElementById('equipmentChoiceContent');
            const startBattleBtn = document.getElementById('start-battle-btn');
            const sideWindowLeft = document.getElementById('side-window-left');
            const battleDetailsWindow = document.getElementById('battle-details-window');
            const flameheartBtn = document.getElementById('flameheartBtn');
            const frostbiteBtn = document.getElementById('frostbiteBtn');
            const armorheartBtn = document.getElementById('armorheartBtn');
            
            const modalMap = {
                fortunesBtn: { modal: document.getElementById('fortunesModal'), button: document.getElementById('fortunesBtn') },
                buildBtn: { modal: document.getElementById('buildModal'), button: document.getElementById('buildBtn') },
                shopBtn: { modal: document.getElementById('shopModal'), button: document.getElementById('shopBtn') }
            };
            const allModals = Object.values(modalMap).map(item => item.modal);
            
            // --- Game Data ---
            const shopItems = [
                { id: 'tonic', name: 'üç∂ TONIC', cost: 5 },
                { id: 'gem', name: 'üíé GEM', cost: 25 },
                { id: 'cross', name: '‚úùÔ∏è CROSS', cost: 15 },
                { id: 'fairy', name: 'üßöüèº FAIRY', cost: 40 },
                { id: 'moonstone', name: 'üåí MOONSTONE', cost: 50 },
            ];
             const enemyData = {
                'üê≤': { name: 'Dragon' }, 'üëπ': { name: 'Oni' }, 'üëª': { name: 'Ghost' },
                'üíÄ': { name: 'Skeleton' }, 'üï∑Ô∏è': { name: 'Spider' }, 'üêç': { name: 'Serpent' },
                'üßü': { name: 'Zombie' }, 'üßõ': { name: 'Vampire' }, 'üëΩ': { name: 'Alien' },
                'ü§ñ': { name: 'Robot' }, 'ü¶Ç': { name: 'Scorpion' }, 'üë∫': { name: 'Tengu' },
                'üéÅ': { name: 'Gift' }
            };
            const equipmentOptions = {
                weapon: [{ emoji: 'üèπ', name: 'Bow' }, { emoji: 'üó°Ô∏è', name: 'Dagger' }, { emoji: 'üî®', name: 'Hammer' }],
                armor: [{ emoji: 'üß•', name: 'Leather Gear' }, { emoji: 'ü™®', name: 'Rock Bracer' }, { emoji: 'üï∏Ô∏è', name: 'Cloak' }],
                ring: [{ emoji: 'üíç', name: 'Eccentric Jewel' }]
            };
            const spellDescriptions = {
                flameheart: { title: "‚ù§Ô∏è‚Äçüî• Flameheart:", desc1: "Deal X and heal X.", desc2: "Depletes full magic bar." },
                frostbite: { title: "‚ùÑÔ∏è Frostbite:", desc1: "Deal X and inflict X.", desc2: "Depletes half magic bar." },
                armorheart: { title: "ü©∂ Armorheart:", desc1: "Add current health to armor.", desc2: "Depletes full magic bar." }
            };
            const symbolDescriptions = {
                '‚ò†Ô∏è': { title: "‚ò†Ô∏è Poison", desc: "Inflicts damage over time.", costDesc: "Cost: 1 üåí" },
                'üïØÔ∏è': { title: "üïØÔ∏è Curse", desc: "Weakens enemy attacks.", costDesc: "Cost: 1 üåí" },
                'üêå': { title: "üêå Slow", desc: "Reduces enemy speed.", costDesc: "Cost: 1 üåí" },
                '‚ùáÔ∏è': { title: "‚ùáÔ∏è Regen", desc: "Heals you over time.", costDesc: "Cost: 1 üåí" },
                'üåü': { title: "üåü Blessing", desc: "Increases your damage.", costDesc: "Cost: 1 üåí" },
                '‚ö°': { title: "‚ö° Rush", desc: "Grants extra actions.", costDesc: "Cost: 1 üåí" }
            };

            // --- State ---
            let playerState = {
                gold: 99,
                moonstones: 3,
                rerolls: 5,
                inventory: {
                    tonic: 0,
                    gem: 0,
                    cross: 0,
                    fairy: 0,
                    moonstone: 3, // This should match the moonstones value for consistency
                }
            };
            let battleStarted = false;
            const enemyPool = Object.keys(enemyData).filter(e => e !== 'üéÅ');
            const giftEmoji = 'üéÅ';
            const numIcons = 8;
            const groupSize = 3;
            let isReshuffling = false;
            let activeEquipSlot = null;
            let activeBuildSlot = null;
            let isDragging = false;
            let startX, startY;
            let initialTranslateX;
            let currentTranslateX = 0;
            let dragStartTime;
            let currentBattleTargetIndex = 0;
            let currentEnemiesInBattle = [];

            // --- UI Update Logic ---
            const updatePlayerUI = () => {
                goldValueEl.textContent = playerState.gold;
                moonstoneValueEl.textContent = playerState.moonstones;
                reshuffleCounter.textContent = playerState.rerolls;

                if (playerState.rerolls <= 0) {
                    reshuffleBtn.disabled = true;
                    reshuffleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                     reshuffleBtn.disabled = false;
                    reshuffleBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };

            const updateEnemyDisplay = (enemy) => {
                if (!enemy) return;
                const name = enemyData[enemy.emoji]?.name || 'Unknown';
                battleDetailsWindow.innerHTML = `
                    <div>
                        <div class="text-xl font-bold">${enemy.emoji} ${name}</div>
                        <div class="text-base mt-1">12345</div>
                    </div>
                `;
            };

            const displayInfoInSideWindow = (title, ...descriptions) => {
                if (battleStarted) return; // Descriptions do not display during battle mode.
                 sideWindowLeft.innerHTML = `
                    <div class="text-white text-sm text-left w-full">
                        <p class="font-bold mb-1">${title}</p>
                        ${descriptions.map(d => `<p>${d}</p>`).join('')}
                    </div>
                `;
            }

            const displaySpellInfo = (spellKey) => {
                const spell = spellDescriptions[spellKey];
                if (!spell) return;
                displayInfoInSideWindow(spell.title, spell.desc1, spell.desc2);
            };

            // --- Shop Logic ---
            const renderShop = () => {
                shopItemsContainer.innerHTML = '';
                shopItems.forEach(item => {
                    const itemOwned = playerState.inventory[item.id] || 0;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center';
                    
                    let buttonHtml;
                    if (battleStarted) {
                        buttonHtml = `<button data-item-id="${item.id}" class="bg-green-600 rounded-lg px-4 py-1 btn-glow active:bg-green-700 ${itemOwned > 0 ? '' : 'opacity-50 cursor-not-allowed'}" ${itemOwned === 0 ? 'disabled' : ''}>USE</button>`;
                    } else {
                        const canAfford = playerState.gold >= item.cost;
                        buttonHtml = `<button data-item-id="${item.id}" class="bg-gray-700 rounded-lg px-3 py-1 btn-glow active:bg-gray-600 ${canAfford ? '' : 'opacity-50 cursor-not-allowed'}" ${!canAfford ? 'disabled' : ''}>ü™ô${item.cost}</button>`;
                    }

                    itemDiv.innerHTML = `
                        <span>${item.name} (${itemOwned})</span>
                        ${buttonHtml}
                    `;
                    shopItemsContainer.appendChild(itemDiv);
                });
            };

            const buyItem = (itemId) => {
                const item = shopItems.find(i => i.id === itemId);
                if (!item || playerState.gold < item.cost) {
                    return; // Cannot afford or item not found
                }
                playerState.gold -= item.cost;
                playerState.inventory[item.id]++;
                
                if (item.id === 'moonstone') {
                    playerState.moonstones++;
                }
                
                updatePlayerUI();
                renderShop();
            };
            
            shopItemsContainer.addEventListener('click', (e) => {
                if(battleStarted) return; // For now, only handle purchases.
                const button = e.target.closest('button');
                if (button && button.dataset.itemId) {
                    e.stopPropagation(); // Prevent click from bubbling up to the container
                    buyItem(button.dataset.itemId);
                }
            });

            // --- Modal Logic ---
            const openModal = (modalToOpen) => {
                if (!modalToOpen) return;
                // If opening shop, render it first
                if (modalToOpen.id === 'shopModal') {
                    renderShop();
                }
                allModals.forEach(m => m.classList.add('hidden')); // Close all modals first
                modalToOpen.classList.remove('hidden');
            };
            const closeModal = (modalToClose) => {
                if (modalToClose) modalToClose.classList.add('hidden');
            };

            // --- Equipment Reel Logic ---
            equipSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    if (battleStarted) return; // Actions disabled during battle.

                    const symbol = slot.dataset.symbol;
                    if (symbol) {
                        // If slot is equipped, show description
                        const info = symbolDescriptions[symbol];
                        if (info) {
                            displayInfoInSideWindow(info.title, info.desc, info.costDesc);
                        }
                    } else {
                        // Slot is empty, open reel to equip
                        activeEquipSlot = slot;
                        // Enable/disable reel items based on moonstone count
                        reelItems.forEach(item => {
                            if (playerState.moonstones > 0) {
                                item.disabled = false;
                                item.classList.remove('opacity-50', 'cursor-not-allowed');
                            } else {
                                item.disabled = true;
                                item.classList.add('opacity-50', 'cursor-not-allowed');
                            }
                        });
                        reelModal.classList.remove('hidden');
                    }
                });
            });
            reelItems.forEach(item => {
                item.addEventListener('click', () => {
                    // This will only fire if the button is not disabled (i.e., player has moonstones)
                    if (activeEquipSlot) {
                        playerState.moonstones--;
                        playerState.inventory.moonstone--; // Keep inventory in sync
                        updatePlayerUI();

                        const symbol = item.textContent;
                        activeEquipSlot.innerHTML = ''; // Clear previous content
                        activeEquipSlot.dataset.symbol = symbol;
                        activeEquipSlot.dataset.uses = '3';

                        const emojiSpan = document.createElement('span');
                        emojiSpan.textContent = symbol;
                        activeEquipSlot.appendChild(emojiSpan);

                        const counterSpan = document.createElement('span');
                        counterSpan.className = 'absolute bottom-1 right-2 text-sm font-bold text-white';
                        counterSpan.textContent = '3';
                        activeEquipSlot.appendChild(counterSpan);

                        reelModal.classList.add('hidden');
                        activeEquipSlot = null;
                    }
                });
            });
            reelModal.addEventListener('click', (e) => {
                if (e.target === reelModal) reelModal.classList.add('hidden');
            });

            // --- Build Menu & Equipment Choice Logic ---
            const openEquipmentChoiceModal = (slotType) => {
                equipmentChoiceContent.innerHTML = '';
                const options = equipmentOptions[slotType];
                options.forEach(item => {
                    const itemButton = document.createElement('button');
                    itemButton.className = 'bg-gray-700 rounded-lg px-4 py-3 btn-glow active:bg-gray-600 w-full text-left flex items-center';
                    itemButton.innerHTML = `<span class="text-2xl w-10">${item.emoji}</span> <span>${item.name}</span>`;
                    itemButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activeBuildSlot) activeBuildSlot.innerHTML = item.emoji;
                        equipmentChoiceModal.classList.add('hidden');
                    });
                    equipmentChoiceContent.appendChild(itemButton);
                });
                equipmentChoiceModal.classList.remove('hidden');
            };
            
            document.querySelectorAll('[data-slot-type]').forEach(btn => {
                btn.addEventListener('click', () => {
                    activeBuildSlot = btn;
                    openEquipmentChoiceModal(btn.dataset.slotType);
                });
            });
            equipmentChoiceModal.addEventListener('click', (e) => {
                if (e.target === equipmentChoiceModal) equipmentChoiceModal.classList.add('hidden');
            });


            // --- Enemy Slider Interaction Logic ---
            const calculateSliderDimensions = () => {
                if(battleStarted) return {};
                const containerWidth = enemyContainer.offsetWidth;
                const iconWidth = containerWidth / numIcons;
                const sliderWidth = iconWidth * groupSize;
                enemySlider.style.width = `${sliderWidth}px`;
                return { containerWidth, iconWidth, sliderWidth };
            };
            
            const getEventCoords = (e) => ({
                x: e.touches ? e.touches[0].clientX : e.clientX,
                y: e.touches ? e.touches[0].clientY : e.clientY,
            });

            const dragStart = (e) => {
                if (battleStarted || isReshuffling) return;
                isDragging = true;
                const coords = getEventCoords(e);
                startX = coords.x;
                startY = coords.y;
                dragStartTime = Date.now();
                enemySlider.style.transition = 'none';
                initialTranslateX = currentTranslateX;
                document.addEventListener('mousemove', dragMove);
                document.addEventListener('touchmove', dragMove, { passive: false });
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
            };

            const dragMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const coords = getEventCoords(e);
                const currentX = coords.x;
                const deltaX = currentX - startX;
                currentTranslateX = initialTranslateX + deltaX;
                
                const { containerWidth, sliderWidth } = calculateSliderDimensions();
                const maxTranslateX = containerWidth - sliderWidth;
                currentTranslateX = Math.max(0, Math.min(currentTranslateX, maxTranslateX));

                enemySlider.style.transform = `translateX(${currentTranslateX}px)`;
            };

            const dragEnd = (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                const coords = e.changedTouches ? e.changedTouches[0] : e;
                const endX = coords.clientX;
                const endY = coords.clientY;
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                const deltaTime = Date.now() - dragStartTime;

                document.removeEventListener('mousemove', dragMove);
                document.removeEventListener('touchmove', dragMove);
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchend', dragEnd);
                
                enemySlider.style.transition = 'transform 0.2s ease-out';
                const { iconWidth } = calculateSliderDimensions();

                // Check for Tap
                if (deltaTime < 250 && Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
                    const containerRect = enemyContainer.getBoundingClientRect();
                    const tapX = endX - containerRect.left;
                    const tappedIndex = Math.floor(tapX / iconWidth);
                    const targetIndex = Math.max(0, Math.min(numIcons - groupSize, tappedIndex - 1));
                    currentTranslateX = targetIndex * iconWidth;
                } else { // It's a swipe
                    const closestSnapIndex = Math.round(currentTranslateX / iconWidth);
                    const clampedIndex = Math.min(numIcons - groupSize, Math.max(0, closestSnapIndex));
                    currentTranslateX = clampedIndex * iconWidth;
                }

                enemySlider.style.transform = `translateX(${currentTranslateX}px)`;
            };
            
            // --- Enemy Reshuffle Logic ---
            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            const reshuffleEnemies = (isInitial = false) => {
                if (isReshuffling || (!isInitial && playerState.rerolls <= 0)) return;

                if (!isInitial) {
                    playerState.rerolls--;
                    updatePlayerUI();
                }
                
                isReshuffling = true;
                startBattleBtn.disabled = true; // Disable start battle during animation
                
                enemyContainer.classList.remove('cursor-grab', 'active:cursor-grabbing');
                enemySlider.classList.add('hidden'); // Hide the selector during animation

                // Show the overlay at its starting position (covering everything)
                rerollOverlay.style.transform = 'translateX(0%)';
                rerollOverlay.classList.remove('hidden');

                // Instantly update the enemies behind the overlay
                const shuffledPool = shuffle([...enemyPool]);
                const currentEnemies = shuffledPool.slice(0, 7);
                currentEnemies.push(giftEmoji);
                const finalEnemySet = shuffle(currentEnemies);
                
                const initialSpans = enemyContainer.querySelectorAll('span.relative.z-10');
                initialSpans.forEach((span, index) => {
                    span.textContent = finalEnemySet[index];
                    span.className = 'text-2xl relative z-10';
                });

                const giftSpan = Array.from(initialSpans).find(span => span.textContent === giftEmoji);
                if (giftSpan) giftSpan.classList.add('emoji-gold-glow');

                const stampableSpans = Array.from(initialSpans).filter(span => span.textContent !== giftEmoji);
                if (stampableSpans.length > 0) {
                    const randomEnemyToStamp = stampableSpans[Math.floor(Math.random() * stampableSpans.length)];
                    randomEnemyToStamp.classList.add('emoji-red-stamp');
                }
                currentTranslateX = 0;
                enemySlider.style.transform = `translateX(0px)`;

                // A tiny delay to ensure the browser registers the initial state before starting the transition
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        rerollOverlay.style.transform = 'translateX(100%)'; // Animate it off-screen to the right
                    });
                });

                // After animation, clean up
                setTimeout(() => {
                    rerollOverlay.classList.add('hidden'); // Hide the overlay
                    isReshuffling = false;
                    if (!battleStarted) { // Only re-enable if not in battle
                        enemySlider.classList.remove('hidden'); // Show the selector again
                        updatePlayerUI(); // Updates button state
                        enemyContainer.classList.add('cursor-grab', 'active:cursor-grabbing');
                        startBattleBtn.disabled = false; // Re-enable start battle button
                    }
                }, 3000); // This must match the transition duration
            }

            // --- Initial Setup & Event Listeners ---
            flameheartBtn.addEventListener('click', () => displaySpellInfo('flameheart'));
            frostbiteBtn.addEventListener('click', () => displaySpellInfo('frostbite'));
            armorheartBtn.addEventListener('click', () => displaySpellInfo('armorheart'));

            Object.values(modalMap).forEach(item => {
                item.button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openModal(item.modal);
                });
            });

            gameContainer.addEventListener('click', (e) => {
                const openModalInstance = allModals.find(m => !m.classList.contains('hidden'));
                if (!openModalInstance) return;
                if (equipmentChoiceModal.contains(e.target) && !equipmentChoiceModal.classList.contains('hidden')) return;
                if (openModalInstance.contains(e.target)) return;
                closeModal(openModalInstance);
            });

            const positionBattleSelector = (targetElement) => {
                 if (!targetElement) return;
                 const containerRect = enemyContainer.getBoundingClientRect();
                 const targetRect = targetElement.getBoundingClientRect();
                 const selectorWidth = 68;
                 const selectorHeight = 80;
                 battleSelector.style.width = `${selectorWidth}px`;
                 battleSelector.style.height = `${selectorHeight}px`;
                 const leftOffset = targetRect.left - containerRect.left + (targetRect.width - selectorWidth) / 2;
                 const topOffset = targetRect.top - containerRect.top + (targetRect.height - selectorHeight) / 2;
                 battleSelector.style.transform = `translate(${leftOffset}px, ${topOffset}px)`;
            }
            
            // --- Battle Mode Interaction Handlers ---
            const battleDragStart = (e) => {
                const coords = getEventCoords(e);
                startX = coords.x;
                startY = coords.y;
                dragStartTime = Date.now();
                isDragging = false; 
                document.addEventListener('mousemove', battleDragMove);
                document.addEventListener('touchmove', battleDragMove, { passive: false });
                document.addEventListener('mouseup', battleDragEnd);
                document.addEventListener('touchend', battleDragEnd);
            };

            const battleDragMove = (e) => {
                const coords = getEventCoords(e);
                if (!isDragging && Math.abs(coords.x - startX) > 10) { // Threshold to confirm drag
                    isDragging = true;
                }

                if (!isDragging) return;

                e.preventDefault();

                const enemyWrappers = Array.from(enemyContainer.querySelectorAll('div.relative'));

                let targetIndex = -1;
                for (let i = 0; i < enemyWrappers.length; i++) {
                    const wrapper = enemyWrappers[i];
                    const wrapperRect = wrapper.getBoundingClientRect();
                    if (coords.x >= wrapperRect.left && coords.x <= wrapperRect.right) {
                        targetIndex = i;
                        break;
                    }
                }

                if (targetIndex !== -1 && targetIndex !== currentBattleTargetIndex) {
                    currentBattleTargetIndex = targetIndex;
                    positionBattleSelector(enemyWrappers[currentBattleTargetIndex]);
                    updateEnemyDisplay(currentEnemiesInBattle[currentBattleTargetIndex]);
                }
            };
            
            const battleDragEnd = (e) => {
                document.removeEventListener('mousemove', battleDragMove);
                document.removeEventListener('touchmove', battleDragMove);
                document.removeEventListener('mouseup', battleDragEnd);
                document.removeEventListener('touchend', battleDragEnd);

                setTimeout(() => { isDragging = false; }, 50);
            };

            // --- Start Battle Logic ---
            startBattleBtn.addEventListener('click', () => {
                if (battleStarted || isReshuffling) return;
                const { iconWidth } = calculateSliderDimensions();
                const startIndex = Math.round(currentTranslateX / iconWidth);

                battleStarted = true;
                
                sideWindowLeft.innerHTML = ''; // Clear side window on battle start
                
                enemyContainer.removeEventListener('mousedown', dragStart);
                enemyContainer.removeEventListener('touchstart', dragStart);

                startBattleBtn.remove();
                reshuffleBtn.disabled = true;
                reshuffleBtn.classList.add('opacity-50', 'cursor-not-allowed');
                enemyContainer.classList.remove('cursor-grab', 'active:cursor-grabbing');
                enemyContainer.classList.add('cursor-default');
                enemySlider.classList.add('hidden');

                const allEnemySpans = document.querySelectorAll('#enemy-container > span');
                const selectedEnemySpans = Array.from(allEnemySpans).slice(startIndex, startIndex + groupSize);
                
                currentEnemiesInBattle = selectedEnemySpans.map(span => ({
                    emoji: span.textContent,
                    isStamped: span.classList.contains('emoji-red-stamp'),
                    isGift: span.classList.contains('emoji-gold-glow')
                }));

                enemyContainer.innerHTML = ''; 
                enemyContainer.appendChild(battleSelector);
                enemyContainer.classList.remove('justify-around');
                enemyContainer.classList.add('justify-center', 'gap-4');


                currentEnemiesInBattle.forEach((enemyData, index) => {
                    const enemyWrapper = document.createElement('div');
                    enemyWrapper.className = 'relative cursor-pointer h-[70px] w-[60px] flex flex-col items-center justify-center';
                    const newEnemySpan = document.createElement('span');
                    newEnemySpan.className = 'text-4xl relative z-10';
                    newEnemySpan.textContent = enemyData.emoji;
                    if (enemyData.isStamped) newEnemySpan.classList.add('emoji-red-stamp');
                    if (enemyData.isGift) newEnemySpan.classList.add('emoji-gold-glow');
                    enemyWrapper.appendChild(newEnemySpan);
                    
                    if (!enemyData.isGift) {
                        const healthBarContainer = document.createElement('div');
                        healthBarContainer.className = 'w-12 h-2 bg-black/50 rounded-full mt-2';
                        healthBarContainer.innerHTML = `<div class="h-full bg-red-600 rounded-full" style="width: 100%;"></div>`;
                        enemyWrapper.appendChild(healthBarContainer);
                    }

                    enemyWrapper.addEventListener('click', () => {
                        if (isDragging) return;
                        currentBattleTargetIndex = index;
                        positionBattleSelector(enemyWrapper);
                        updateEnemyDisplay(currentEnemiesInBattle[index]);
                    });
                    enemyContainer.appendChild(enemyWrapper);
                });
                
                const firstNewEnemyWrapper = enemyContainer.querySelector('div.relative');
                battleSelector.classList.remove('hidden');
                
                currentBattleTargetIndex = 0;
                updateEnemyDisplay(currentEnemiesInBattle[0]);
                
                setTimeout(() => positionBattleSelector(firstNewEnemyWrapper), 50);

                enemyContainer.addEventListener('mousedown', battleDragStart);
                enemyContainer.addEventListener('touchstart', battleDragStart);
                
                // When battle starts, if the shop is open, re-render it to show 'USE'
                const shopModal = modalMap.shopBtn.modal;
                if (!shopModal.classList.contains('hidden')) {
                    renderShop();
                }
            });
            
            calculateSliderDimensions();
            window.addEventListener('resize', calculateSliderDimensions);

            enemyContainer.addEventListener('mousedown', dragStart);
            enemyContainer.addEventListener('touchstart', dragStart);

            reshuffleBtn.addEventListener('click', () => {
                if (battleStarted || isReshuffling) return;
                reshuffleEnemies();
            });

            // Initial game setup
            reshuffleEnemies(true); // First reshuffle is free and doesn't cost a reroll
            updatePlayerUI(); // Set initial gold and moonstone display
        });
    </script>

</body>
</html>

