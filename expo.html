<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile Game UI - Polished</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Using a custom font for a better look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Prevent scrolling and bouncing on mobile */
            overscroll-behavior-y: contain;
        }

        /* --- Animation & Effects Styles --- */

        /* Style for winning combinations by category */
        .winner-food div { animation: pulse-green 1s ease-in-out; box-shadow: 0 0 25px 5px #22c55e; border-color: #22c55e !important; }
        @keyframes pulse-green { 0% { box-shadow: 0 0 15px 3px #22c55e; } 50% { box-shadow: 0 0 35px 8px #22c55e; } 100% { box-shadow: 0 0 15px 3px #22c55e; } }

        .winner-weapons div { animation: pulse-red 1s ease-in-out; box-shadow: 0 0 25px 5px #ef4444; border-color: #ef4444 !important; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 15px 3px #ef4444; } 50% { box-shadow: 0 0 35px 8px #ef4444; } 100% { box-shadow: 0 0 15px 3px #ef4444; } }

        .winner-clothing div { animation: pulse-blue 1s ease-in-out; box-shadow: 0 0 25px 5px #3b82f6; border-color: #3b82f6 !important; }
        @keyframes pulse-blue { 0% { box-shadow: 0 0 15px 3px #3b82f6; } 50% { box-shadow: 0 0 35px 8px #3b82f6; } 100% { box-shadow: 0 0 15px 3px #3b82f6; } }

        .winner-items div { animation: pulse-yellow 1s ease-in-out; box-shadow: 0 0 25px 5px #eab308; border-color: #eab308 !important; }
        @keyframes pulse-yellow { 0% { box-shadow: 0 0 15px 3px #eab308; } 50% { box-shadow: 0 0 35px 8px #eab308; } 100% { box-shadow: 0 0 15px 3px #eab308; } }

        .winner-special div { animation: pulse-purple 1s ease-in-out; box-shadow: 0 0 25px 5px #a855f7; border-color: #a855f7 !important; }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 15px 3px #a855f7; } 50% { box-shadow: 0 0 35px 8px #a855f7; } 100% { box-shadow: 0 0 15px 3px #a855f7; } }

        .glow-orange { animation: pulse-orange 1s ease-in-out; box-shadow: 0 0 25px 5px #f97316; border-color: #f97316 !important; }
        @keyframes pulse-orange { 0% { box-shadow: 0 0 15px 3px #f97316; } 50% { box-shadow: 0 0 35px 8px #f97316; } 100% { box-shadow: 0 0 15px 3px #f97316; } }

        .glow-brown { animation: pulse-brown 1s ease-in-out; box-shadow: 0 0 25px 5px #78350f; border-color: #78350f !important; }
        @keyframes pulse-brown { 0% { box-shadow: 0 0 15px 3px #78350f; } 50% { box-shadow: 0 0 35px 8px #78350f; } 100% { box-shadow: 0 0 15px 3px #78350f; } }


        /* New style for the locked item slot */
        .locked-slot {
            border-color: #FBBF24 !important; /* Tailwind yellow-400 */
            box-shadow: 0 0 10px #FBBF24;
        }

        /* Smooth transition for health/armor bars */
        .health-bar, .armor-bar {
            transition: width 0.3s ease-in-out;
        }

        /* Character container for smooth transitions */
        .character-container {
            transition: transform 0.2s ease-in-out, opacity 0.5s ease-in-out;
        }
        
        /* NEW: Slot machine and battle focus animations */
        #slot-machine-container {
            /* This transition makes the zoom in/out smooth */
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .slot-machine-zoomed {
            transform: scale(1.25); /* Zooms in to focus attention */
            z-index: 50; /* Brings it above other elements if needed */
        }
        
        main {
            /* This transition makes the battle area focus effect smooth */
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, filter 0.3s ease-in-out;
        }
        
        .battle-area-focused {
            transform: scale(1.05); /* Slightly enlarges the battle area */
            box-shadow: 0 0 25px 5px #2dd4bf; /* Adds a teal glow for focus */
        }

        /* Battle Animations */
        @keyframes character-lunge {
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .lunge { animation: character-lunge 0.3s ease-out; }

        @keyframes take-damage-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px) rotate(-2deg); }
            75% { transform: translateX(6px) rotate(2deg); }
        }
        .shake { animation: take-damage-shake 0.3s ease-in-out; }

        @keyframes character-death {
            from { opacity: 1; transform: scale(1) rotate(0deg); }
            to { opacity: 0; transform: scale(0.3) rotate(20deg); }
        }
        .dying {
            animation: character-death 0.4s ease-in forwards;
        }

        /* Screen Shake for impact */
        @keyframes screen-shake-anim {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(2px, -2px) rotate(0.5deg); }
            75% { transform: translate(-2px, 2px) rotate(-0.5deg); }
        }
        .screen-shake { animation: screen-shake-anim 0.2s ease-in-out; }

        /* Floating damage numbers */
        .damage-number {
            position: absolute;
            font-size: 1.75rem; /* Larger for more impact */
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 3px red, -1px -1px 3px red;
            pointer-events: none;
            animation: float-up-and-fade 1.2s ease-out forwards;
            z-index: 100;
        }
        @keyframes float-up-and-fade {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-60px); opacity: 0; }
        }
        .meter-text {
             text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* NEW: Low HP warning flash for the main border */
        @keyframes border-flash-red {
            0%, 100% { border-color: #2dd4bf; } /* Tailwind teal-400 */
            50% { border-color: #ef4444; }   /* Tailwind red-500 */
        }
        .low-hp-warning {
            animation: border-flash-red 1s infinite;
        }

        /* NEW: Dimming effect for focus shift */
        .dimmed {
            filter: brightness(0.6);
        }
    </style>
</head>
<body class="bg-black flex items-center justify-center min-h-screen">

    <!-- This container is now the full screen on mobile, and a framed portrait view on desktop -->
    <div id="game-ui" class="w-screen h-screen overflow-hidden relative md:max-w-sm md:h-[800px] md:rounded-2xl md:shadow-2xl border-2 border-teal-400">

        <!-- Main flex container for the game sections -->
        <div class="flex flex-col h-full w-full">

            <!-- 1. Unified Top Section: Status Bar & Meters -->
            <header class="flex-shrink-0 bg-gradient-to-br from-black to-blue-900 px-4 py-3 flex flex-col gap-3 text-white">
                <!-- Resource Counters -->
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-1">
                        <span class="text-2xl">ü™ô</span>
                        <span id="gold-count" class="font-bold text-base sm:text-lg">125</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-2xl">üåø</span>
                        <span class="font-bold text-base sm:text-lg">99</span>
                    </div>
                     <div class="flex items-center gap-1">
                        <span class="text-2xl">üîÆ</span>
                        <span class="font-bold text-base sm:text-lg">42</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-2xl">‚ú®</span>
                        <span class="font-bold text-base sm:text-lg text-yellow-300">03</span>
                    </div>
                </div>
                <!-- Player Meters -->
                <div class="space-y-2">
                    <div class="flex items-center">
                        <span class="text-lg mr-2">‚ù§Ô∏è</span>
                        <div class="w-full bg-black/30 rounded-full h-4 relative flex items-center justify-center">
                             <div id="player-health-bar" class="bg-red-500 h-4 rounded-full health-bar absolute left-0 top-0" style="width: 100%"></div>
                             <span id="player-health-text" class="relative text-xs font-bold text-white z-10 meter-text"></span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-lg mr-2">üíú</span>
                        <div class="w-full bg-black/30 rounded-full h-4 relative flex items-center justify-center">
                            <div class="bg-purple-500 h-4 rounded-full absolute left-0 top-0" style="width: 60%"></div>
                            <span class="relative text-xs font-bold text-white z-10 meter-text">60 / 100</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- 2. Main Game View -->
            <main class="flex-1 flex items-center justify-between p-4 bg-gradient-to-br from-black to-green-900 relative">
                <!-- This container is for floating damage numbers -->
                <div id="damage-container" class="absolute inset-0"></div>
                <!-- Battle Alert Message -->
                <div id="battle-alert" class="absolute inset-x-0 top-1/2 -translate-y-1/2 text-center text-white font-bold text-xl opacity-0 transition-opacity duration-500 z-20" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"></div>

                <!-- Character on the left -->
                <div id="player-character" class="flex flex-col items-center character-container">
                    <span class="text-8xl">üßù</span>
                    <div class="w-24 h-4 bg-black/30 rounded-full mt-4 border-2 border-black/30 overflow-hidden relative flex items-center justify-center">
                        <div id="player-armor-bar" class="bg-blue-500 h-full rounded-full armor-bar absolute left-0 top-0" style="width: 100%;"></div>
                        <span id="player-armor-text" class="relative text-xs font-bold text-white z-10 meter-text"></span>
                    </div>
                    <div id="player-attack-stat" class="mt-2 text-white font-bold text-lg" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.8);"></div>
                </div>
                <!-- Enemies on the right -->
                <div class="flex flex-col gap-8">
                    <div id="enemy-1" class="flex flex-col items-center character-container">
                        <span class="text-6xl enemy-emoji">üê∫</span>
                        <div class="w-16 h-4 bg-black/30 rounded-full mt-2 border-2 border-black/30 overflow-hidden relative flex items-center justify-center">
                           <div id="enemy-1-hp" class="bg-red-500 h-full rounded-full health-bar absolute left-0 top-0" style="width: 100%"></div>
                           <span id="enemy-1-hp-text" class="relative text-xs font-bold text-white z-10 meter-text"></span>
                        </div>
                    </div>
                    <div id="enemy-2" class="flex flex-col items-center character-container">
                        <span class="text-6xl enemy-emoji">üêä</span>
                         <div class="w-16 h-4 bg-black/30 rounded-full mt-2 border-2 border-black/30 overflow-hidden relative flex items-center justify-center">
                           <div id="enemy-2-hp" class="bg-red-500 h-full rounded-full health-bar absolute left-0 top-0" style="width: 100%"></div>
                           <span id="enemy-2-hp-text" class="relative text-xs font-bold text-white z-10 meter-text"></span>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 3. Slot Machine and Upgrades View -->
            <section id="slot-machine-section" class="flex-1 bg-gradient-to-br from-black to-pink-900 p-4 flex flex-col items-center justify-start pt-6 backdrop-blur-sm space-y-4 transition-all duration-300">
                <div class="relative w-full max-w-xs flex justify-center items-center h-16">
                    <div id="spins-remaining-container" class="absolute -left-8 w-16 h-16 text-white opacity-0 transition-opacity duration-300 flex items-center justify-center">
                        <div id="spins-remaining-count" class="font-bold text-4xl leading-none">5</div>
                    </div>
                    <div id="slot-machine-container" class="flex gap-2 sm:gap-3 transition-all duration-300 rounded-lg">
                        <div id="reel1" class="w-16 h-16 bg-black/50 rounded-lg flex items-center justify-center text-4xl border-2 border-transparent"><span class="transition-all duration-200 ease-in-out"></span></div>
                        <div id="reel2" class="w-16 h-16 bg-black/50 rounded-lg flex items-center justify-center text-4xl border-2 border-transparent"><span class="transition-all duration-200 ease-in-out"></span></div>
                        <div id="reel3" class="w-16 h-16 bg-black/50 rounded-lg flex items-center justify-center text-4xl border-2 border-transparent"><span class="transition-all duration-200 ease-in-out"></span></div>
                    </div>
                </div>
                 <!-- Dynamic Content Area below slots -->
                <div id="dynamic-content-area" class="w-full max-w-xs h-32 flex flex-col justify-center">
                    <!-- Upgrade List (visible by default) -->
                    <div id="upgrade-list" class="w-full text-gray-300 text-xs grid grid-cols-2 gap-x-4 gap-y-2">
                        <!-- Upgrades can be populated dynamically -->
                    </div>

                    <!-- Mini Shop (hidden by default) -->
                    <div id="mini-shop-container" class="hidden w-full h-full bg-black/40 p-2 rounded-lg border border-orange-500 text-white text-center flex flex-col justify-around">
                        <h3 class="text-sm font-bold text-orange-300">üè™ Shop üè™</h3>
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div class="bg-black/50 p-2 rounded-md cursor-pointer hover:bg-orange-500/20">‚ù§Ô∏è</div>
                            <div class="bg-black/50 p-2 rounded-md cursor-pointer hover:bg-orange-500/20">üõ°Ô∏è</div>
                            <div class="bg-black/50 p-2 rounded-md cursor-pointer hover:bg-orange-500/20">‚öîÔ∏è</div>
                            <div class="bg-black/50 p-2 rounded-md cursor-pointer hover:bg-orange-500/20">‚ú®</div>
                        </div>
                        <button id="close-mini-shop-button" class="bg-orange-600 px-4 py-1 text-xs rounded-md font-bold transition-transform active:scale-95 w-full mt-2">Close</button>
                    </div>

                    <!-- Mini Urn (hidden by default) -->
                    <div id="mini-urn-container" class="hidden w-full h-full bg-black/40 p-2 rounded-lg border border-amber-700 text-white text-center flex flex-col items-center justify-around">
                        <h3 class="text-sm font-bold text-amber-400">üè∫ Ancient Urn</h3>
                        <p class="text-3xl">?</p>
                        <button id="close-mini-urn-button" class="bg-amber-800 px-4 py-1 text-xs rounded-md font-bold transition-transform active:scale-95 w-full mt-2">Leave It</button>
                    </div>
                </div>
            </section>

            <!-- 4. Navigation -->
            <footer class="flex-shrink-0 h-24 bg-gradient-to-br from-black to-purple-900 p-3 flex justify-around items-center">
                <button id="fairy-button" class="flex-1 text-gray-400 hover:text-white transition-colors flex flex-col items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center transition-transform duration-100 active:scale-90 active:brightness-75">
                        <span class="text-xl">üßö</span>
                    </div>
                </button>
                <button id="spin-button" class="flex-1 text-white flex flex-col items-center cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="w-20 h-20 rounded-full bg-purple-600 flex items-center justify-center transition-all duration-100 ease-in-out active:scale-90 active:brightness-75">
                        <span id="spin-cost-text" class="text-5xl font-bold">5</span>
                    </div>
                </button>
                <button id="star-button" class="flex-1 text-gray-400 hover:text-white transition-colors flex flex-col items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center transition-transform duration-100 active:scale-90 active:brightness-75">
                        <span class="text-xl">‚ú®</span>
                    </div>
                </button>
            </footer>

            <!-- 5. Item Slots -->
            <section class="flex-shrink-0 h-20 bg-gradient-to-br from-black to-blue-900 p-3 grid grid-cols-3 gap-3 items-center">
                <div id="item-slot-container-1" class="h-14 bg-black/40 rounded-lg flex items-center justify-between p-2 shadow-inner border-2 border-black/30 text-white cursor-pointer transition-all opacity-80">
                    <span id="item-slot-1" class="text-4xl"></span>
                    <div class="flex flex-col items-end text-sm">
                        <span class="item-stat-top font-bold text-yellow-300"></span>
                        <span class="item-stat-bottom text-gray-400"></span>
                    </div>
                </div>
                <div id="item-slot-container-2" class="h-14 bg-black/40 rounded-lg flex items-center justify-between p-2 shadow-inner border-2 border-black/30 text-white cursor-pointer transition-all opacity-80">
                    <span id="item-slot-2" class="text-4xl"></span>
                    <div class="flex flex-col items-end text-sm">
                        <span class="item-stat-top font-bold text-yellow-300"></span>
                        <span class="item-stat-bottom text-gray-400"></span>
                    </div>
                </div>
                <div id="item-slot-container-3" class="h-14 bg-black/40 rounded-lg flex items-center justify-between p-2 shadow-inner border-2 border-black/30 text-white cursor-pointer transition-all opacity-80">
                    <span id="item-slot-3" class="text-4xl"></span>
                    <div class="flex flex-col items-end text-sm">
                        <span class="item-stat-top font-bold text-yellow-300"></span>
                        <span class="item-stat-bottom text-gray-400"></span>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const gameUi = document.getElementById('game-ui');
        const spinButton = document.getElementById('spin-button');
        const fairyButton = document.getElementById('fairy-button');
        const starButton = document.getElementById('star-button');
        const spinCostText = document.getElementById('spin-cost-text');
        const reelElements = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
        const itemSlotContainers = [...document.querySelectorAll('[id^="item-slot-container-"]')];
        const slotMachineContainer = document.getElementById('slot-machine-container');
        const goldCountElement = document.getElementById('gold-count');
        const spinsRemainingContainer = document.getElementById('spins-remaining-container');
        const spinsRemainingCount = document.getElementById('spins-remaining-count');
        const battleAlert = document.getElementById('battle-alert');
        const damageContainer = document.getElementById('damage-container');
        const playerHealthText = document.getElementById('player-health-text');
        const playerArmorText = document.getElementById('player-armor-text');
        const playerAttackStat = document.getElementById('player-attack-stat');
        const upgradeList = document.getElementById('upgrade-list');
        const miniShopContainer = document.getElementById('mini-shop-container');
        const miniUrnContainer = document.getElementById('mini-urn-container');
        const closeMiniShopButton = document.getElementById('close-mini-shop-button');
        const closeMiniUrnButton = document.getElementById('close-mini-urn-button');

        // --- Game Assets (Data-driven) ---
        const itemCategories = {
            food: [ { emoji: 'üçé' }, { emoji: 'üçó' }, { emoji: 'üçã' } ],
            weapons: [ { emoji: 'üó°Ô∏è' }, { emoji: 'üèπ' }, { emoji: 'ü™ì' } ],
            clothing: [ { emoji: 'üë¢' }, { emoji: 'üß•' }, { emoji: 'üß§' } ],
            items: [ { emoji: 'üóùÔ∏è' }, { emoji: 'üìú' }, { emoji: 'ü™à' } ],
            special: [ { emoji: 'üè™' }, { emoji: 'üè∫' } ]
        };
        const enemyEmojis = ['üê∫', 'üêä', 'üêâ', 'üëª', 'üêô', 'üï∑Ô∏è', 'ü¶Ç', 'ü¶á', 'üëπ', 'üêç'];
        const allSymbols = Object.values(itemCategories).flat();

        // For colored borders on reels
        const categoryColors = {
            food: 'border-green-500',
            weapons: 'border-red-500',
            clothing: 'border-blue-500',
            items: 'border-yellow-500',
            special: 'border-purple-500'
        };
        const emojiToCategory = {};
        Object.keys(itemCategories).forEach(category => {
            itemCategories[category].forEach(item => {
                emojiToCategory[item.emoji] = category;
            });
        });

        // --- Game State ---
        let playerItems = [null, null, null];
        let isSpinning = false;
        let isPaused = false;
        let lockedSlotIndex = -1;
        let gold = 125;
        const SPIN_COST_SEQUENCE = 5;
        let battleCount = 0;
        let hasShopAppearedThisTurn = false;
        let hasUrnAppearedThisTurn = false;

        // --- Battle State ---
        const BASE_ENEMY_HP = 5;
        const BASE_ENEMY_DAMAGE = 1;
        let player = {
            hp: 10, maxHp: 10,
            armor: 5, maxArmor: 5, baseMaxArmor: 5,
            damage: 3, baseDamage: 3,
            element: document.getElementById('player-character'),
            hpBar: document.getElementById('player-health-bar'),
            armorBar: document.getElementById('player-armor-bar')
        };
        let enemies = [
            { id: 1, hp: 5, maxHp: 5, damage: 1, isAlive: true, element: document.getElementById('enemy-1'), hpBar: document.getElementById('enemy-1-hp'), hpText: document.getElementById('enemy-1-hp-text') },
            { id: 2, hp: 5, maxHp: 5, damage: 1, isAlive: true, element: document.getElementById('enemy-2'), hpBar: document.getElementById('enemy-2-hp'), hpText: document.getElementById('enemy-2-hp-text') }
        ];

        // --- Utility Functions ---
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        // --- Animation & Visual Feedback Functions ---
        function applyAnimation(element, animationClass) {
            element.classList.remove(animationClass);
            void element.offsetWidth;
            element.classList.add(animationClass);
            element.addEventListener('animationend', () => element.classList.remove(animationClass), { once: true });
        }

        function showDamageNumber(targetElement, damageAmount, isArmorHit = false) {
            const damageEl = document.createElement('div');
            damageEl.textContent = damageAmount;
            damageEl.className = 'damage-number';
            if (isArmorHit) {
                damageEl.style.color = '#60a5fa'; // Light blue for armor
                damageEl.style.textShadow = '1px 1px 2px #2563eb';
            }
            const rect = targetElement.getBoundingClientRect();
            const containerRect = damageContainer.getBoundingClientRect();
            damageEl.style.left = `${rect.left - containerRect.left + rect.width / 2 - 15}px`;
            damageEl.style.top = `${rect.top - containerRect.top + rect.height / 2 - 15}px`;
            damageContainer.appendChild(damageEl);
            setTimeout(() => damageEl.remove(), 1200);
        }

        async function showVictoryMessage() {
            battleAlert.textContent = `Wave ${battleCount} Cleared! +10ü™ô`;
            battleAlert.classList.remove('opacity-0');
            await sleep(1500); // Show for 1.5 seconds (was 2000)
            battleAlert.classList.add('opacity-0');
            await sleep(500); // Wait for fade out transition
            battleAlert.textContent = ''; // Clear text
        }

        // --- UI Update Functions ---
        function updateAllUI() {
            // Player stats
            player.hpBar.style.width = `${(player.hp / player.maxHp) * 100}%`;
            playerHealthText.textContent = `${player.hp} / ${player.maxHp}`;
            player.armorBar.style.width = `${(player.armor / player.maxArmor) * 100}%`;
            playerArmorText.textContent = `${player.armor} / ${player.maxArmor}`;
            playerAttackStat.textContent = `‚öîÔ∏è ${player.damage}`;

            // Low HP warning
            if (player.hp <= 3) {
                gameUi.classList.add('low-hp-warning');
            } else {
                gameUi.classList.remove('low-hp-warning');
            }

            // Enemies
            enemies.forEach(enemy => {
                 enemy.hpBar.style.width = `${(enemy.hp / enemy.maxHp) * 100}%`;
                 enemy.hpText.textContent = `${enemy.hp} / ${enemy.maxHp}`;
            });
            // Resources
            goldCountElement.textContent = gold;
            spinCostText.textContent = SPIN_COST_SEQUENCE;
        }

        function updateItemSlotVisuals() {
            playerItems.forEach((itemWithDuration, index) => {
                const container = itemSlotContainers[index];
                const emojiSpan = container.querySelector(`#item-slot-${index + 1}`);
                const topStatSpan = container.querySelector('.item-stat-top');
                const bottomStatSpan = container.querySelector('.item-stat-bottom');

                if (itemWithDuration && itemWithDuration.item) {
                    const item = itemWithDuration.item;
                    emojiSpan.textContent = item.emoji;
                    bottomStatSpan.textContent = itemWithDuration.duration;
                    topStatSpan.textContent = ''; // Clear previous stat

                    if (itemCategories.weapons.some(w => w.emoji === item.emoji)) {
                        topStatSpan.textContent = '‚öîÔ∏è+1';
                    } else if (itemCategories.clothing.some(c => c.emoji === item.emoji)) {
                        topStatSpan.textContent = 'üõ°Ô∏è+1';
                    } else if (itemCategories.food.some(f => f.emoji === item.emoji)) {
                        topStatSpan.textContent = '‚ù§Ô∏è+1';
                    } else if (itemCategories.items.some(i => i.emoji === item.emoji)) {
                        topStatSpan.textContent = '?';
                    }
                } else {
                    emojiSpan.textContent = '';
                    topStatSpan.textContent = '';
                    bottomStatSpan.textContent = '';
                }
            });
        }

        // --- Game Logic Functions ---
        function updatePlayerStatsFromInventory() {
            let attackBonus = 0;
            let armorBonus = 0;
            playerItems.forEach(itemWithDuration => {
                if (!itemWithDuration) return;
                const item = itemWithDuration.item;
                if (itemCategories.weapons.some(w => w.emoji === item.emoji)) {
                    attackBonus += 1;
                } else if (itemCategories.clothing.some(c => c.emoji === item.emoji)) {
                    armorBonus += 1;
                }
            });
            player.damage = player.baseDamage + attackBonus;
            player.maxArmor = player.baseMaxArmor + armorBonus;
        }

        function setupNextBattle() {
            player.armor = player.maxArmor;
            const newHp = BASE_ENEMY_HP + battleCount;
            const newDamage = BASE_ENEMY_DAMAGE + Math.floor(battleCount / 2);
            const shuffledEnemies = [...enemyEmojis].sort(() => 0.5 - Math.random());
            enemies.forEach((enemy, index) => {
                enemy.maxHp = newHp;
                enemy.hp = newHp;
                enemy.damage = newDamage;
                enemy.isAlive = true;
                enemy.element.classList.remove('dying');
                enemy.element.style.opacity = '1';
                enemy.element.style.transform = '';
                enemy.element.querySelector('.enemy-emoji').textContent = shuffledEnemies[index];
            });
            updateAllUI();
        }

        function setLockedSlot(index) {
            if (isSpinning || !playerItems[index]) return;
            if (lockedSlotIndex === index) {
                itemSlotContainers[index].classList.remove('locked-slot');
                lockedSlotIndex = -1;
            } else {
                itemSlotContainers.forEach(container => container.classList.remove('locked-slot'));
                itemSlotContainers[index].classList.add('locked-slot');
                lockedSlotIndex = index;
            }
        }

        function checkWin(reelItemObjects) {
            const reelEmojis = reelItemObjects.map(item => item.emoji);
            let win = false;
            let winCategory = null;

            // Check for 3 of a kind
            if (reelEmojis[0] === reelEmojis[1] && reelEmojis[1] === reelEmojis[2]) {
                win = true;
                winCategory = emojiToCategory[reelEmojis[0]];
            }

            // Check for category match (if not already a 3-of-a-kind win)
            if (!win) {
                 for (const categoryName in itemCategories) {
                    // Don't check special category for this type of win
                    if (categoryName === 'special') continue;

                    const category = itemCategories[categoryName];
                    const categoryEmojis = category.map(item => item.emoji);
                    if (reelEmojis.every(emoji => categoryEmojis.includes(emoji))) {
                        win = true;
                        winCategory = categoryName;
                        for (let i = 0; i < playerItems.length; i++) {
                            if (i !== lockedSlotIndex) {
                                playerItems[i] = { item: reelItemObjects[i], duration: 15 };
                            }
                        }
                        updateItemSlotVisuals();
                        updatePlayerStatsFromInventory();
                        break;
                    }
                }
            }

            // Apply win effect after a delay if a win occurred
            if (win && winCategory) {
                setTimeout(() => {
                    slotMachineContainer.classList.add(`winner-${winCategory}`);
                }, 200); // 200ms delay (was 400)
            }
        }

        // --- Core Game Flow ---
        async function runSingleSpinAnimation() {
            // NEW: Zoom in on the slot machine to focus attention
            slotMachineContainer.classList.add('slot-machine-zoomed');

            const winnerClasses = ['winner-food', 'winner-weapons', 'winner-clothing', 'winner-items', 'winner-special'];
            slotMachineContainer.classList.remove(...winnerClasses);

            // Clear all borders and glows at the start of the spin
            const colorClasses = Object.values(categoryColors);
            reelElements.forEach(reel => {
                reel.classList.remove('glow-orange', 'glow-brown', ...colorClasses, 'border-orange-500', 'border-amber-700');
                reel.classList.add('border-transparent');
            });

            const finalValues = reelElements.map(() => allSymbols[Math.floor(Math.random() * allSymbols.length)]);

            const spinPromises = reelElements.map((reel, i) => {
                return new Promise(async resolve => {
                    const span = reel.querySelector('span');
                    const spinDuration = 200 + i * 150; // Sped up timing (was 300 + i * 300)

                    // 1. Clear previous content and apply blur
                    span.style.filter = 'blur(5px)';
                    span.textContent = '';

                    // 2. Wait for spin duration
                    await sleep(spinDuration);

                    // 3. Reveal final symbol
                    span.style.filter = 'blur(0px)';
                    span.textContent = finalValues[i].emoji;

                    // 4. Set final border color
                    const finalCategory = emojiToCategory[finalValues[i].emoji];
                    reel.classList.remove('border-transparent');
                    if (finalValues[i].emoji === 'üè™') {
                        reel.classList.add('border-orange-500');
                    } else if (finalValues[i].emoji === 'üè∫') {
                        reel.classList.add('border-amber-700');
                    } else if (finalCategory && categoryColors[finalCategory]) {
                        reel.classList.add(categoryColors[finalCategory]);
                    } else {
                        reel.classList.add('border-transparent');
                    }
                    resolve();
                });
            });

            await Promise.all(spinPromises);
            checkWin(finalValues);

            const finalEmojis = finalValues.map(v => v.emoji);
            let openedMiniView = false;
            if (finalEmojis.includes('üè™') && !hasShopAppearedThisTurn) {
                finalValues.forEach((v, i) => v.emoji === 'üè™' && reelElements[i].classList.add('glow-orange'));
                await sleep(300); // was 600
                isPaused = true;
                hasShopAppearedThisTurn = true;
                upgradeList.classList.add('hidden');
                miniShopContainer.classList.remove('hidden');
                openedMiniView = true;
            }
            if (finalEmojis.includes('üè∫') && !hasUrnAppearedThisTurn && !openedMiniView) {
                finalValues.forEach((v, i) => v.emoji === 'üè∫' && reelElements[i].classList.add('glow-brown'));
                await sleep(300); // was 600
                isPaused = true;
                hasUrnAppearedThisTurn = true;
                upgradeList.classList.add('hidden');
                miniUrnContainer.classList.remove('hidden');
            }
        }

        async function performBattleTurn() {
            const livingEnemies = enemies.filter(e => e.isAlive);
            if (livingEnemies.length === 0) return;
            const target = livingEnemies[Math.floor(Math.random() * livingEnemies.length)];

            applyAnimation(player.element, 'lunge');
            await sleep(150);
            applyAnimation(target.element, 'shake');
            showDamageNumber(target.element, player.damage);
            target.hp -= player.damage;

            if (target.hp <= 0) {
                target.hp = 0; target.isAlive = false;
                await sleep(300);
                target.element.classList.add('dying');
            }
            updateAllUI();
            await sleep(300); // was 500

            const anyEnemyAlive = enemies.some(e => e.isAlive);
            if (!target.isAlive || !anyEnemyAlive) return;

            await sleep(200);
            applyAnimation(target.element, 'lunge');
            await sleep(150);

            let damageToPlayer = target.damage;
            const armorDamage = Math.min(player.armor, damageToPlayer);
            if (armorDamage > 0) {
                player.armor -= armorDamage;
                showDamageNumber(player.element, armorDamage, true);
            }
            damageToPlayer -= armorDamage;
            if(damageToPlayer > 0) {
                player.hp -= damageToPlayer;
                showDamageNumber(player.element, damageToPlayer);
            }

            if (player.hp < 0) player.hp = 0;
            applyAnimation(player.element, 'shake');
            applyAnimation(gameUi, 'screen-shake');
            updateAllUI();
        }

        async function startFiveSpins() {
            if (isSpinning) return;
            if (gold < SPIN_COST_SEQUENCE) {
                spinCostText.textContent = "NO!";
                applyAnimation(spinButton.querySelector('div'), 'shake');
                await sleep(500);
                updateAllUI();
                return;
            }

            isSpinning = true;
            spinButton.disabled = true;
            fairyButton.disabled = true;
            starButton.disabled = true;
            hasShopAppearedThisTurn = false;
            hasUrnAppearedThisTurn = false;
            spinsRemainingContainer.classList.remove('opacity-0');

            const mainBattleArea = document.querySelector('main');
            const slotMachineSection = document.getElementById('slot-machine-section');

            for (let i = SPIN_COST_SEQUENCE; i > 0; i--) {
                if (gold <= 0) break;
                gold--;
                updateAllUI();
                spinsRemainingCount.textContent = i;
                
                // --- Focus on Spin ---
                mainBattleArea.classList.add('dimmed');
                slotMachineSection.classList.remove('dimmed');
                await runSingleSpinAnimation(); // This function now handles the zoom-in
                
                await sleep(100); // Short pause to see the result

                // Un-zoom the slot machine to prepare for battle focus
                slotMachineContainer.classList.remove('slot-machine-zoomed');
                await sleep(150); // Allow zoom-out animation to play a bit
                
                // Now check for paused state for shop/urn after zoom-out
                while (isPaused) { await sleep(100); }

                // --- Focus on Battle ---
                mainBattleArea.classList.remove('dimmed');
                slotMachineSection.classList.add('dimmed');

                playerItems.forEach((itemWithDuration, index) => {
                    if (itemWithDuration && index !== lockedSlotIndex) {
                        itemWithDuration.duration--;
                        if (itemWithDuration.duration <= 0) {
                            playerItems[index] = null;
                        }
                    }
                });
                updatePlayerStatsFromInventory();
                updateItemSlotVisuals();
                updateAllUI();
                
                // Focus on the battle area
                mainBattleArea.classList.add('battle-area-focused');
                await performBattleTurn();
                mainBattleArea.classList.remove('battle-area-focused');

                if (enemies.every(e => !e.isAlive)) {
                    gold += 10;
                    battleCount++;

                    let healAmount = 0;
                    playerItems.forEach(itemWithDuration => {
                        if (itemWithDuration && itemCategories.food.some(f => f.emoji === itemWithDuration.item.emoji)) {
                            healAmount += 1;
                        }
                    });
                    if (healAmount > 0) {
                        player.hp = Math.min(player.maxHp, player.hp + healAmount);
                    }

                    await showVictoryMessage();
                    setupNextBattle();
                    updateAllUI();
                }
                await sleep(400); // Time between turns (was 800)
            }

            mainBattleArea.classList.remove('dimmed');
            slotMachineSection.classList.remove('dimmed');
            spinsRemainingContainer.classList.add('opacity-0');
            spinButton.disabled = false;
            fairyButton.disabled = false;
            starButton.disabled = false;
            isSpinning = false;
        }

        // --- Event Listeners & Initialization ---
        function initializeGame() {
            spinButton.addEventListener('click', startFiveSpins);
            fairyButton.addEventListener('click', () => {
                if(isSpinning) return;
                // Placeholder for fairy button functionality
                console.log('Fairy button clicked');
            });
             starButton.addEventListener('click', () => {
                if(isSpinning) return;
                // Placeholder for star button functionality
                console.log('Star button clicked');
            });
            itemSlotContainers.forEach((c, i) => c.addEventListener('click', () => setLockedSlot(i)));

            closeMiniShopButton.addEventListener('click', () => {
                miniShopContainer.classList.add('hidden');
                upgradeList.classList.remove('hidden');
                isPaused = false;
            });

            closeMiniUrnButton.addEventListener('click', () => {
                miniUrnContainer.classList.add('hidden');
                upgradeList.classList.remove('hidden');
                isPaused = false;
            });

            setupNextBattle();
            reelElements.forEach(reel => reel.querySelector('span').textContent = '');
            playerItems = [null, null, null];
            lockedSlotIndex = -1;
            itemSlotContainers.forEach(c => c.classList.remove('locked-slot'));
            updatePlayerStatsFromInventory();
            updateItemSlotVisuals();
            updateAllUI();
        }

        initializeGame();
    </script>
</body>
</html>

